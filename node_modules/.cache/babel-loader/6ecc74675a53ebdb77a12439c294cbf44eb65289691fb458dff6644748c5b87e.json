{"ast":null,"code":"import _objectSpread from\"/Users/naamasharir/Documents/personal/TLV500ModelAssistant/TLV500-Frontend/node_modules/@babel/runtime/helpers/esm/objectSpread2.js\";import React,{useState,useEffect,useRef}from'react';import{Box,Drawer,Typography,Paper,TextField,Button,Avatar,Divider,Chip,Fab,useMediaQuery,useTheme,CircularProgress,Alert,Snackbar,CssBaseline,FormControl,InputLabel,Select,MenuItem,Switch,FormControlLabel}from'@mui/material';import{Send,Person,Description,TableChart,Save}from'@mui/icons-material';import{createTheme,ThemeProvider}from'@mui/material/styles';import ChatHistory from'./components/ChatHistory';import'./App.css';// API URL configuration\nimport{jsx as _jsx,jsxs as _jsxs}from\"react/jsx-runtime\";const API_URL=process.env.REACT_APP_API_URL||'http://localhost:3001';const theme=createTheme({palette:{mode:'dark',primary:{main:'#8B5CF6'},secondary:{main:'#6366F1'},background:{default:'#000000',paper:'#0A0A0A'},text:{primary:'#FFFFFF',secondary:'#E5E7EB'},success:{main:'#10B981'},error:{main:'#EF4444'},warning:{main:'#FFC107'}},typography:{fontFamily:'\"Inter\", \"Roboto\", \"Helvetica\", \"Arial\", sans-serif',h4:{fontWeight:700},h6:{fontWeight:600}},components:{MuiButton:{styleOverrides:{root:{borderRadius:12,textTransform:'none',fontWeight:600,padding:'10px 20px'},contained:{boxShadow:'0 4px 20px rgba(139, 92, 246, 0.4)',background:'linear-gradient(135deg, #8B5CF6 0%, #6366F1 100%)','&:hover':{transform:'translateY(-1px)',boxShadow:'0 6px 30px rgba(139, 92, 246, 0.6)',background:'linear-gradient(135deg, #A78BFA 0%, #818CF8 100%)'}}}},MuiPaper:{styleOverrides:{root:{background:'rgba(20, 20, 20, 0.95)',backdropFilter:'blur(20px)',border:'1px solid rgba(139, 92, 246, 0.3)',borderRadius:16}}}}});const drawerWidth=280;// Function to handle mixed Hebrew-English text\nconst formatMixedText=text=>{if(!text)return text;// Simple regex to detect English words/phrases\nconst englishPattern=/([a-zA-Z0-9]+(?:\\s+[a-zA-Z0-9]+)*)/g;return text.replace(englishPattern,match=>{// If it's a common English term in Hebrew context, wrap it\nreturn\"<span class=\\\"english-term\\\" dir=\\\"ltr\\\">\".concat(match,\"</span>\");});};function App(){const muiTheme=useTheme();const isMobile=useMediaQuery(muiTheme.breakpoints.down('md'));const[messages,setMessages]=useState([{text:'שלום! אני העוזר החכם TLV500. התחבר לחשבון Google ובחר גיליון כדי להתחיל.',sender:'assistant',timestamp:new Date(),id:Date.now()}]);const[question,setQuestion]=useState('');const[fileName,setFileName]=useState('');const[googleSheetsUrl,setGoogleSheetsUrl]=useState('');const[changesCount,setChangesCount]=useState(0);const[isSheetLoaded,setIsSheetLoaded]=useState(false);const[isPickerReady,setIsPickerReady]=useState(false);const[accessToken,setAccessToken]=useState('');const[sheetsMetadata,setSheetsMetadata]=useState('');const[authError,setAuthError]=useState('');const[showSnackbar,setShowSnackbar]=useState(false);const[snackbarMessage,setSnackbarMessage]=useState('');const[availableSheets,setAvailableSheets]=useState([]);const[selectedSheetName,setSelectedSheetName]=useState('');const[isLoadingSheets,setIsLoadingSheets]=useState(false);const[extractedPdf,setExtractedPdf]=useState(null);const[isExtractingData,setIsExtractingData]=useState(false);const[extractedExcel,setExtractedExcel]=useState(null);const[isExtractingExcel,setIsExtractingExcel]=useState(false);const[isAgentMode,setIsAgentMode]=useState(false);const[isStreamingResponse,setIsStreamingResponse]=useState(false);const[isSheetSelected,setIsSheetSelected]=useState(false);const[isIframeHovered,setIsIframeHovered]=useState(false);// 🔄 Undo/Redo State\nconst[canUndo,setCanUndo]=useState(false);const[canRedo,setCanRedo]=useState(false);const[hasGreenCells,setHasGreenCells]=useState(false);const[isCheckingGreenCells,setIsCheckingGreenCells]=useState(false);// Chat History Management\nconst[currentSessionId,setCurrentSessionId]=useState(null);const[user,setUser]=useState(null);const chatEndRef=useRef(null);const iframeContainerRef=useRef(null);// 🔥 State חדש לניתוח הגליון עם Gemini\nconst[sheetAnalysis,setSheetAnalysis]=useState(null);const[sheetInstructions,setSheetInstructions]=useState(null);// 🔥 State חדש לתוכניות שינויים מורכבות\nconst[pendingChangePlan,setPendingChangePlan]=useState(null);const[clarificationAnswers,setClarificationAnswers]=useState(['','','','','']);const[isAnsweringQuestions,setIsAnsweringQuestions]=useState(false);// 🎚️ State חדש לבחירת מצב שינוי משמעותי\nconst[isSignificantChange,setIsSignificantChange]=useState(false);// 🔑 Session ID for backend session storage\nconst[sessionId,setSessionId]=useState(()=>{return Date.now().toString()+'_'+Math.random().toString(36).substring(2,15);});// Helper function to extract questions from change plan response\nconst extractQuestionsFromResponse=response=>{console.log('Extracting questions from response:',response);const questionSection=response.split('🤔 שאלות הבהרה')[1];if(!questionSection){console.log('No question section found');return[];}console.log('Question section found:',questionSection);const questions=[];// Pattern matches \"**1.** question text\"\nconst questionMatches=questionSection.match(/\\*\\*\\d+\\.\\*\\*\\s*([^\\n*]+)/g);if(questionMatches){console.log('Raw question matches:',questionMatches);questionMatches.forEach(match=>{const question=match.replace(/\\*\\*\\d+\\.\\*\\*\\s*/,'').trim();if(question&&question.length>5){questions.push(question);}});}else{console.log('No question matches found, trying alternative pattern');// Alternative: look for lines that start with numbers\nconst lines=questionSection.split('\\n');for(let line of lines){line=line.trim();if(line.match(/^\\*\\*\\d+\\.\\*\\*/)){const question=line.replace(/^\\*\\*\\d+\\.\\*\\*\\s*/,'').trim();if(question&&question.length>5){questions.push(question);}}}}console.log('Frontend extracted questions:',questions);return questions.slice(0,5);// Ensure max 5 questions\n};// Function to execute change plan with clarification answers\nconst executeChangePlan=async()=>{if(!pendingChangePlan||clarificationAnswers.some(answer=>!answer.trim())){setSnackbarMessage('❌ יש לענות על כל 5 השאלות');setShowSnackbar(true);return;}setIsStreamingResponse(true);const loadingMessageId=Date.now();setMessages(prev=>[...prev,{text:'',sender:'assistant',isLoading:true,timestamp:new Date(),id:loadingMessageId}]);try{const sheetData=isSheetLoaded&&isSheetSelected?await getSheetData(extractSpreadsheetId(googleSheetsUrl),selectedSheetName):null;const spreadsheetId=isSheetLoaded?extractSpreadsheetId(googleSheetsUrl):null;const payload={planId:pendingChangePlan.id,clarificationAnswers:clarificationAnswers,spreadsheetId:spreadsheetId,accessToken:accessToken,sheetsMetadata:sheetsMetadata,selectedSheetName:selectedSheetName};const response=await fetch(\"\".concat(API_URL,\"/api/execute-change-plan\"),{method:'POST',headers:{'Content-Type':'application/json'},credentials:'include',body:JSON.stringify(payload)});if(!response.ok){const errorText=await response.text();throw new Error(\"Server error: \".concat(response.status,\" \").concat(errorText));}const reader=response.body.getReader();const decoder=new TextDecoder();let accumulatedResponse='';while(true){const{value,done}=await reader.read();if(done)break;accumulatedResponse+=decoder.decode(value,{stream:true});setMessages(prev=>prev.map(m=>{if(m.id===loadingMessageId){return _objectSpread(_objectSpread({},m),{},{text:accumulatedResponse,isLoading:true});}return m;}));}// Final processing\nsetMessages(prev=>prev.map(m=>m.id===loadingMessageId?_objectSpread(_objectSpread({},m),{},{text:accumulatedResponse,isLoading:false}):m));// Reset change plan state\nsetPendingChangePlan(null);setIsAnsweringQuestions(false);setClarificationAnswers(['','','','','']);// Refresh the sheet if needed\nif(googleSheetsUrl&&selectedSheetName){setTimeout(()=>{const iframe=document.querySelector('iframe[title=\"Google Sheets\"]');if(iframe){iframe.src=iframe.src;}},1000);}}catch(error){console.error('Error executing change plan:',error);setMessages(prev=>prev.map(m=>m.id===loadingMessageId?_objectSpread(_objectSpread({},m),{},{text:\"\\u274C \\u05E9\\u05D2\\u05D9\\u05D0\\u05D4 \\u05D1\\u05D1\\u05D9\\u05E6\\u05D5\\u05E2 \\u05D4\\u05EA\\u05D5\\u05DB\\u05E0\\u05D9\\u05EA: \".concat(error.message),isLoading:false}):m));}finally{setIsStreamingResponse(false);}};useEffect(()=>{// Load saved access token ONLY - no chat messages from localStorage\nconst savedToken=localStorage.getItem('accessToken');if(savedToken){setAccessToken(savedToken);}// Only load PDF/Excel data from localStorage (temporary files, not chat history)\nconst savedPdfJson=localStorage.getItem('extractedPdf');if(savedPdfJson){try{const savedPdf=JSON.parse(savedPdfJson);if(savedPdf&&savedPdf.name&&savedPdf.data){// Check if PDF still exists on server if it has a fileId\nif(savedPdf.fileId){fetch(\"\".concat(API_URL,\"/api/download-pdf/\").concat(savedPdf.fileId),{method:'HEAD',credentials:'include'}).then(response=>{if(response.ok){setExtractedPdf(savedPdf);setMessages(prev=>[...prev,{text:\"\\uD83D\\uDCC4 \\u05E0\\u05EA\\u05D5\\u05E0\\u05D9\\u05DD \\u05E7\\u05D5\\u05D3\\u05DE\\u05D9\\u05DD \\u05E9\\u05D7\\u05D5\\u05DC\\u05E6\\u05D5 \\u05DE-PDF \\\"\".concat(savedPdf.name,\"\\\" \\u05E0\\u05D8\\u05E2\\u05E0\\u05D5.\"),sender:'system',timestamp:new Date(),id:Date.now()}]);}else{// PDF no longer exists on server\nconsole.log('📄 PDF from localStorage no longer exists on server, removing...');localStorage.removeItem('extractedPdf');}}).catch(()=>{// Error checking PDF, remove from localStorage\nlocalStorage.removeItem('extractedPdf');});}else{// Old PDF without fileId, just load it\nsetExtractedPdf(savedPdf);setMessages(prev=>[...prev,{text:\"\\uD83D\\uDCC4 \\u05E0\\u05EA\\u05D5\\u05E0\\u05D9\\u05DD \\u05E7\\u05D5\\u05D3\\u05DE\\u05D9\\u05DD \\u05E9\\u05D7\\u05D5\\u05DC\\u05E6\\u05D5 \\u05DE-PDF \\\"\".concat(savedPdf.name,\"\\\" \\u05E0\\u05D8\\u05E2\\u05E0\\u05D5.\"),sender:'system',timestamp:new Date(),id:Date.now()}]);}}}catch(e){console.error('Failed to parse extracted PDF data from localStorage',e);localStorage.removeItem('extractedPdf');}}const savedExcelJson=localStorage.getItem('extractedExcel');if(savedExcelJson){try{const savedExcel=JSON.parse(savedExcelJson);if(savedExcel&&savedExcel.name&&savedExcel.data){setExtractedExcel(savedExcel);setMessages(prev=>[...prev,{text:\"\\uD83D\\uDCCA \\u05E0\\u05EA\\u05D5\\u05E0\\u05D9\\u05DD \\u05E7\\u05D5\\u05D3\\u05DE\\u05D9\\u05DD \\u05E9\\u05D7\\u05D5\\u05DC\\u05E6\\u05D5 \\u05DE-Excel \\\"\".concat(savedExcel.name,\"\\\" \\u05E0\\u05D8\\u05E2\\u05E0\\u05D5.\"),sender:'system',timestamp:new Date(),id:Date.now()}]);}}catch(e){console.error('Failed to parse extracted Excel data from localStorage',e);localStorage.removeItem('extractedExcel');}}},[]);// Fetch user info when access token is available\nuseEffect(()=>{if(accessToken){fetchUserInfo();}},[accessToken]);useEffect(()=>{const params=new URLSearchParams(window.location.search);const token=params.get('token');if(token){setAccessToken(token);localStorage.setItem('accessToken',token);setSnackbarMessage('התחברת בהצלחה!');setShowSnackbar(true);window.history.replaceState({},document.title,\"/\");}else{// Check if user is already authenticated\ncheckAuthStatus();}},[]);const checkAuthStatus=async()=>{try{const response=await fetch(\"\".concat(API_URL,\"/api/user\"),{credentials:'include'});if(response.ok){const data=await response.json();setUser(data.user);if(data.accessToken){setAccessToken(data.accessToken);localStorage.setItem('accessToken',data.accessToken);}setSnackbarMessage('ברוך הבא בחזרה!');setShowSnackbar(true);}}catch(error){console.log('Not authenticated:',error);// User is not authenticated, show login button\n}};useEffect(()=>{var _chatEndRef$current;(_chatEndRef$current=chatEndRef.current)===null||_chatEndRef$current===void 0?void 0:_chatEndRef$current.scrollIntoView({behavior:\"smooth\"});},[messages]);useEffect(()=>{const script=document.createElement('script');script.src='https://apis.google.com/js/api.js';script.onload=()=>window.gapi.load('picker',{'callback':()=>setIsPickerReady(true)});document.head.appendChild(script);},[]);// ניהול גלילה עבור iframe - הגנה מיוחדת על Mac gestures\nuseEffect(()=>{const handleWheel=e=>{if(isIframeHovered){// הגנה ספציפית על horizontal scrolling במאק\nif(Math.abs(e.deltaX)>Math.abs(e.deltaY)){// זה גלילה אופקית - בלוק את הnavigation gesture\ne.preventDefault();e.stopPropagation();}}};const handleTouchStart=e=>{if(isIframeHovered){e.stopPropagation();}};const handleTouchMove=e=>{if(isIframeHovered){e.stopPropagation();}};// הוסף event listeners עם focus על gestures\ndocument.addEventListener('wheel',handleWheel,{passive:false});document.addEventListener('touchstart',handleTouchStart,{passive:false});document.addEventListener('touchmove',handleTouchMove,{passive:false});return()=>{document.removeEventListener('wheel',handleWheel);document.removeEventListener('touchstart',handleTouchStart);document.removeEventListener('touchmove',handleTouchMove);};},[isIframeHovered]);// בדיקת סטטוס אוטומטית כשגליון נבחר\nuseEffect(()=>{if(isSheetSelected&&selectedSheetName&&currentSessionId){// Auto-check status when sheet is selected\n// בדיקה אוטומטית אחרי טעינת הגליון\nconst timer=setTimeout(()=>{checkUndoRedoStatus();checkForGreenCells();},2000);return()=>clearTimeout(timer);}},[selectedSheetName,isSheetSelected,currentSessionId]);const fetchUserInfo=async()=>{try{const response=await fetch(\"\".concat(API_URL,\"/api/user\"),{credentials:'include'});if(response.ok){const data=await response.json();setUser(data.user);}}catch(error){console.error('Error fetching user info:',error);}};const handleSessionSelect=async sessionId=>{if(!sessionId){setCurrentSessionId(null);setMessages([{text:'שלום! אני העוזר החכם TLV500. התחבר לחשבון Google ובחר גיליון כדי להתחיל.',sender:'assistant',timestamp:new Date(),id:Date.now()}]);return;}setCurrentSessionId(sessionId);try{const response=await fetch(\"\".concat(API_URL,\"/api/chat/session/\").concat(sessionId),{credentials:'include'});if(response.ok){const chatHistory=await response.json();const loadedMessages=chatHistory.messages.map(msg=>({text:msg.content,sender:msg.role==='user'?'user':'assistant',timestamp:new Date(msg.timestamp),id:msg._id||Date.now()+Math.random()}));setMessages(loadedMessages);// Chat history loaded\n}}catch(error){console.error('Error loading chat session:',error);setSnackbarMessage('שגיאה בטעינת השיחה');setShowSnackbar(true);}};const generateSessionId=()=>{return'session_'+Date.now()+'_'+Math.random().toString(36).substr(2,9);};const makeGoogleSheetsAPICall=async function(spreadsheetId,range){let values=arguments.length>2&&arguments[2]!==undefined?arguments[2]:null;let method=arguments.length>3&&arguments[3]!==undefined?arguments[3]:'GET';let valueRenderOption=arguments.length>4&&arguments[4]!==undefined?arguments[4]:'FORMATTED_VALUE';if(!accessToken)throw new Error('No access token available. Please log in.');const baseUrl=\"https://sheets.googleapis.com/v4/spreadsheets/\".concat(spreadsheetId);try{var _data$error;let url,options;if(method==='GET'){// 🔥 הוסף את valueRenderOption לקריאות GET\nconst params=new URLSearchParams({valueRenderOption});url=\"\".concat(baseUrl,\"/values/\").concat(range,\"?\").concat(params);console.log('🔥 Google Sheets API call:',url);options={method,headers:{'Authorization':\"Bearer \".concat(accessToken),'Content-Type':'application/json'}};}else{url=\"\".concat(baseUrl,\"/values/\").concat(range,\"?valueInputOption=RAW\");options={method,headers:{'Authorization':\"Bearer \".concat(accessToken),'Content-Type':'application/json'},body:JSON.stringify({values})};}const response=await fetch(url,options);const data=await response.json();if(!response.ok)throw new Error(((_data$error=data.error)===null||_data$error===void 0?void 0:_data$error.message)||'API call failed');return data;}catch(error){console.error('Google Sheets API error:',error);throw error;}};// 🔥 פונקציה חדשה לשילוב ערכים ונוסחאות\nconst combineValuesAndFormulas=(values,formulas)=>{const combined=[];console.log('🔥 Starting combineValuesAndFormulas...');console.log('📊 Values:',(values===null||values===void 0?void 0:values.length)||0,'rows');console.log('📋 Formulas:',(formulas===null||formulas===void 0?void 0:formulas.length)||0,'rows');for(let row=0;row<Math.max(values.length,formulas.length);row++){const valueRow=values[row]||[];const formulaRow=formulas[row]||[];const combinedRow=[];for(let col=0;col<Math.max(valueRow.length,formulaRow.length);col++){const value=valueRow[col]||'';const formula=formulaRow[col]||'';// 🔥 לוג לבדיקה (רק לשורה ראשונה)\nif(row===0&&col<3){console.log(\"Cell [\".concat(row,\",\").concat(col,\"]: value=\\\"\").concat(value,\"\\\" (\").concat(typeof value,\"), formula=\\\"\").concat(formula,\"\\\" (\").concat(typeof formula,\")\"));}// 🔥 תיקון: בדוק שזה string ומתחיל ב-= לפני שמגדירים כנוסחה\nif(typeof formula==='string'&&formula.length>0&&formula.startsWith('=')){// זו נוסחה אמיתית\ncombinedRow.push({value:value,formula:formula,type:'formula'});}else{// זה ערך רגיל (לא נוסחה) - קח את הערך או את מה שיש בformula אם הערך ריק\nconst finalValue=value!==''?value:formula!==''?formula:'';combinedRow.push({value:finalValue,type:'literal'});}}combined.push(combinedRow);}console.log('🔥 Combined values and formulas:',combined.slice(0,2));// רק 2 שורות ראשונות\nreturn combined;};// 🔥 פונקציה חדשה לניתוח הגליון עם Gemini\nconst analyzeSheetWithGemini=async function(sheetData,sheetName){let currentExtractedPdf=arguments.length>2&&arguments[2]!==undefined?arguments[2]:null;try{var _result$summary,_result$instructions;setMessages(prev=>[...prev,{text:\"\\uD83D\\uDD0D \\u05DE\\u05E0\\u05EA\\u05D7 \\u05D0\\u05EA \\u05DE\\u05D1\\u05E0\\u05D4 \\u05D4\\u05D2\\u05DC\\u05D9\\u05D5\\u05DF \\\"\".concat(sheetName,\"\\\" \\u05E2\\u05DD AI...\"),sender:'system',timestamp:new Date(),id:Date.now()}]);const payload={sheetData:sheetData,sheetName:sheetName,sessionId:sessionId,analysisType:'initial_analysis'};const response=await fetch(\"\".concat(API_URL,\"/api/analyze-sheet\"),{method:'POST',headers:{'Content-Type':'application/json'},credentials:'include',body:JSON.stringify(payload)});if(!response.ok){throw new Error(\"HTTP error! status: \".concat(response.status));}const result=await response.json();// שמור את התוצאות\nsetSheetAnalysis(result.summary);setSheetInstructions(result.instructions);// שמור את ההוראות שחזרו מהבקאנד\n// הצג את הסיכום למשתמש\nsetMessages(prev=>[...prev,{text:\"\\uD83D\\uDCCA \\u05E0\\u05D9\\u05EA\\u05D5\\u05D7 \\u05D4\\u05D2\\u05DC\\u05D9\\u05D5\\u05DF:\\n\".concat(result.summary),sender:'assistant',timestamp:new Date(),id:Date.now()}]);console.log('🔥 Sheet analysis completed:',result);console.log('📝 Sheet summary saved:',(_result$summary=result.summary)===null||_result$summary===void 0?void 0:_result$summary.length,'characters');console.log('📋 Sheet instructions saved:',(_result$instructions=result.instructions)===null||_result$instructions===void 0?void 0:_result$instructions.length,'characters');// הודעה קצרה שההוראות נשמרו\nsetTimeout(()=>{setMessages(prev=>[...prev,{text:\"\\u2705 \\u05D4\\u05D5\\u05E8\\u05D0\\u05D5\\u05EA \\u05E2\\u05D1\\u05D5\\u05D3\\u05D4 \\u05DE\\u05E4\\u05D5\\u05E8\\u05D8\\u05D5\\u05EA \\u05E0\\u05E9\\u05DE\\u05E8\\u05D5 \\u05DC\\u05DE\\u05E2\\u05E8\\u05DB\\u05EA \\u05E2\\u05D1\\u05D5\\u05E8 \\u05E9\\u05D9\\u05D7\\u05D5\\u05EA \\u05E2\\u05EA\\u05D9\\u05D3\\u05D9\\u05D5\\u05EA\",sender:'system',timestamp:new Date(),id:Date.now()}]);},1000);// Return the analysis results for use in handleSheetChange\nreturn{instructions:result.instructions,summary:result.summary};}catch(error){console.error('Error analyzing sheet:',error);setMessages(prev=>[...prev,{text:\"\\u274C \\u05E9\\u05D2\\u05D9\\u05D0\\u05D4 \\u05D1\\u05E0\\u05D9\\u05EA\\u05D5\\u05D7 \\u05D4\\u05D2\\u05DC\\u05D9\\u05D5\\u05DF: \".concat(error.message),sender:'system',timestamp:new Date(),id:Date.now()}]);}};const extractSpreadsheetId=url=>{const match=url.match(/\\/spreadsheets\\/d\\/([a-zA-Z0-9-_]+)/);return match?match[1]:null;};// פונקציה ליצור URL עם הגליון הנכון\nconst getSheetUrlWithGid=(baseUrl,sheetName)=>{if(!sheetName||!sheetsMetadata)return baseUrl;const selectedSheet=sheetsMetadata.find(sheet=>sheet.name===sheetName);if(!selectedSheet)return baseUrl;// הסר כל gid קיים מה-URL\nconst cleanUrl=baseUrl.split('#')[0];// הוסף את ה-gid החדש\nreturn\"\".concat(cleanUrl,\"#gid=\").concat(selectedSheet.id);};const getSpreadsheetMetadata=async spreadsheetId=>{if(!accessToken)return[];try{const url=\"https://sheets.googleapis.com/v4/spreadsheets/\".concat(spreadsheetId);const response=await fetch(url,{headers:{'Authorization':\"Bearer \".concat(accessToken)}});if(!response.ok)throw new Error('Failed to fetch spreadsheet metadata');const metadata=await response.json();return metadata.sheets.map(sheet=>({name:sheet.properties.title,id:sheet.properties.sheetId}));}catch(error){console.error('Error fetching spreadsheet metadata:',error);return[];}};const handleFileUpload=async(event,fileType)=>{const file=event.target.files[0];if(!file)return;if(file.type==='application/pdf'){// Clean all previous PDF-related state\nsetExtractedPdf(null);localStorage.removeItem('extractedPdf');setIsExtractingData(true);// Remove any previous PDF-related messages\nsetMessages(prev=>prev.filter(msg=>!msg.text.includes('נתונים חולצו')&&!msg.text.includes('שגיאה בחילוץ')&&!msg.text.includes('נתוני ה-PDF נוקו')));setMessages(prev=>[...prev,{text:\"\\u23F3 \\u05DE\\u05D7\\u05DC\\u05E5 \\u05E0\\u05EA\\u05D5\\u05E0\\u05D9\\u05DD \\u05DE\\u05E7\\u05D5\\u05D1\\u05E5 \\\"\".concat(file.name,\"\\\"...\"),sender:'system',timestamp:new Date(),id:Date.now()}]);const formData=new FormData();formData.append('pdf',file);// 🔥 אם יש גליון טעון, שלוף את הנתונים ושלח אותם\nif(isSheetLoaded&&isSheetSelected){const currentSheetData=await getSheetData(extractSpreadsheetId(googleSheetsUrl),selectedSheetName);if(currentSheetData){formData.append('sheetData',JSON.stringify(currentSheetData));}if(sheetInstructions){formData.append('sheetInstructions',sheetInstructions);}if(sheetAnalysis){formData.append('sheetAnalysis',sheetAnalysis);}if(selectedSheetName){formData.append('sheetName',selectedSheetName);}console.log('🔥 Sending PDF with full sheet context:',{hasSheetData:!!currentSheetData,sheetDataLength:currentSheetData?currentSheetData.length:0,hasInstructions:!!sheetInstructions,instructionsLength:sheetInstructions?sheetInstructions.length:0,hasAnalysis:!!sheetAnalysis,analysisLength:sheetAnalysis?sheetAnalysis.length:0,sheetName:selectedSheetName});}else{console.log('🔥 Sending PDF without sheet context (simple OCR mode)');}fetch(\"\".concat(API_URL,\"/api/extract-pdf-data\"),{method:'POST',body:formData,credentials:'include'}).then(response=>{if(!response.ok){return response.json().then(err=>{throw new Error(err.error||'Failed to extract data');});}return response.json();}).then(result=>{const pdfInfo={name:file.name,data:result,fileId:result.fileId,// שמירת fileId לפתיחה עתידית\nprocessingMode:result.processingMode||'structured',// track processing mode\nisFullText:result.isFullText||false// track if this is full text\n};setExtractedPdf(pdfInfo);localStorage.setItem('extractedPdf',JSON.stringify(pdfInfo));setMessages(prev=>prev.filter(msg=>!msg.text.includes('⏳ מחלץ נתונים')));// Different success messages based on processing mode\nlet successMessage;if(result.processingMode==='simple_ocr'){successMessage=\"\\u2705 \\u05D8\\u05E7\\u05E1\\u05D8 \\u05D7\\u05D5\\u05DC\\u05E5 \\u05DE-\\\"\".concat(file.name,\"\\\". \\u05E0\\u05D9\\u05EA\\u05DF \\u05DC\\u05E9\\u05D0\\u05D5\\u05DC \\u05E9\\u05D0\\u05DC\\u05D5\\u05EA \\u05E2\\u05DC \\u05D4\\u05EA\\u05D5\\u05DB\\u05DF. \\u05D8\\u05E2\\u05DF \\u05D2\\u05D9\\u05DC\\u05D9\\u05D5\\u05DF \\u05DC\\u05E0\\u05D9\\u05EA\\u05D5\\u05D7 \\u05DE\\u05E4\\u05D5\\u05E8\\u05D8.\");}else{successMessage=result.fileId?\"\\u2705 \\u05E0\\u05EA\\u05D5\\u05E0\\u05D9\\u05DD \\u05D7\\u05D5\\u05DC\\u05E6\\u05D5 \\u05D1\\u05D4\\u05E6\\u05DC\\u05D7\\u05D4 \\u05DE-\\\"\".concat(file.name,\"\\\". \\u05DB\\u05E2\\u05EA \\u05E0\\u05D9\\u05EA\\u05DF \\u05DC\\u05E9\\u05D0\\u05D5\\u05DC \\u05E9\\u05D0\\u05DC\\u05D5\\u05EA \\u05E2\\u05DC \\u05D4\\u05E7\\u05D5\\u05D1\\u05E5 \\u05D0\\u05D5 \\u05DC\\u05D7\\u05D6\\u05D5\\u05E8 \\u05DC\\u05E7\\u05D5\\u05D1\\u05E5 \\u05D4\\u05DE\\u05E7\\u05D5\\u05E8\\u05D9.\"):\"\\u2705 \\u05E0\\u05EA\\u05D5\\u05E0\\u05D9\\u05DD \\u05D7\\u05D5\\u05DC\\u05E6\\u05D5 \\u05D1\\u05D4\\u05E6\\u05DC\\u05D7\\u05D4 \\u05DE-\\\"\".concat(file.name,\"\\\". \\u05DB\\u05E2\\u05EA \\u05E0\\u05D9\\u05EA\\u05DF \\u05DC\\u05E9\\u05D0\\u05D5\\u05DC \\u05E9\\u05D0\\u05DC\\u05D5\\u05EA \\u05E2\\u05DC \\u05D4\\u05E7\\u05D5\\u05D1\\u05E5.\");}setMessages(prev=>[...prev,{text:successMessage,sender:'system',timestamp:new Date(),id:Date.now()}]);}).catch(error=>{console.error('PDF data extraction failed:',error);setMessages(prev=>prev.filter(msg=>!msg.text.includes('⏳ מחלץ נתונים')));setMessages(prev=>[...prev,{text:\"\\u274C \\u05E9\\u05D2\\u05D9\\u05D0\\u05D4 \\u05D1\\u05D7\\u05D9\\u05DC\\u05D5\\u05E5 \\u05E0\\u05EA\\u05D5\\u05E0\\u05D9\\u05DD \\u05DE-\\\"\".concat(file.name,\"\\\": \").concat(error.message),sender:'system',timestamp:new Date(),id:Date.now()}]);}).finally(()=>{setIsExtractingData(false);});}else if(fileType==='Excel'){// Ask user if they want to convert to Google Sheets\nconst shouldConvert=window.confirm(\"\\u05D4\\u05D0\\u05DD \\u05D1\\u05E8\\u05E6\\u05D5\\u05E0\\u05DA \\u05DC\\u05D4\\u05DE\\u05D9\\u05E8 \\u05D0\\u05EA \\u05E7\\u05D5\\u05D1\\u05E5 \\u05D4-Excel \\\"\".concat(file.name,\"\\\" \\u05DC-Google Sheets?\\n\\n\")+\"\\u05DB\\u05DF - \\u05D4\\u05E2\\u05DC\\u05D0\\u05D4 \\u05DC-Google Drive \\u05D5\\u05D4\\u05DE\\u05E8\\u05D4 \\u05DC-Google Sheets\\n\"+\"\\u05DC\\u05D0 - \\u05D7\\u05D9\\u05DC\\u05D5\\u05E5 \\u05E0\\u05EA\\u05D5\\u05E0\\u05D9\\u05DD \\u05DE\\u05E7\\u05D5\\u05DE\\u05D9 \\u05D1\\u05DC\\u05D1\\u05D3\");if(shouldConvert){// Convert to Google Sheets\nsetIsExtractingExcel(true);setMessages(prev=>prev.filter(msg=>!msg.text.includes('ממיר')&&!msg.text.includes('Google Sheets')&&!msg.text.includes('שגיאה בהמרה')));setMessages(prev=>[...prev,{text:\"\\uD83D\\uDD04 \\u05DE\\u05DE\\u05D9\\u05E8 \\u05D0\\u05EA \\\"\".concat(file.name,\"\\\" \\u05DC-Google Sheets...\"),sender:'system',timestamp:new Date(),id:Date.now()}]);const formData=new FormData();formData.append('excel',file);fetch(\"\".concat(API_URL,\"/api/excel-to-sheets\"),{method:'POST',body:formData,credentials:'include'}).then(response=>{if(!response.ok){return response.json().then(err=>{throw new Error(err.error||'Failed to convert Excel to Google Sheets');});}return response.json();}).then(result=>{setMessages(prev=>prev.filter(msg=>!msg.text.includes('🔄 ממיר')));setMessages(prev=>[...prev,{text:\"\\u2705 \\u05D4\\u05E7\\u05D5\\u05D1\\u05E5 \\\"\".concat(file.name,\"\\\" \\u05D4\\u05D5\\u05DE\\u05E8 \\u05D1\\u05D4\\u05E6\\u05DC\\u05D7\\u05D4 \\u05DC-Google Sheets \\u05D5\\u05E0\\u05E9\\u05DE\\u05E8 \\u05D1\\u05EA\\u05D9\\u05E7\\u05D9\\u05D9\\u05EA \\\"TLV500-AI\\\"!\"),sender:'system',timestamp:new Date(),id:Date.now()}]);// Open the created Google Sheet in a new tab\nconst sheetUrl=result.spreadsheetUrl||result.url;if(sheetUrl){window.open(sheetUrl,'_blank');setMessages(prev=>[...prev,{text:\"\\uD83D\\uDCCA Google Sheets \\u05E0\\u05E4\\u05EA\\u05D7 \\u05D1\\u05DB\\u05E8\\u05D8\\u05D9\\u05E1\\u05D9\\u05D9\\u05D4 \\u05D7\\u05D3\\u05E9\\u05D4\",sender:'system',timestamp:new Date(),id:Date.now()}]);// Optionally, also load it in the current interface\nhandleGoogleSheetsUrl(sheetUrl);}}).catch(error=>{console.error('Excel to Google Sheets conversion failed:',error);setMessages(prev=>prev.filter(msg=>!msg.text.includes('🔄 ממיר')));setMessages(prev=>[...prev,{text:\"\\u274C \\u05E9\\u05D2\\u05D9\\u05D0\\u05D4 \\u05D1\\u05D4\\u05DE\\u05E8\\u05D4 \\u05DC-Google Sheets: \".concat(error.message),sender:'system',timestamp:new Date(),id:Date.now()}]);}).finally(()=>{setIsExtractingExcel(false);});}else{// Original local extraction logic\nsetExtractedExcel(null);localStorage.removeItem('extractedExcel');setIsExtractingExcel(true);setMessages(prev=>prev.filter(msg=>!msg.text.includes('חולצו מ-Excel')&&!msg.text.includes('שגיאה בחילוץ Excel')&&!msg.text.includes('נתוני ה-Excel נוקו')));setMessages(prev=>[...prev,{text:\"\\u23F3 \\u05DE\\u05D7\\u05DC\\u05E5 \\u05E0\\u05EA\\u05D5\\u05E0\\u05D9\\u05DD \\u05DE\\u05E7\\u05D5\\u05D1\\u05E5 Excel \\\"\".concat(file.name,\"\\\"...\"),sender:'system',timestamp:new Date(),id:Date.now()}]);const formData=new FormData();formData.append('excel',file);fetch(\"\".concat(API_URL,\"/api/extract-excel-data\"),{method:'POST',body:formData}).then(response=>{if(!response.ok){return response.json().then(err=>{throw new Error(err.error||'Failed to extract Excel data');});}return response.json();}).then(result=>{const excelInfo={name:file.name,data:result.data};setExtractedExcel(excelInfo);localStorage.setItem('extractedExcel',JSON.stringify(excelInfo));setMessages(prev=>prev.filter(msg=>!msg.text.includes('⏳ מחלץ נתונים מקובץ Excel')));setMessages(prev=>[...prev,{text:\"\\u2705 \\u05E0\\u05EA\\u05D5\\u05E0\\u05D9\\u05DD \\u05D7\\u05D5\\u05DC\\u05E6\\u05D5 \\u05D1\\u05D4\\u05E6\\u05DC\\u05D7\\u05D4 \\u05DE-Excel \\\"\".concat(file.name,\"\\\".\"),sender:'system',timestamp:new Date(),id:Date.now()}]);}).catch(error=>{console.error('Excel data extraction failed:',error);setMessages(prev=>prev.filter(msg=>!msg.text.includes('⏳ מחלץ נתונים מקובץ Excel')));setMessages(prev=>[...prev,{text:\"\\u274C \\u05E9\\u05D2\\u05D9\\u05D0\\u05D4 \\u05D1\\u05D7\\u05D9\\u05DC\\u05D5\\u05E5 \\u05E0\\u05EA\\u05D5\\u05E0\\u05D9 Excel: \".concat(error.message),sender:'system',timestamp:new Date(),id:Date.now()}]);}).finally(()=>{setIsExtractingExcel(false);});}}};const loadAvailableSheets=async spreadsheetId=>{setIsLoadingSheets(true);setIsSheetSelected(false);// Reset selection\nsetSelectedSheetName('');// Clear any previous selection\ntry{const sheets=await getSpreadsheetMetadata(spreadsheetId);setAvailableSheets(sheets);setSheetsMetadata(sheets);// רק הודעה שהגליונות נטענו - בלי לבחור גליון אוטומטית\nif(sheets.length>0){setMessages(prev=>[...prev,{text:\"\\uD83D\\uDCCB \\u05E0\\u05DE\\u05E6\\u05D0\\u05D5 \".concat(sheets.length,\" \\u05D2\\u05DC\\u05D9\\u05D5\\u05E0\\u05D5\\u05EA - \\u05D1\\u05D7\\u05E8 \\u05D2\\u05DC\\u05D9\\u05D5\\u05DF \\u05DB\\u05D3\\u05D9 \\u05DC\\u05D4\\u05EA\\u05D7\\u05D9\\u05DC\"),sender:'system',timestamp:new Date(),id:Date.now()}]);}}finally{setIsLoadingSheets(false);}};const handleGoogleSheetsUrl=async url=>{setGoogleSheetsUrl(url);setIsSheetLoaded(true);setIsSheetSelected(false);// Reset sheet selection for new spreadsheet\nsetIsAgentMode(false);// Reset agent mode for new spreadsheet\nconst spreadsheetId=extractSpreadsheetId(url);if(spreadsheetId&&accessToken)await loadAvailableSheets(spreadsheetId);};const handleSheetChange=async newSheetName=>{if(newSheetName===selectedSheetName)return;setSelectedSheetName(newSheetName);setIsSheetSelected(true);// מסמן שנבחר גליון\nconst spreadsheetId=extractSpreadsheetId(googleSheetsUrl);if(spreadsheetId){// 🔥 שלוף נתוני גליון עם ערכים ונוסחאות\nconst sheetData=await getSheetData(spreadsheetId,newSheetName);setMessages(prev=>[...prev,{text:\"\\u2705 \\u05DE\\u05D7\\u05D5\\u05D1\\u05E8 \\u05DC\\u05D2\\u05DC\\u05D9\\u05D5\\u05DF: \".concat(newSheetName),sender:'system',timestamp:new Date(),id:Date.now()}]);// 🔥 נתח את הגליון עם Gemini\nif(sheetData){const analysisResult=await analyzeSheetWithGemini(sheetData,newSheetName,extractedPdf);// 🔥 Reanalyze PDF if it exists and is in simple OCR mode\nif(extractedPdf&&extractedPdf.processingMode==='simple_ocr'&&analysisResult){console.log('🔄 PDF found in simple_ocr mode, triggering reanalysis with sheet context...');await reanalyzePdfWithSheetContext(sheetData,analysisResult.instructions,analysisResult.summary,newSheetName);}}}};// 🔥 Function to reanalyze PDF when sheet context becomes available\nconst reanalyzePdfWithSheetContext=async(sheetData,sheetInstructions,sheetAnalysis,selectedSheetName)=>{if(!extractedPdf||!extractedPdf.fileId||extractedPdf.processingMode==='structured'){return;// No PDF to reanalyze or already analyzed\n}console.log('🔄 Reanalyzing PDF with new sheet context...');setMessages(prev=>[...prev,{text:\"\\uD83D\\uDD04 \\u05DE\\u05E0\\u05EA\\u05D7 \\u05DE\\u05D7\\u05D3\\u05E9 \\u05D0\\u05EA \\\"\".concat(extractedPdf.name,\"\\\" \\u05E2\\u05DD \\u05D4\\u05E7\\u05E9\\u05E8 \\u05D4\\u05D2\\u05DC\\u05D9\\u05D5\\u05DF \\u05D4\\u05D7\\u05D3\\u05E9...\"),sender:'system',timestamp:new Date(),id:Date.now()}]);try{// Create FormData for re-analysis\nconst formData=new FormData();// We need to fetch the PDF file again - check if it exists first\nconst pdfResponse=await fetch(\"\".concat(API_URL,\"/api/download-pdf/\").concat(extractedPdf.fileId),{credentials:'include'});if(!pdfResponse.ok){// PDF no longer exists on server - clean up state\nconsole.log('❌ PDF file no longer exists on server, cleaning up...');setExtractedPdf(null);localStorage.removeItem('extractedPdf');setMessages(prev=>prev.filter(msg=>!msg.text.includes(extractedPdf.name)));return;}const pdfBlob=await pdfResponse.blob();formData.append('pdf',pdfBlob,extractedPdf.name);// Add sheet context data directly to FormData\nconsole.log('🔄 Reanalyzing PDF with sheet context:',{hasSheetData:!!sheetData,sheetDataLength:sheetData?sheetData.length:0,hasInstructions:!!sheetInstructions,instructionsLength:sheetInstructions?sheetInstructions.length:0,hasAnalysis:!!sheetAnalysis,analysisLength:sheetAnalysis?sheetAnalysis.length:0,sheetName:selectedSheetName});if(sheetData){formData.append('sheetData',JSON.stringify(sheetData));}if(sheetInstructions){formData.append('sheetInstructions',sheetInstructions);}if(sheetAnalysis){formData.append('sheetAnalysis',sheetAnalysis);}if(selectedSheetName){formData.append('sheetName',selectedSheetName);}const response=await fetch(\"\".concat(API_URL,\"/api/extract-pdf-data\"),{method:'POST',body:formData,credentials:'include'});if(!response.ok){throw new Error('Failed to reanalyze PDF');}const result=await response.json();// Update PDF info with new analysis\nconst updatedPdfInfo=_objectSpread(_objectSpread({},extractedPdf),{},{data:result,processingMode:result.processingMode||'structured',isFullText:result.isFullText||false});setExtractedPdf(updatedPdfInfo);localStorage.setItem('extractedPdf',JSON.stringify(updatedPdfInfo));setMessages(prev=>[...prev,{text:\"\\u2705 \\\"\".concat(extractedPdf.name,\"\\\" \\u05E0\\u05D5\\u05EA\\u05D7 \\u05DE\\u05D7\\u05D3\\u05E9 \\u05D1\\u05D4\\u05E6\\u05DC\\u05D7\\u05D4 \\u05E2\\u05DD \\u05D4\\u05E7\\u05E9\\u05E8 \\u05D4\\u05D2\\u05DC\\u05D9\\u05D5\\u05DF\"),sender:'system',timestamp:new Date(),id:Date.now()}]);}catch(error){console.error('Error reanalyzing PDF:',error);setMessages(prev=>[...prev,{text:\"\\u274C \\u05E9\\u05D2\\u05D9\\u05D0\\u05D4 \\u05D1\\u05E0\\u05D9\\u05EA\\u05D5\\u05D7 \\u05DE\\u05D7\\u05D3\\u05E9 \\u05E9\\u05DC \\\"\".concat(extractedPdf.name,\"\\\": \").concat(error.message),sender:'system',timestamp:new Date(),id:Date.now()}]);}};const pickerCallback=data=>{if(data.action===window.google.picker.Action.PICKED){const doc=data.docs[0];setFileName(doc.name);handleGoogleSheetsUrl(doc.url);setSnackbarMessage(\"\\u05D8\\u05E2\\u05DF \\u05D2\\u05D9\\u05DC\\u05D9\\u05D5\\u05DF: \".concat(doc.name));setShowSnackbar(true);}};const createPicker=()=>{const developerKey=process.env.REACT_APP_GEMINI_API_KEY;const clientId=process.env.REACT_APP_GOOGLE_CLIENT_ID;if(!clientId||!developerKey){setAuthError('מפתחות API אינם מוגדרים כראוי.');setShowSnackbar(true);return;}const view=new window.google.picker.View(window.google.picker.ViewId.SPREADSHEETS);view.setMimeTypes(\"application/vnd.google-apps.spreadsheet\");const picker=new window.google.picker.PickerBuilder().setAppId(clientId.split('-')[0]).setOAuthToken(accessToken).setDeveloperKey(developerKey).addView(view).setCallback(pickerCallback).build();picker.setVisible(true);};const getSheetData=async function(spreadsheetId){let sheetName=arguments.length>1&&arguments[1]!==undefined?arguments[1]:null;if(!accessToken)return null;try{var _valuesResponse$value,_formulasResponse$val,_valuesResponse$value2,_formulasResponse$val2;const range=sheetName?\"'\".concat(sheetName,\"'!A1:Z1000\"):'A1:Z1000';console.log('🔥 Fetching sheet data with values and formulas...');// 🔥 קריאה 1: שלוף ערכים מעוצבים\nconst valuesResponse=await makeGoogleSheetsAPICall(spreadsheetId,range,null,'GET','FORMATTED_VALUE');// 🔥 קריאה 2: שלוף נוסחאות  \nconst formulasResponse=await makeGoogleSheetsAPICall(spreadsheetId,range,null,'GET','FORMULA');console.log('📊 Values response:',((_valuesResponse$value=valuesResponse.values)===null||_valuesResponse$value===void 0?void 0:_valuesResponse$value.length)||0,'rows');console.log('📋 Formulas response:',((_formulasResponse$val=formulasResponse.values)===null||_formulasResponse$val===void 0?void 0:_formulasResponse$val.length)||0,'rows');// 🔥 לוגים נוספים לבדיקה\nif(((_valuesResponse$value2=valuesResponse.values)===null||_valuesResponse$value2===void 0?void 0:_valuesResponse$value2.length)>0){console.log('📊 Sample values row 0:',valuesResponse.values[0]);}if(((_formulasResponse$val2=formulasResponse.values)===null||_formulasResponse$val2===void 0?void 0:_formulasResponse$val2.length)>0){console.log('📋 Sample formulas row 0:',formulasResponse.values[0]);}// 🔥 שלב את שניהם לאובייקט עשיר\nconst combinedData=combineValuesAndFormulas(valuesResponse.values||[],formulasResponse.values||[]);// 🔥 הצג הודעה למשתמש על השיפור\nconst formulaCount=combinedData.flat().filter(cell=>cell.type==='formula').length;if(formulaCount>0){console.log('🔥 Sample formula cells:',combinedData.flat().filter(cell=>cell.type==='formula').slice(0,3));setMessages(prev=>[...prev,{text:\"\\u2728 \\u05D2\\u05D9\\u05DC\\u05D9\\u05D5\\u05DF \\u05E0\\u05D8\\u05E2\\u05DF \\u05E2\\u05DD \".concat(formulaCount,\" \\u05E0\\u05D5\\u05E1\\u05D7\\u05D0\\u05D5\\u05EA - \\u05DB\\u05E2\\u05EA \\u05D4-AI \\u05D9\\u05DB\\u05D5\\u05DC \\u05DC\\u05E8\\u05D0\\u05D5\\u05EA \\u05D2\\u05DD \\u05D0\\u05EA \\u05D4\\u05E0\\u05D5\\u05E1\\u05D7\\u05D0\\u05D5\\u05EA \\u05D5\\u05D2\\u05DD \\u05D0\\u05EA \\u05D4\\u05E2\\u05E8\\u05DB\\u05D9\\u05DD!\"),sender:'system',timestamp:new Date(),id:Date.now()}]);}else{setMessages(prev=>[...prev,{text:\"\\uD83D\\uDCCA \\u05D2\\u05D9\\u05DC\\u05D9\\u05D5\\u05DF \\u05E0\\u05D8\\u05E2\\u05DF \\u05D1\\u05D4\\u05E6\\u05DC\\u05D7\\u05D4 - \\u05DE\\u05DB\\u05D9\\u05DC \\u05E0\\u05EA\\u05D5\\u05E0\\u05D9\\u05DD \\u05D0\\u05D1\\u05DC \\u05DC\\u05D0 \\u05E0\\u05DE\\u05E6\\u05D0\\u05D5 \\u05E0\\u05D5\\u05E1\\u05D7\\u05D0\\u05D5\\u05EA\",sender:'system',timestamp:new Date(),id:Date.now()}]);}return combinedData;}catch(error){console.error('Failed to fetch sheet data:',error);console.error('Error details:',{message:error.message,stack:error.stack});setMessages(prev=>[...prev,{text:\"\\u274C \\u05E9\\u05D2\\u05D9\\u05D0\\u05D4 \\u05D1\\u05D8\\u05E2\\u05D9\\u05E0\\u05EA \\u05D2\\u05D9\\u05DC\\u05D9\\u05D5\\u05DF: \".concat(error.message),sender:'system',timestamp:new Date(),id:Date.now()}]);return null;}};const startNewChat=()=>{setCurrentSessionId(null);setMessages([{text:'שלום! אני העוזר החכם TLV500. התחבר לחשבון Google ובחר גיליון כדי להתחיל.',sender:'assistant',timestamp:new Date(),id:Date.now()}]);// אפס מצב Agent Mode אם אין גליון נבחר\nif(!isSheetSelected){setIsAgentMode(false);}// אפס מצב Undo/Redo\nsetCanUndo(false);setCanRedo(false);setHasGreenCells(false);setChangesCount(0);setSheetAnalysis(null);setSheetInstructions(null);};const handleLogout=async()=>{try{// Call logout endpoint\nawait fetch(\"\".concat(API_URL,\"/auth/logout\"),{credentials:'include'});// Clear local state\nsetAccessToken('');setUser(null);setCurrentSessionId(null);setIsSheetSelected(false);setIsAgentMode(false);setCanUndo(false);setCanRedo(false);setHasGreenCells(false);setChangesCount(0);setSheetAnalysis(null);setSheetInstructions(null);localStorage.removeItem('accessToken');// Reset session ID for new session\nsetSessionId(Date.now().toString()+'_'+Math.random().toString(36).substring(2,15));// Reset messages\nsetMessages([{text:'שלום! אני העוזר החכם TLV500. התחבר לחשבון Google ובחר גיליון כדי להתחיל.',sender:'assistant',timestamp:new Date(),id:Date.now()}]);setSnackbarMessage('התנתקת בהצלחה!');setShowSnackbar(true);}catch(error){console.error('Error during logout:',error);}};// 🔄 Undo/Redo Functions\nconst checkUndoRedoStatus=async()=>{if(!currentSessionId)return;try{const response=await fetch(\"\".concat(API_URL,\"/api/action/status/\").concat(currentSessionId),{method:'GET',credentials:'include'});if(response.ok){const data=await response.json();setCanUndo(data.canUndo);setCanRedo(data.canRedo);}}catch(error){console.error('Error checking undo/redo status:',error);}};// 🟢 Check for green cells\nconst checkForGreenCells=async()=>{if(!googleSheetsUrl||!selectedSheetName||!currentSessionId||isCheckingGreenCells)return;setIsCheckingGreenCells(true);try{// Simple check - if there are undo-able actions of type AI_ACTION that were recently executed\n// we assume there might be green cells\nconst response=await fetch(\"\".concat(API_URL,\"/api/action/status/\").concat(currentSessionId),{credentials:'include'});if(response.ok){const status=await response.json();// For now, assume green cells exist if there are recent AI actions to undo\nconst hasChanges=status.canUndo;// Debug: checkForGreenCells result\nconsole.log('🟢 Full status from backend:',status);console.log('🟢 hasGreenCells:',hasChanges,'changesCount:',status.changesCount);setHasGreenCells(hasChanges);// עדכון ספירת השינויים מהבקענד\nsetChangesCount(status.changesCount||0);}}catch(error){console.error('Error checking for green cells:',error);setHasGreenCells(false);setChangesCount(0);}finally{setIsCheckingGreenCells(false);}};// ✅ Approve All Changes\nconst approveAllChanges=async()=>{if(!googleSheetsUrl||!selectedSheetName||!currentSessionId)return;try{var _googleSheetsUrl$matc,_availableSheets$find;const spreadsheetId=(_googleSheetsUrl$matc=googleSheetsUrl.match(/\\/spreadsheets\\/d\\/([a-zA-Z0-9-_]+)/))===null||_googleSheetsUrl$matc===void 0?void 0:_googleSheetsUrl$matc[1];const sheetId=((_availableSheets$find=availableSheets.find(s=>s.name===selectedSheetName))===null||_availableSheets$find===void 0?void 0:_availableSheets$find.id)||0;const response=await fetch(\"\".concat(API_URL,\"/api/action/approve-all\"),{method:'POST',headers:{'Content-Type':'application/json'},credentials:'include',body:JSON.stringify({spreadsheetId:spreadsheetId,selectedSheetName:selectedSheetName,sheetId:sheetId,sessionId:currentSessionId})});if(response.ok){const result=await response.json();setSnackbarMessage(result.message||'✅ כל השינויים אושרו');setShowSnackbar(true);// Refresh status\nawait checkUndoRedoStatus();await checkForGreenCells();// רענון חלק של הגליון\nsetTimeout(()=>{const iframe=document.querySelector('iframe[title=\"Google Sheets\"]');if(iframe){iframe.src=iframe.src;}},500);}else{throw new Error('Failed to approve changes');}}catch(error){console.error('Error approving all changes:',error);setSnackbarMessage('❌ שגיאה באישור השינויים');setShowSnackbar(true);}};// ❌ Reject All Changes\nconst rejectAllChanges=async()=>{if(!googleSheetsUrl||!selectedSheetName||!currentSessionId)return;try{var _googleSheetsUrl$matc2,_availableSheets$find2;const spreadsheetId=(_googleSheetsUrl$matc2=googleSheetsUrl.match(/\\/spreadsheets\\/d\\/([a-zA-Z0-9-_]+)/))===null||_googleSheetsUrl$matc2===void 0?void 0:_googleSheetsUrl$matc2[1];const sheetId=((_availableSheets$find2=availableSheets.find(s=>s.name===selectedSheetName))===null||_availableSheets$find2===void 0?void 0:_availableSheets$find2.id)||0;const response=await fetch(\"\".concat(API_URL,\"/api/action/reject-all\"),{method:'POST',headers:{'Content-Type':'application/json'},credentials:'include',body:JSON.stringify({spreadsheetId:spreadsheetId,selectedSheetName:selectedSheetName,sheetId:sheetId,sessionId:currentSessionId})});if(response.ok){const result=await response.json();setSnackbarMessage(result.message||'❌ כל השינויים נדחו');setShowSnackbar(true);// Refresh status\nawait checkUndoRedoStatus();await checkForGreenCells();// רענון חלק של הגליון\nsetTimeout(()=>{const iframe=document.querySelector('iframe[title=\"Google Sheets\"]');if(iframe){iframe.src=iframe.src;}},500);}else{throw new Error('Failed to reject changes');}}catch(error){console.error('Error rejecting all changes:',error);setSnackbarMessage('❌ שגיאה בדחיית השינויים');setShowSnackbar(true);}};const undoAction=async()=>{if(!currentSessionId)return;try{const response=await fetch(\"\".concat(API_URL,\"/api/action/undo\"),{method:'POST',headers:{'Content-Type':'application/json'},credentials:'include',body:JSON.stringify({sessionId:currentSessionId})});if(response.ok){const data=await response.json();setCanUndo(data.canUndo);setCanRedo(data.canRedo);setSnackbarMessage('↩️ '+data.message);setShowSnackbar(true);// עדכון כפתורי קבל/דחה\nawait checkForGreenCells();// רענון חלק של הגליון\nif(googleSheetsUrl&&selectedSheetName){setTimeout(()=>{const iframe=document.querySelector('iframe[title=\"Google Sheets\"]');if(iframe){iframe.src=iframe.src;}},500);// השהיה קצרה לפני רענון\n}}else{const error=await response.json();setSnackbarMessage('❌ שגיאה בביטול: '+error.error);setShowSnackbar(true);}}catch(error){console.error('Error in undo action:',error);setSnackbarMessage('❌ שגיאה בביטול הפעולה');setShowSnackbar(true);}};const redoAction=async()=>{if(!currentSessionId)return;try{const response=await fetch(\"\".concat(API_URL,\"/api/action/redo\"),{method:'POST',headers:{'Content-Type':'application/json'},credentials:'include',body:JSON.stringify({sessionId:currentSessionId})});if(response.ok){const data=await response.json();setCanUndo(data.canUndo);setCanRedo(data.canRedo);setSnackbarMessage('⤴️ '+data.message);setShowSnackbar(true);// עדכון כפתורי קבל/דחה\nawait checkForGreenCells();// רענון חלק של הגליון\nif(googleSheetsUrl&&selectedSheetName){setTimeout(()=>{const iframe=document.querySelector('iframe[title=\"Google Sheets\"]');if(iframe){iframe.src=iframe.src;}},500);// השהיה קצרה לפני רענון\n}}else{const error=await response.json();setSnackbarMessage('❌ שגיאה בשחזור: '+error.error);setShowSnackbar(true);}}catch(error){console.error('Error in redo action:',error);setSnackbarMessage('❌ שגיאה בשחזור הפעולה');setShowSnackbar(true);}};const sendMessage=async()=>{if(!question.trim()||isStreamingResponse)return;// 🛡️ בדיקה חדשה - אם יש גליון אבל לא נבחר גליון ספציפי\nif(isSheetLoaded&&!isSheetSelected){setMessages(prev=>[...prev,{text:'❌ יש לבחור גליון תחילה מהרשימה למעלה',sender:'system',timestamp:new Date(),id:Date.now()}]);return;}const currentQuestion=question;const userMessage={text:currentQuestion,sender:'user',timestamp:new Date(),id:Date.now()};setMessages(prev=>[...prev,userMessage]);setQuestion('');setIsStreamingResponse(true);// Generate session ID if this is a new conversation\nlet sessionId=currentSessionId;if(!sessionId){sessionId=generateSessionId();setCurrentSessionId(sessionId);}const loadingMessageId=Date.now()+1;setMessages(prev=>[...prev,{text:'',sender:'assistant',isLoading:true,timestamp:new Date(),id:loadingMessageId}]);// User message will be saved automatically by backend in /api/chat-stream\ntry{const sheetData=isSheetLoaded&&isSheetSelected?await getSheetData(extractSpreadsheetId(googleSheetsUrl),selectedSheetName):null;// We need to get the spreadsheetId here to send it\nconst spreadsheetId=isSheetLoaded?extractSpreadsheetId(googleSheetsUrl):null;const payload={question:currentQuestion,sheetData:sheetData,extractedPdfData:extractedPdf?extractedPdf.data:null,extractedExcelData:extractedExcel?extractedExcel.data:null,isAgentMode:isAgentMode,isSignificantChange:isSignificantChange,// 🎚️ הוסף מצב שינוי משמעותי\nconversationHistory:messages.filter(m=>!m.isLoading).map(m=>({role:m.sender==='user'?'user':'model',parts:[{text:m.text}]})),spreadsheetId:spreadsheetId,accessToken:accessToken,sessionId:sessionId,// Include session ID\nsheetsMetadata:sheetsMetadata,// ודא שהמשתנה הזה קיים ומכיל את המידע\nselectedSheetName:selectedSheetName,// ודא שהמשתנה הזה קיים ומכיל את שם הגיליון\nsheetInstructions:sheetInstructions,// 🔥 הוסף הוראות ניתוח\nsheetAnalysis:sheetAnalysis// 🔥 הוסף ניתוח הגליון\n};console.log('🔥 Sending payload with sheet instructions:',!!sheetInstructions);if(sheetInstructions){console.log('📋 Sheet instructions preview:',sheetInstructions.substring(0,200)+'...');}const response=await fetch(\"\".concat(API_URL,\"/api/chat-stream\"),{method:'POST',headers:{'Content-Type':'application/json'},credentials:'include',// This is crucial for session cookies!\nbody:JSON.stringify(payload)});if(!response.ok||!response.body){const errorText=await response.text();throw new Error(\"Server error: \".concat(response.status,\" \").concat(errorText));}const reader=response.body.getReader();const decoder=new TextDecoder();let accumulatedResponse='';while(true){const{value,done}=await reader.read();if(done)break;accumulatedResponse+=decoder.decode(value,{stream:true});const currentResponse=accumulatedResponse;setMessages(prev=>prev.map(m=>{if(m.id===loadingMessageId){// Show the accumulated response directly as text\nreturn _objectSpread(_objectSpread({},m),{},{text:currentResponse,isLoading:true});}return m;}));}// Final response processing - check if this is a change plan with clarification questions\nconst isChangePlanResponse=accumulatedResponse.includes('🤔 שאלות הבהרה')&&accumulatedResponse.includes('מזהה תוכנית:');if(isChangePlanResponse){// Extract plan ID from response\nconst planIdMatch=accumulatedResponse.match(/מזהה תוכנית:\\s*`([^`]+)`/);if(planIdMatch){const planId=planIdMatch[1];setPendingChangePlan({id:planId,response:accumulatedResponse,questions:extractQuestionsFromResponse(accumulatedResponse)});setIsAnsweringQuestions(true);setClarificationAnswers(['','','','','']);// Reset answers\n}}setMessages(prev=>prev.map(m=>m.id===loadingMessageId?_objectSpread(_objectSpread({},m),{},{text:accumulatedResponse,isLoading:false}):m));// Assistant response is automatically saved by backend in /api/chat-stream\n// אם היה זה פקודת undo/redo, רענן את הגליון\nconst questionLower=currentQuestion.toLowerCase().trim();const undoRedoKeywords=['בטל','undo','שחזר','redo','בטל פעולה','שחזר פעולה'];if(undoRedoKeywords.some(keyword=>questionLower.includes(keyword))){// רענון חלק של הגליון\nif(googleSheetsUrl&&selectedSheetName){setTimeout(()=>{const iframe=document.querySelector('iframe[title=\"Google Sheets\"]');if(iframe){iframe.src=iframe.src;}},800);// השהיה מעט יותר ארוכה עבור פקודות צ'אט\n}}}catch(error){console.error('Error in sendMessage:',error);setMessages(prev=>prev.map(m=>m.id===loadingMessageId?_objectSpread(_objectSpread({},m),{},{text:\"\\u05D0\\u05D9\\u05E8\\u05E2\\u05D4 \\u05E9\\u05D2\\u05D9\\u05D0\\u05D4: \".concat(error.message),isLoading:false,isError:true}):m));}finally{setIsStreamingResponse(false);// בדוק סטטוס Undo/Redo ותאים ירוקים אחרי כל הודעה\nconsole.log('📋 Message completed, checking status...',{isAgentMode,currentSessionId});setTimeout(()=>{console.log('⏰ Running status checks...');checkUndoRedoStatus();checkForGreenCells();},1000);// השהיה קצרה כדי לוודא שהבק-אנד סיים\n}};const saveAllChanges=()=>{setMessages(prev=>[...prev,{text:\"\\uD83D\\uDCBE \\u05DB\\u05DC \\u05D4\\u05E9\\u05D9\\u05E0\\u05D5\\u05D9\\u05D9\\u05DD \\u05E0\\u05E9\\u05DE\\u05E8\\u05D5 \\u05DC\\u05D2\\u05D9\\u05DC\\u05D9\\u05D5\\u05DF \".concat(fileName),sender:'system',timestamp:new Date(),id:Date.now()}]);};return/*#__PURE__*/_jsxs(ThemeProvider,{theme:theme,children:[/*#__PURE__*/_jsx(CssBaseline,{}),/*#__PURE__*/_jsxs(Box,{sx:{display:'flex',height:'100vh',bgcolor:'background.default',overflow:'hidden'},children:[/*#__PURE__*/_jsx(Box,{sx:{position:'fixed',top:0,left:0,right:0,bottom:0,background:\"radial-gradient(circle at 20% 30%, rgba(139, 92, 246, 0.08) 0%, transparent 60%), radial-gradient(circle at 80% 70%, rgba(99, 102, 241, 0.06) 0%, transparent 60%)\",pointerEvents:'none',zIndex:0}}),!isMobile&&/*#__PURE__*/_jsxs(Drawer,{variant:\"permanent\",sx:{width:drawerWidth,flexShrink:0,zIndex:1,'& .MuiDrawer-paper':{width:drawerWidth,boxSizing:'border-box',bgcolor:'rgba(10, 10, 10, 0.98)',borderRight:'1px solid rgba(139, 92, 246, 0.4)',backdropFilter:'blur(20px)'}},children:[/*#__PURE__*/_jsxs(Box,{sx:{p:3},children:[/*#__PURE__*/_jsx(Typography,{variant:\"h6\",sx:{background:'linear-gradient(135deg, #8B5CF6 0%, #6366F1 100%)',backgroundClip:'text',WebkitBackgroundClip:'text',WebkitTextFillColor:'transparent',fontWeight:700},children:\"TLV500\"}),/*#__PURE__*/_jsx(Typography,{variant:\"body2\",color:\"text.secondary\",children:\"AI Assistant\"})]}),/*#__PURE__*/_jsx(Divider,{sx:{borderColor:'rgba(139, 92, 246, 0.4)'}}),/*#__PURE__*/_jsxs(Box,{sx:{p:3},children:[/*#__PURE__*/_jsxs(Box,{sx:{display:'flex',alignItems:'center',gap:2,mb:2},children:[/*#__PURE__*/_jsx(Avatar,{src:user===null||user===void 0?void 0:user.profilePicture,sx:{width:45,height:45,background:'linear-gradient(135deg, #8B5CF6 0%, #6366F1 100%)'},children:user!==null&&user!==void 0&&user.name?user.name.charAt(0):/*#__PURE__*/_jsx(Person,{})}),/*#__PURE__*/_jsxs(Box,{sx:{flex:1},children:[/*#__PURE__*/_jsx(Typography,{variant:\"body2\",fontWeight:600,children:(user===null||user===void 0?void 0:user.name)||'משתמש אורח'}),/*#__PURE__*/_jsx(Typography,{variant:\"caption\",color:\"text.secondary\",children:(user===null||user===void 0?void 0:user.email)||'לא מחובר'})]})]}),accessToken&&/*#__PURE__*/_jsx(Button,{variant:\"outlined\",onClick:handleLogout,size:\"small\",fullWidth:true,sx:{borderColor:'rgba(239, 68, 68, 0.5)',color:'error.main','&:hover':{borderColor:'error.main',bgcolor:'rgba(239, 68, 68, 0.1)'}},children:\"\\u05D4\\u05EA\\u05E0\\u05EA\\u05E7\"})]}),/*#__PURE__*/_jsx(Divider,{sx:{borderColor:'rgba(139, 92, 246, 0.4)'}}),/*#__PURE__*/_jsx(Box,{sx:{flexGrow:1,overflow:'hidden'},children:/*#__PURE__*/_jsx(ChatHistory,{accessToken:accessToken,onSessionSelect:handleSessionSelect,currentSessionId:currentSessionId})})]}),/*#__PURE__*/_jsxs(Box,{sx:{flexGrow:1,display:'flex',flexDirection:isMobile?'column':'row',zIndex:1,height:'100vh',overflow:'hidden'},children:[/*#__PURE__*/_jsxs(Box,{sx:{flex:isMobile?'1 1 60%':'0 0 65%',p:2,display:'flex',flexDirection:'column',height:'100%',overflow:'hidden'},children:[/*#__PURE__*/_jsxs(Box,{sx:{mb:2,display:'flex',justifyContent:'space-between',alignItems:'center',flexWrap:'wrap',gap:2},children:[/*#__PURE__*/_jsxs(Box,{sx:{display:'flex',alignItems:'center',gap:2},children:[/*#__PURE__*/_jsx(Typography,{variant:\"h6\",fontWeight:600,color:\"text.primary\",children:fileName||'לא נבחר גיליון'}),availableSheets.length>0&&/*#__PURE__*/_jsxs(FormControl,{size:\"small\",sx:{minWidth:200,'& .MuiOutlinedInput-notchedOutline':{borderColor:!isSheetSelected?'rgba(239, 68, 68, 0.7)':'rgba(139, 92, 246, 0.5)'},'& .MuiInputLabel-root':{color:!isSheetSelected?'error.main':'text.secondary'}},error:!isSheetSelected,children:[/*#__PURE__*/_jsx(InputLabel,{children:!isSheetSelected?'🔴 בחר גליון (חובה)':'גליון נוכחי'}),/*#__PURE__*/_jsx(Select,{value:selectedSheetName||'',onChange:e=>handleSheetChange(e.target.value),disabled:isLoadingSheets,children:availableSheets.map(sheet=>/*#__PURE__*/_jsx(MenuItem,{value:sheet.name,children:sheet.name},sheet.id))})]}),isLoadingSheets&&/*#__PURE__*/_jsx(CircularProgress,{size:20,sx:{color:'primary.main'}})]}),/*#__PURE__*/_jsxs(Box,{sx:{display:'flex',gap:1},children:[!accessToken?/*#__PURE__*/_jsx(Button,{variant:\"contained\",href:API_URL,children:\"\\u05D4\\u05EA\\u05D7\\u05D1\\u05E8 \\u05E2\\u05DD Google\"}):/*#__PURE__*/_jsx(Button,{variant:\"outlined\",onClick:createPicker,disabled:!isPickerReady,children:!isPickerReady?'טוען API...':'בחר גיליון מ-Drive'}),accessToken&&/*#__PURE__*/_jsx(Button,{variant:\"outlined\",onClick:startNewChat,sx:{minWidth:'auto'},children:\"+ \\u05E9\\u05D9\\u05D7\\u05D4 \\u05D7\\u05D3\\u05E9\\u05D4\"})]}),changesCount>0&&/*#__PURE__*/_jsx(Chip,{label:\"\".concat(changesCount,\" \\u05E9\\u05D9\\u05E0\\u05D5\\u05D9\\u05D9\\u05DD \\u05DC\\u05D0 \\u05E9\\u05DE\\u05D5\\u05E8\\u05D9\\u05DD\"),size:\"small\",color:\"warning\"}),/*#__PURE__*/_jsx(Button,{variant:\"contained\",startIcon:/*#__PURE__*/_jsx(Save,{}),onClick:saveAllChanges,color:\"primary\",size:\"small\",children:\"\\u05E9\\u05DE\\u05D5\\u05E8 \\u05D4\\u05DB\\u05DC\"})]}),/*#__PURE__*/_jsxs(Paper,{sx:{flexGrow:1,display:'flex',flexDirection:'column',overflow:'hidden',background:'rgba(15, 15, 15, 0.98)',border:'1px solid rgba(139, 92, 246, 0.25)',position:'relative'},children:[!isSheetLoaded&&/*#__PURE__*/_jsx(Box,{sx:{p:1,textAlign:'center',mt:2},children:/*#__PURE__*/_jsx(TextField,{placeholder:\"\\u05D4\\u05DB\\u05E0\\u05E1 \\u05E7\\u05D9\\u05E9\\u05D5\\u05E8 \\u05DC\\u05D2\\u05D5\\u05D2\\u05DC \\u05E9\\u05D9\\u05D8\\u05E1...\",size:\"small\",sx:{minWidth:400},onKeyPress:async e=>{if(e.key==='Enter'&&e.target.value){await handleGoogleSheetsUrl(e.target.value);e.target.value='';}}})}),/*#__PURE__*/_jsxs(Box,{ref:iframeContainerRef,sx:{flexGrow:1,border:'1px solid rgba(139, 92, 246, 0.4)',borderRadius:1,bgcolor:'rgba(5, 5, 5, 0.8)',position:'relative',overflow:'hidden',m:0.5,// רווח מינימלי מהקצוות\n// הגנה על Mac gestures\noverscrollBehavior:'contain',touchAction:'auto',WebkitOverflowScrolling:'touch'},onMouseEnter:()=>setIsIframeHovered(true),onMouseLeave:()=>setIsIframeHovered(false),children:[isSheetLoaded&&isSheetSelected&&(hasGreenCells||changesCount>0)&&/*#__PURE__*/_jsxs(\"div\",{style:{position:'absolute',top:'8px',right:'8px',display:'flex',gap:'0px',zIndex:1000,backgroundColor:'rgba(0, 0, 0, 0.8)',border:'1px solid rgba(255, 255, 255, 0.3)',borderRadius:'4px',padding:'2px'},children:[/*#__PURE__*/_jsxs(\"div\",{onClick:()=>{approveAllChanges();},style:{backgroundColor:'#4caf50',color:'white',border:'1px solid #2e7d32',width:'45px',height:'20px',fontSize:'0.65rem',fontWeight:'bold',borderRadius:'0px',cursor:'pointer',display:'flex',alignItems:'center',justifyContent:'center',userSelect:'none',transition:'all 0.2s ease',boxShadow:'0 2px 4px rgba(0,0,0,0.2)'},title:\"\\u05D0\\u05E9\\u05E8 \\u05DB\\u05DC \\u05D4\\u05E9\\u05D9\\u05E0\\u05D5\\u05D9\\u05D9\\u05DD\",onMouseEnter:e=>{e.target.style.backgroundColor='#45a049';e.target.style.transform='scale(1.05)';e.target.style.boxShadow='0 4px 8px rgba(76, 175, 80, 0.4)';e.target.style.borderColor='#4caf50';e.target.textContent='קבל הכל';e.target.style.fontSize='0.6rem';},onMouseLeave:e=>{e.target.style.backgroundColor='#4caf50';e.target.style.transform='scale(1)';e.target.style.boxShadow='0 2px 4px rgba(0,0,0,0.2)';e.target.style.borderColor='#2e7d32';e.target.textContent=\"\\u2713 (\".concat(changesCount||0,\")\");e.target.style.fontSize='0.65rem';},children:[\"\\u2713 (\",changesCount||0,\")\"]}),/*#__PURE__*/_jsxs(\"div\",{onClick:()=>{rejectAllChanges();},style:{backgroundColor:'#f44336',color:'white',border:'1px solid #c62828',width:'45px',height:'20px',fontSize:'0.65rem',fontWeight:'bold',borderRadius:'0px',cursor:'pointer',display:'flex',alignItems:'center',justifyContent:'center',userSelect:'none',transition:'all 0.2s ease',boxShadow:'0 2px 4px rgba(0,0,0,0.2)'},title:\"\\u05D3\\u05D7\\u05D4 \\u05DB\\u05DC \\u05D4\\u05E9\\u05D9\\u05E0\\u05D5\\u05D9\\u05D9\\u05DD\",onMouseEnter:e=>{e.target.style.backgroundColor='#d32f2f';e.target.style.transform='scale(1.05)';e.target.style.boxShadow='0 4px 8px rgba(244, 67, 54, 0.4)';e.target.style.borderColor='#f44336';e.target.textContent='דחה הכל';e.target.style.fontSize='0.6rem';},onMouseLeave:e=>{e.target.style.backgroundColor='#f44336';e.target.style.transform='scale(1)';e.target.style.boxShadow='0 2px 4px rgba(0,0,0,0.2)';e.target.style.borderColor='#c62828';e.target.textContent=\"\\u2715 (\".concat(changesCount||0,\")\");e.target.style.fontSize='0.65rem';},children:[\"\\u2715 (\",changesCount||0,\")\"]})]}),isSheetLoaded&&isSheetSelected&&(canUndo||canRedo)&&/*#__PURE__*/_jsxs(\"div\",{style:{position:'absolute',bottom:'8px',right:'8px',display:'flex',gap:'0px',zIndex:1000,backgroundColor:'rgba(0, 0, 0, 0.8)',border:'1px solid rgba(255, 255, 255, 0.3)',borderRadius:'4px',padding:'2px'},children:[/*#__PURE__*/_jsx(\"div\",{onClick:()=>{if(canUndo)undoAction();},style:{backgroundColor:canUndo?'#2196f3':'#666',color:'white',border:\"1px solid \".concat(canUndo?'#1976d2':'#555'),width:'45px',height:'20px',fontSize:'0.65rem',fontWeight:'bold',borderRadius:'0px',cursor:canUndo?'pointer':'not-allowed',display:'flex',alignItems:'center',justifyContent:'center',userSelect:'none',transition:'all 0.2s ease',boxShadow:'0 2px 4px rgba(0,0,0,0.2)',opacity:canUndo?1:0.5},title:\"\\u05D1\\u05D8\\u05DC \\u05E4\\u05E2\\u05D5\\u05DC\\u05D4\",onMouseEnter:e=>{if(canUndo){e.target.style.backgroundColor='#1976d2';e.target.style.transform='scale(1.05)';e.target.style.boxShadow='0 4px 8px rgba(33, 150, 243, 0.4)';e.target.style.borderColor='#2196f3';e.target.textContent='בטל';e.target.style.fontSize='0.6rem';}},onMouseLeave:e=>{if(canUndo){e.target.style.backgroundColor='#2196f3';e.target.style.transform='scale(1)';e.target.style.boxShadow='0 2px 4px rgba(0,0,0,0.2)';e.target.style.borderColor='#1976d2';e.target.textContent='↩️';e.target.style.fontSize='0.65rem';}},children:\"\\u21A9\\uFE0F\"}),/*#__PURE__*/_jsx(\"div\",{onClick:()=>{if(canRedo)redoAction();},style:{backgroundColor:canRedo?'#ff9800':'#666',color:'white',border:\"1px solid \".concat(canRedo?'#f57c00':'#555'),width:'45px',height:'20px',fontSize:'0.65rem',fontWeight:'bold',borderRadius:'0px',cursor:canRedo?'pointer':'not-allowed',display:'flex',alignItems:'center',justifyContent:'center',userSelect:'none',transition:'all 0.2s ease',boxShadow:'0 2px 4px rgba(0,0,0,0.2)',opacity:canRedo?1:0.5},title:\"\\u05E9\\u05D7\\u05D6\\u05E8 \\u05E4\\u05E2\\u05D5\\u05DC\\u05D4\",onMouseEnter:e=>{if(canRedo){e.target.style.backgroundColor='#f57c00';e.target.style.transform='scale(1.05)';e.target.style.boxShadow='0 4px 8px rgba(255, 152, 0, 0.4)';e.target.style.borderColor='#ff9800';e.target.textContent='שחזר';e.target.style.fontSize='0.6rem';}},onMouseLeave:e=>{if(canRedo){e.target.style.backgroundColor='#ff9800';e.target.style.transform='scale(1)';e.target.style.boxShadow='0 2px 4px rgba(0,0,0,0.2)';e.target.style.borderColor='#f57c00';e.target.textContent='⤴️';e.target.style.fontSize='0.65rem';}},children:\"\\u2934\\uFE0F\"})]}),isSheetLoaded&&isSheetSelected?/*#__PURE__*/_jsx(\"iframe\",{src:getSheetUrlWithGid(googleSheetsUrl,selectedSheetName),width:\"100%\",height:\"100%\",style:{border:'none',borderRadius:'4px'},title:\"Google Sheets\"}):availableSheets.length>0&&!isSheetSelected?/*#__PURE__*/_jsxs(Box,{sx:{display:'flex',flexDirection:'column',alignItems:'center',justifyContent:'center',height:'100%',color:'text.secondary'},children:[/*#__PURE__*/_jsx(TableChart,{sx:{fontSize:60,mb:2,opacity:0.5,color:'error.main'}}),/*#__PURE__*/_jsx(Typography,{variant:\"h6\",gutterBottom:true,color:\"error.main\",children:\"\\u05D9\\u05E9 \\u05DC\\u05D1\\u05D7\\u05D5\\u05E8 \\u05D2\\u05DC\\u05D9\\u05D5\\u05DF \\u05EA\\u05D7\\u05D9\\u05DC\\u05D4\"}),/*#__PURE__*/_jsx(Typography,{variant:\"body2\",textAlign:\"center\",sx:{maxWidth:400},children:\"\\u05D1\\u05D7\\u05E8 \\u05D2\\u05DC\\u05D9\\u05D5\\u05DF \\u05DE\\u05D4\\u05E8\\u05E9\\u05D9\\u05DE\\u05D4 \\u05DC\\u05DE\\u05E2\\u05DC\\u05D4 \\u05DB\\u05D3\\u05D9 \\u05DC\\u05D4\\u05EA\\u05D7\\u05D9\\u05DC \\u05DC\\u05E2\\u05D1\\u05D5\\u05D3\"})]}):/*#__PURE__*/_jsxs(Box,{sx:{display:'flex',flexDirection:'column',alignItems:'center',justifyContent:'center',height:'100%',color:'text.secondary'},children:[/*#__PURE__*/_jsx(TableChart,{sx:{fontSize:60,mb:2,opacity:0.5}}),/*#__PURE__*/_jsx(Typography,{variant:\"h6\",gutterBottom:true,children:\"\\u05D8\\u05E2\\u05DF \\u05D2\\u05D9\\u05DC\\u05D9\\u05D5\\u05DF \\u05D2\\u05D5\\u05D2\\u05DC \\u05E9\\u05D9\\u05D8\\u05E1\"}),/*#__PURE__*/_jsx(Typography,{variant:\"body2\",textAlign:\"center\",sx:{maxWidth:400},children:\"\\u05D4\\u05DB\\u05E0\\u05E1 \\u05E7\\u05D9\\u05E9\\u05D5\\u05E8 \\u05DC\\u05D2\\u05D5\\u05D2\\u05DC \\u05E9\\u05D9\\u05D8\\u05E1 \\u05D1\\u05E9\\u05D3\\u05D4 \\u05DC\\u05DE\\u05E2\\u05DC\\u05D4\"})]})]})]})]}),/*#__PURE__*/_jsx(Box,{sx:{width:isMobile?'100%':'35%',flex:isMobile?'1 1 40%':'0 0 35%',p:2,height:'100%',display:'flex',flexDirection:'column'},children:/*#__PURE__*/_jsxs(Paper,{sx:{flexGrow:1,display:'flex',flexDirection:'column',overflow:'hidden',background:'rgba(25, 25, 25, 0.98)',border:'1px solid rgba(139, 92, 246, 0.25)'},children:[/*#__PURE__*/_jsxs(Box,{sx:{p:2,borderBottom:'1px solid rgba(139, 92, 246, 0.4)'},children:[/*#__PURE__*/_jsx(Typography,{variant:\"h6\",fontWeight:600,children:\"\\u05E2\\u05D5\\u05D6\\u05E8 AI\"}),/*#__PURE__*/_jsx(Typography,{variant:\"body2\",color:\"text.secondary\",children:\"\\u05DE\\u05D5\\u05DB\\u05DF \\u05DC\\u05E2\\u05D6\\u05D5\\u05E8 \\u05E2\\u05DD \\u05D4\\u05E0\\u05D9\\u05EA\\u05D5\\u05D7 \\u05E9\\u05DC\\u05DA\"})]}),/*#__PURE__*/_jsx(Box,{sx:{p:2,borderBottom:'1px solid rgba(139, 92, 246, 0.4)'},children:/*#__PURE__*/_jsxs(Box,{sx:{display:'flex',flexDirection:'column',gap:2},children:[/*#__PURE__*/_jsxs(Box,{sx:{display:'flex',gap:1},children:[/*#__PURE__*/_jsxs(Button,{variant:\"outlined\",component:\"label\",startIcon:/*#__PURE__*/_jsx(Description,{}),size:\"small\",disabled:isExtractingData,sx:{flex:1,borderColor:'rgba(139, 92, 246, 0.5)','&.Mui-disabled':{color:'text.secondary'}},children:[isExtractingData?'מעבד...':'PDF',/*#__PURE__*/_jsx(\"input\",{type:\"file\",hidden:true,accept:\".pdf\",onChange:e=>handleFileUpload(e,'PDF'),disabled:isExtractingData})]}),/*#__PURE__*/_jsxs(Button,{variant:\"outlined\",component:\"label\",startIcon:/*#__PURE__*/_jsx(TableChart,{}),size:\"small\",disabled:isExtractingExcel,sx:{flex:1,borderColor:'rgba(139, 92, 246, 0.5)'},children:[isExtractingExcel?'מעבד...':'Excel',/*#__PURE__*/_jsx(\"input\",{type:\"file\",hidden:true,accept:\".xlsx,.xls,.csv\",onChange:e=>handleFileUpload(e,'Excel'),disabled:isExtractingExcel})]})]}),extractedPdf&&/*#__PURE__*/_jsxs(Box,{sx:{display:'flex',alignItems:'center',gap:1,mt:1,p:1,bgcolor:extractedPdf.processingMode==='simple_ocr'?'rgba(255, 193, 7, 0.1)':'rgba(139, 92, 246, 0.1)',borderRadius:2,border:extractedPdf.processingMode==='simple_ocr'?'1px solid rgba(255, 193, 7, 0.3)':'1px solid rgba(139, 92, 246, 0.3)'},children:[/*#__PURE__*/_jsx(Description,{sx:{color:extractedPdf.processingMode==='simple_ocr'?'warning.main':'primary.main',fontSize:20}}),/*#__PURE__*/_jsxs(Typography,{variant:\"body2\",sx:{flex:1,whiteSpace:'nowrap',overflow:'hidden',textOverflow:'ellipsis'},children:[extractedPdf.name,extractedPdf.processingMode==='simple_ocr'&&' 📑',extractedPdf.processingMode==='structured'&&' 🔍']}),/*#__PURE__*/_jsx(Button,{size:\"small\",onClick:()=>{setExtractedPdf(null);localStorage.removeItem('extractedPdf');setMessages(prev=>[...prev,{text:'📄 נתוני ה-PDF נוקו מההקשר.',sender:'system',timestamp:new Date(),id:Date.now()}]);},sx:{color:'error.main',minWidth:'auto',p:0.5},children:\"\\u2715\"})]}),extractedExcel&&/*#__PURE__*/_jsxs(Box,{sx:{display:'flex',alignItems:'center',gap:1,mt:1,p:1,bgcolor:'rgba(16, 185, 129, 0.1)',borderRadius:2,border:'1px solid rgba(16, 185, 129, 0.3)'},children:[/*#__PURE__*/_jsx(TableChart,{sx:{color:'success.main',fontSize:20}}),/*#__PURE__*/_jsx(Typography,{variant:\"body2\",sx:{flex:1,whiteSpace:'nowrap',overflow:'hidden',textOverflow:'ellipsis'},children:extractedExcel.name}),/*#__PURE__*/_jsx(Button,{size:\"small\",onClick:()=>{setExtractedExcel(null);localStorage.removeItem('extractedExcel');setMessages(prev=>[...prev,{text:'📊 נתוני ה-Excel נוקו מההקשר.',sender:'system',timestamp:new Date(),id:Date.now()}]);},sx:{color:'error.main',minWidth:'auto',p:0.5},children:\"\\u2715\"})]})]})}),/*#__PURE__*/_jsxs(Box,{sx:{flexGrow:1,overflow:'auto',p:2},children:[messages.map((msg,index)=>/*#__PURE__*/_jsxs(Box,{sx:{mb:2},className:\"chat-message\",children:[/*#__PURE__*/_jsx(Box,{sx:{display:'flex',justifyContent:msg.sender==='user'?'flex-end':'flex-start',mb:1},children:/*#__PURE__*/_jsx(Paper,{sx:{p:1.5,maxWidth:'85%',background:msg.sender==='user'?'linear-gradient(135deg, #8B5CF6 0%, #6366F1 100%)':'rgba(35, 35, 35, 0.9)',color:'white',borderRadius:3},children:msg.isLoading?/*#__PURE__*/_jsx(CircularProgress,{size:16,color:\"inherit\"}):/*#__PURE__*/_jsx(Typography,{variant:\"body2\",className:\"chat-message-text\",sx:{whiteSpace:'pre-wrap'},dangerouslySetInnerHTML:{__html:formatMixedText(msg.text)}})})}),/*#__PURE__*/_jsx(Typography,{variant:\"caption\",color:\"text.secondary\",sx:{display:'block',textAlign:msg.sender==='user'?'right':'left',px:1},children:msg.timestamp.toLocaleTimeString('he-IL',{hour:'2-digit',minute:'2-digit'})})]},msg.id||index)),/*#__PURE__*/_jsx(\"div\",{ref:chatEndRef})]}),isAnsweringQuestions&&pendingChangePlan&&/*#__PURE__*/_jsxs(Box,{sx:{p:2,borderTop:'1px solid rgba(139, 92, 246, 0.4)',backgroundColor:'rgba(139, 92, 246, 0.1)'},children:[/*#__PURE__*/_jsx(Typography,{variant:\"h6\",sx:{mb:2,color:'#8b5cf6'},children:\"\\uD83E\\uDD14 \\u05E9\\u05D0\\u05DC\\u05D5\\u05EA \\u05D4\\u05D1\\u05D4\\u05E8\\u05D4 \\u05DC\\u05D1\\u05D9\\u05E6\\u05D5\\u05E2 \\u05D4\\u05EA\\u05D5\\u05DB\\u05E0\\u05D9\\u05EA\"}),/*#__PURE__*/_jsx(Typography,{variant:\"body2\",sx:{mb:2,color:'text.secondary'},children:\"\\u05D0\\u05E0\\u05D0 \\u05E2\\u05E0\\u05D4 \\u05E2\\u05DC \\u05DB\\u05DC 5 \\u05D4\\u05E9\\u05D0\\u05DC\\u05D5\\u05EA \\u05DC\\u05D1\\u05D9\\u05E6\\u05D5\\u05E2 \\u05DE\\u05D3\\u05D5\\u05D9\\u05E7 \\u05E9\\u05DC \\u05D4\\u05E9\\u05D9\\u05E0\\u05D5\\u05D9\\u05D9\\u05DD:\"}),pendingChangePlan.questions.map((question,index)=>/*#__PURE__*/_jsxs(Box,{sx:{mb:2},children:[/*#__PURE__*/_jsxs(Typography,{variant:\"body2\",sx:{mb:1,fontWeight:'bold'},children:[index+1,\". \",question]}),/*#__PURE__*/_jsx(TextField,{fullWidth:true,multiline:true,rows:2,value:clarificationAnswers[index],onChange:e=>{const newAnswers=[...clarificationAnswers];newAnswers[index]=e.target.value;setClarificationAnswers(newAnswers);},placeholder:\"\\u05D4\\u05DB\\u05E0\\u05E1 \\u05EA\\u05E9\\u05D5\\u05D1\\u05D4...\",variant:\"outlined\",size:\"small\",sx:{'& .MuiOutlinedInput-root':{backgroundColor:'rgba(255, 255, 255, 0.05)','& fieldset':{borderColor:'rgba(139, 92, 246, 0.3)'},'& textarea':{textAlign:'right',direction:'rtl'}}}})]},index)),/*#__PURE__*/_jsxs(Box,{sx:{display:'flex',gap:1,mt:2},children:[/*#__PURE__*/_jsx(Button,{variant:\"contained\",onClick:executeChangePlan,disabled:isStreamingResponse||clarificationAnswers.some(answer=>!answer.trim()),sx:{bgcolor:'#8b5cf6','&:hover':{bgcolor:'#7c3aed'},flex:1},children:isStreamingResponse?'מבצע...':'בצע תוכנית'}),/*#__PURE__*/_jsx(Button,{variant:\"outlined\",onClick:()=>{setIsAnsweringQuestions(false);setPendingChangePlan(null);setClarificationAnswers(['','','','','']);},disabled:isStreamingResponse,sx:{borderColor:'rgba(139, 92, 246, 0.5)'},children:\"\\u05D1\\u05D9\\u05D8\\u05D5\\u05DC\"})]})]}),/*#__PURE__*/_jsxs(Box,{sx:{p:2,borderTop:'1px solid rgba(139, 92, 246, 0.4)'},children:[isAgentMode&&isSheetLoaded&&isSheetSelected&&/*#__PURE__*/_jsxs(Box,{sx:{mb:1,display:'flex',alignItems:'center',gap:1},children:[/*#__PURE__*/_jsx(Switch,{checked:isSignificantChange,onChange:e=>setIsSignificantChange(e.target.checked),sx:{'& .MuiSwitch-switchBase.Mui-checked':{color:'#8B5CF6'},'& .MuiSwitch-switchBase.Mui-checked + .MuiSwitch-track':{backgroundColor:'#8B5CF6'}}}),/*#__PURE__*/_jsx(Typography,{variant:\"body2\",sx:{color:isSignificantChange?'#8B5CF6':'#666'},children:isSignificantChange?'🤔 שינוי משמעותי (עם הבהרות)':'⚡ שינוי רגיל (מיידי)'})]}),/*#__PURE__*/_jsxs(Box,{sx:{display:'flex',gap:1},children:[/*#__PURE__*/_jsx(TextField,{fullWidth:true,variant:\"outlined\",placeholder:isAnsweringQuestions?\"ענה על השאלות למעלה תחילה...\":\"שאל אותי כל דבר... (Shift+Enter לשורה חדשה)\",value:question,onChange:e=>setQuestion(e.target.value),onKeyPress:e=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();// Prevents adding a new line\nsendMessage();}},multiline:true,minRows:2,maxRows:5,disabled:isStreamingResponse||isAnsweringQuestions,className:\"hebrew-input\",sx:{'& .MuiOutlinedInput-root':{borderRadius:3}}}),/*#__PURE__*/_jsx(Fab,{color:\"primary\",onClick:sendMessage,size:\"small\",disabled:isStreamingResponse||isAnsweringQuestions,children:/*#__PURE__*/_jsx(Send,{})})]}),/*#__PURE__*/_jsx(FormControlLabel,{control:/*#__PURE__*/_jsx(Switch,{checked:isAgentMode,onChange:e=>setIsAgentMode(e.target.checked),disabled:!googleSheetsUrl||!isSheetSelected}),label:\"Agent Mode: Allow Sheet Editing \".concat(!isSheetSelected?'(בחר גליון תחילה)':''),sx:{color:!googleSheetsUrl||!isSheetSelected?'text.disabled':'text.secondary',mt:1,mr:0}})]})]})})]}),/*#__PURE__*/_jsx(Snackbar,{open:showSnackbar,autoHideDuration:6000,onClose:()=>setShowSnackbar(false),anchorOrigin:{vertical:'bottom',horizontal:'center'},sx:{bottom:{xs:90,sm:24}},children:/*#__PURE__*/_jsx(Alert,{onClose:()=>setShowSnackbar(false),severity:authError?\"error\":\"success\",sx:{width:'100%',bgcolor:'#2E2E2E',color:'white'},children:snackbarMessage||authError})})]})]});}export default App;","map":{"version":3,"names":["React","useState","useEffect","useRef","Box","Drawer","Typography","Paper","TextField","Button","Avatar","Divider","Chip","Fab","useMediaQuery","useTheme","CircularProgress","Alert","Snackbar","CssBaseline","FormControl","InputLabel","Select","MenuItem","Switch","FormControlLabel","Send","Person","Description","TableChart","Save","createTheme","ThemeProvider","ChatHistory","jsx","_jsx","jsxs","_jsxs","API_URL","process","env","REACT_APP_API_URL","theme","palette","mode","primary","main","secondary","background","default","paper","text","success","error","warning","typography","fontFamily","h4","fontWeight","h6","components","MuiButton","styleOverrides","root","borderRadius","textTransform","padding","contained","boxShadow","transform","MuiPaper","backdropFilter","border","drawerWidth","formatMixedText","englishPattern","replace","match","concat","App","muiTheme","isMobile","breakpoints","down","messages","setMessages","sender","timestamp","Date","id","now","question","setQuestion","fileName","setFileName","googleSheetsUrl","setGoogleSheetsUrl","changesCount","setChangesCount","isSheetLoaded","setIsSheetLoaded","isPickerReady","setIsPickerReady","accessToken","setAccessToken","sheetsMetadata","setSheetsMetadata","authError","setAuthError","showSnackbar","setShowSnackbar","snackbarMessage","setSnackbarMessage","availableSheets","setAvailableSheets","selectedSheetName","setSelectedSheetName","isLoadingSheets","setIsLoadingSheets","extractedPdf","setExtractedPdf","isExtractingData","setIsExtractingData","extractedExcel","setExtractedExcel","isExtractingExcel","setIsExtractingExcel","isAgentMode","setIsAgentMode","isStreamingResponse","setIsStreamingResponse","isSheetSelected","setIsSheetSelected","isIframeHovered","setIsIframeHovered","canUndo","setCanUndo","canRedo","setCanRedo","hasGreenCells","setHasGreenCells","isCheckingGreenCells","setIsCheckingGreenCells","currentSessionId","setCurrentSessionId","user","setUser","chatEndRef","iframeContainerRef","sheetAnalysis","setSheetAnalysis","sheetInstructions","setSheetInstructions","pendingChangePlan","setPendingChangePlan","clarificationAnswers","setClarificationAnswers","isAnsweringQuestions","setIsAnsweringQuestions","isSignificantChange","setIsSignificantChange","sessionId","setSessionId","toString","Math","random","substring","extractQuestionsFromResponse","response","console","log","questionSection","split","questions","questionMatches","forEach","trim","length","push","lines","line","slice","executeChangePlan","some","answer","loadingMessageId","prev","isLoading","sheetData","getSheetData","extractSpreadsheetId","spreadsheetId","payload","planId","fetch","method","headers","credentials","body","JSON","stringify","ok","errorText","Error","status","reader","getReader","decoder","TextDecoder","accumulatedResponse","value","done","read","decode","stream","map","m","_objectSpread","setTimeout","iframe","document","querySelector","src","message","savedToken","localStorage","getItem","savedPdfJson","savedPdf","parse","name","data","fileId","then","removeItem","catch","e","savedExcelJson","savedExcel","fetchUserInfo","params","URLSearchParams","window","location","search","token","get","setItem","history","replaceState","title","checkAuthStatus","json","_chatEndRef$current","current","scrollIntoView","behavior","script","createElement","onload","gapi","load","callback","head","appendChild","handleWheel","abs","deltaX","deltaY","preventDefault","stopPropagation","handleTouchStart","handleTouchMove","addEventListener","passive","removeEventListener","timer","checkUndoRedoStatus","checkForGreenCells","clearTimeout","handleSessionSelect","chatHistory","loadedMessages","msg","content","role","_id","generateSessionId","substr","makeGoogleSheetsAPICall","range","values","arguments","undefined","valueRenderOption","baseUrl","_data$error","url","options","combineValuesAndFormulas","formulas","combined","row","max","valueRow","formulaRow","combinedRow","col","formula","startsWith","type","finalValue","analyzeSheetWithGemini","sheetName","currentExtractedPdf","_result$summary","_result$instructions","analysisType","result","summary","instructions","getSheetUrlWithGid","selectedSheet","find","sheet","cleanUrl","getSpreadsheetMetadata","metadata","sheets","properties","sheetId","handleFileUpload","event","fileType","file","target","files","filter","includes","formData","FormData","append","currentSheetData","hasSheetData","sheetDataLength","hasInstructions","instructionsLength","hasAnalysis","analysisLength","err","pdfInfo","processingMode","isFullText","successMessage","finally","shouldConvert","confirm","sheetUrl","spreadsheetUrl","open","handleGoogleSheetsUrl","excelInfo","loadAvailableSheets","handleSheetChange","newSheetName","analysisResult","reanalyzePdfWithSheetContext","pdfResponse","pdfBlob","blob","updatedPdfInfo","pickerCallback","action","google","picker","Action","PICKED","doc","docs","createPicker","developerKey","REACT_APP_GEMINI_API_KEY","clientId","REACT_APP_GOOGLE_CLIENT_ID","view","View","ViewId","SPREADSHEETS","setMimeTypes","PickerBuilder","setAppId","setOAuthToken","setDeveloperKey","addView","setCallback","build","setVisible","_valuesResponse$value","_formulasResponse$val","_valuesResponse$value2","_formulasResponse$val2","valuesResponse","formulasResponse","combinedData","formulaCount","flat","cell","stack","startNewChat","handleLogout","hasChanges","approveAllChanges","_googleSheetsUrl$matc","_availableSheets$find","s","rejectAllChanges","_googleSheetsUrl$matc2","_availableSheets$find2","undoAction","redoAction","sendMessage","currentQuestion","userMessage","extractedPdfData","extractedExcelData","conversationHistory","parts","currentResponse","isChangePlanResponse","planIdMatch","questionLower","toLowerCase","undoRedoKeywords","keyword","isError","saveAllChanges","children","sx","display","height","bgcolor","overflow","position","top","left","right","bottom","pointerEvents","zIndex","variant","width","flexShrink","boxSizing","borderRight","p","backgroundClip","WebkitBackgroundClip","WebkitTextFillColor","color","borderColor","alignItems","gap","mb","profilePicture","charAt","flex","email","onClick","size","fullWidth","flexGrow","onSessionSelect","flexDirection","justifyContent","flexWrap","minWidth","onChange","disabled","href","label","startIcon","textAlign","mt","placeholder","onKeyPress","key","ref","overscrollBehavior","touchAction","WebkitOverflowScrolling","onMouseEnter","onMouseLeave","style","backgroundColor","fontSize","cursor","userSelect","transition","textContent","opacity","gutterBottom","maxWidth","borderBottom","component","hidden","accept","whiteSpace","textOverflow","index","className","dangerouslySetInnerHTML","__html","px","toLocaleTimeString","hour","minute","borderTop","multiline","rows","newAnswers","direction","checked","shiftKey","minRows","maxRows","control","mr","autoHideDuration","onClose","anchorOrigin","vertical","horizontal","xs","sm","severity"],"sources":["/Users/naamasharir/Documents/personal/TLV500ModelAssistant/TLV500-Frontend/src/App.js"],"sourcesContent":["import React, { useState, useEffect, useRef } from 'react';\r\nimport {\r\n  Box,\r\n  Drawer,\r\n  Typography,\r\n  Paper,\r\n  TextField,\r\n  Button,\r\n  Avatar,\r\n  Divider,\r\n  Chip,\r\n  Fab,\r\n  useMediaQuery,\r\n  useTheme,\r\n  CircularProgress,\r\n  Alert,\r\n  Snackbar,\r\n  CssBaseline,\r\n  FormControl,\r\n  InputLabel,\r\n  Select,\r\n  MenuItem,\r\n  Switch,\r\n  FormControlLabel\r\n} from '@mui/material';\r\nimport {\r\n  Send,\r\n  Person,\r\n  Description,\r\n  TableChart,\r\n  Save\r\n} from '@mui/icons-material';\r\nimport { createTheme, ThemeProvider } from '@mui/material/styles';\r\nimport ChatHistory from './components/ChatHistory';\r\nimport './App.css';\r\n\r\n// API URL configuration\r\nconst API_URL = process.env.REACT_APP_API_URL || 'http://localhost:3001';\r\n\r\nconst theme = createTheme({\r\n  palette: {\r\n    mode: 'dark',\r\n    primary: { main: '#8B5CF6' },\r\n    secondary: { main: '#6366F1' },\r\n    background: { default: '#000000', paper: '#0A0A0A' },\r\n    text: { primary: '#FFFFFF', secondary: '#E5E7EB' },\r\n    success: { main: '#10B981' },\r\n    error: { main: '#EF4444' },\r\n    warning: { main: '#FFC107' }\r\n  },\r\n  typography: {\r\n    fontFamily: '\"Inter\", \"Roboto\", \"Helvetica\", \"Arial\", sans-serif',\r\n    h4: { fontWeight: 700 },\r\n    h6: { fontWeight: 600 }\r\n  },\r\n  components: {\r\n    MuiButton: {\r\n      styleOverrides: {\r\n        root: { borderRadius: 12, textTransform: 'none', fontWeight: 600, padding: '10px 20px' },\r\n        contained: {\r\n          boxShadow: '0 4px 20px rgba(139, 92, 246, 0.4)',\r\n          background: 'linear-gradient(135deg, #8B5CF6 0%, #6366F1 100%)',\r\n          '&:hover': {\r\n            transform: 'translateY(-1px)',\r\n            boxShadow: '0 6px 30px rgba(139, 92, 246, 0.6)',\r\n            background: 'linear-gradient(135deg, #A78BFA 0%, #818CF8 100%)',\r\n          }\r\n        },\r\n      },\r\n    },\r\n    MuiPaper: {\r\n      styleOverrides: {\r\n        root: {\r\n          background: 'rgba(20, 20, 20, 0.95)',\r\n          backdropFilter: 'blur(20px)',\r\n          border: '1px solid rgba(139, 92, 246, 0.3)',\r\n          borderRadius: 16,\r\n        },\r\n      },\r\n    },\r\n  },\r\n});\r\n\r\nconst drawerWidth = 280;\r\n\r\n// Function to handle mixed Hebrew-English text\r\nconst formatMixedText = (text) => {\r\n  if (!text) return text;\r\n  \r\n  // Simple regex to detect English words/phrases\r\n  const englishPattern = /([a-zA-Z0-9]+(?:\\s+[a-zA-Z0-9]+)*)/g;\r\n  \r\n  return text.replace(englishPattern, (match) => {\r\n    // If it's a common English term in Hebrew context, wrap it\r\n    return `<span class=\"english-term\" dir=\"ltr\">${match}</span>`;\r\n  });\r\n};\r\n\r\nfunction App() {\r\n  const muiTheme = useTheme();\r\n  const isMobile = useMediaQuery(muiTheme.breakpoints.down('md'));\r\n  \r\n  const [messages, setMessages] = useState([\r\n    { text: 'שלום! אני העוזר החכם TLV500. התחבר לחשבון Google ובחר גיליון כדי להתחיל.', sender: 'assistant', timestamp: new Date(), id: Date.now() }\r\n  ]);\r\n  const [question, setQuestion] = useState('');\r\n  const [fileName, setFileName] = useState('');\r\n  const [googleSheetsUrl, setGoogleSheetsUrl] = useState('');\r\n  const [changesCount, setChangesCount] = useState(0);\r\n  const [isSheetLoaded, setIsSheetLoaded] = useState(false);\r\n\r\n  const [isPickerReady, setIsPickerReady] = useState(false);\r\n  const [accessToken, setAccessToken] = useState('');\r\n  const [sheetsMetadata, setSheetsMetadata] = useState('');\r\n  const [authError, setAuthError] = useState('');\r\n  const [showSnackbar, setShowSnackbar] = useState(false);\r\n  const [snackbarMessage, setSnackbarMessage] = useState('');\r\n  const [availableSheets, setAvailableSheets] = useState([]);\r\n  const [selectedSheetName, setSelectedSheetName] = useState('');\r\n  const [isLoadingSheets, setIsLoadingSheets] = useState(false);\r\n  const [extractedPdf, setExtractedPdf] = useState(null);\r\n  const [isExtractingData, setIsExtractingData] = useState(false);\r\n  const [extractedExcel, setExtractedExcel] = useState(null);\r\n  const [isExtractingExcel, setIsExtractingExcel] = useState(false);\r\n  const [isAgentMode, setIsAgentMode] = useState(false);\r\n  const [isStreamingResponse, setIsStreamingResponse] = useState(false);\r\n  const [isSheetSelected, setIsSheetSelected] = useState(false);\r\n  const [isIframeHovered, setIsIframeHovered] = useState(false);\r\n  \r\n  // 🔄 Undo/Redo State\r\n  const [canUndo, setCanUndo] = useState(false);\r\n  const [canRedo, setCanRedo] = useState(false);\r\n  const [hasGreenCells, setHasGreenCells] = useState(false);\r\n  const [isCheckingGreenCells, setIsCheckingGreenCells] = useState(false);\r\n  \r\n  // Chat History Management\r\n  const [currentSessionId, setCurrentSessionId] = useState(null);\r\n  const [user, setUser] = useState(null);\r\n  \r\n  const chatEndRef = useRef(null);\r\n  const iframeContainerRef = useRef(null);\r\n\r\n  // 🔥 State חדש לניתוח הגליון עם Gemini\r\n  const [sheetAnalysis, setSheetAnalysis] = useState(null);\r\n  const [sheetInstructions, setSheetInstructions] = useState(null);\r\n  \r\n  // 🔥 State חדש לתוכניות שינויים מורכבות\r\n  const [pendingChangePlan, setPendingChangePlan] = useState(null);\r\n  const [clarificationAnswers, setClarificationAnswers] = useState(['', '', '', '', '']);\r\n  const [isAnsweringQuestions, setIsAnsweringQuestions] = useState(false);\r\n  \r\n  // 🎚️ State חדש לבחירת מצב שינוי משמעותי\r\n  const [isSignificantChange, setIsSignificantChange] = useState(false);\r\n  \r\n  // 🔑 Session ID for backend session storage\r\n  const [sessionId, setSessionId] = useState(() => {\r\n    return Date.now().toString() + '_' + Math.random().toString(36).substring(2, 15);\r\n  });\r\n\r\n  // Helper function to extract questions from change plan response\r\n  const extractQuestionsFromResponse = (response) => {\r\n    console.log('Extracting questions from response:', response);\r\n    const questionSection = response.split('🤔 שאלות הבהרה')[1];\r\n    if (!questionSection) {\r\n      console.log('No question section found');\r\n      return [];\r\n    }\r\n    \r\n    console.log('Question section found:', questionSection);\r\n    \r\n    const questions = [];\r\n    // Pattern matches \"**1.** question text\"\r\n    const questionMatches = questionSection.match(/\\*\\*\\d+\\.\\*\\*\\s*([^\\n*]+)/g);\r\n    \r\n    if (questionMatches) {\r\n      console.log('Raw question matches:', questionMatches);\r\n      questionMatches.forEach(match => {\r\n        const question = match.replace(/\\*\\*\\d+\\.\\*\\*\\s*/, '').trim();\r\n        if (question && question.length > 5) {\r\n          questions.push(question);\r\n        }\r\n      });\r\n    } else {\r\n      console.log('No question matches found, trying alternative pattern');\r\n      // Alternative: look for lines that start with numbers\r\n      const lines = questionSection.split('\\n');\r\n      for (let line of lines) {\r\n        line = line.trim();\r\n        if (line.match(/^\\*\\*\\d+\\.\\*\\*/)) {\r\n          const question = line.replace(/^\\*\\*\\d+\\.\\*\\*\\s*/, '').trim();\r\n          if (question && question.length > 5) {\r\n            questions.push(question);\r\n          }\r\n        }\r\n      }\r\n    }\r\n    \r\n    console.log('Frontend extracted questions:', questions);\r\n    return questions.slice(0, 5); // Ensure max 5 questions\r\n  };\r\n\r\n  // Function to execute change plan with clarification answers\r\n  const executeChangePlan = async () => {\r\n    if (!pendingChangePlan || clarificationAnswers.some(answer => !answer.trim())) {\r\n      setSnackbarMessage('❌ יש לענות על כל 5 השאלות');\r\n      setShowSnackbar(true);\r\n      return;\r\n    }\r\n\r\n    setIsStreamingResponse(true);\r\n    const loadingMessageId = Date.now();\r\n    setMessages(prev => [...prev, { \r\n      text: '', \r\n      sender: 'assistant', \r\n      isLoading: true, \r\n      timestamp: new Date(), \r\n      id: loadingMessageId \r\n    }]);\r\n\r\n    try {\r\n      const sheetData = (isSheetLoaded && isSheetSelected) ? \r\n        await getSheetData(extractSpreadsheetId(googleSheetsUrl), selectedSheetName) : null;\r\n      const spreadsheetId = isSheetLoaded ? extractSpreadsheetId(googleSheetsUrl) : null;\r\n\r\n      const payload = {\r\n        planId: pendingChangePlan.id,\r\n        clarificationAnswers: clarificationAnswers,\r\n        spreadsheetId: spreadsheetId,\r\n        accessToken: accessToken,\r\n        sheetsMetadata: sheetsMetadata,\r\n        selectedSheetName: selectedSheetName\r\n      };\r\n\r\n      const response = await fetch(`${API_URL}/api/execute-change-plan`, {\r\n        method: 'POST',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        credentials: 'include',\r\n        body: JSON.stringify(payload),\r\n      });\r\n\r\n      if (!response.ok) {\r\n        const errorText = await response.text();\r\n        throw new Error(`Server error: ${response.status} ${errorText}`);\r\n      }\r\n\r\n      const reader = response.body.getReader();\r\n      const decoder = new TextDecoder();\r\n      let accumulatedResponse = '';\r\n\r\n      while (true) {\r\n        const { value, done } = await reader.read();\r\n        if (done) break;\r\n        \r\n        accumulatedResponse += decoder.decode(value, { stream: true });\r\n\r\n        setMessages(prev => prev.map(m => {\r\n          if (m.id === loadingMessageId) {\r\n            return { ...m, text: accumulatedResponse, isLoading: true };\r\n          }\r\n          return m;\r\n        }));\r\n      }\r\n\r\n      // Final processing\r\n      setMessages(prev => prev.map(m =>\r\n        m.id === loadingMessageId\r\n        ? { ...m, text: accumulatedResponse, isLoading: false }\r\n        : m\r\n      ));\r\n\r\n      // Reset change plan state\r\n      setPendingChangePlan(null);\r\n      setIsAnsweringQuestions(false);\r\n      setClarificationAnswers(['', '', '', '', '']);\r\n\r\n      // Refresh the sheet if needed\r\n      if (googleSheetsUrl && selectedSheetName) {\r\n        setTimeout(() => {\r\n          const iframe = document.querySelector('iframe[title=\"Google Sheets\"]');\r\n          if (iframe) {\r\n            iframe.src = iframe.src;\r\n          }\r\n        }, 1000);\r\n      }\r\n\r\n    } catch (error) {\r\n      console.error('Error executing change plan:', error);\r\n      setMessages(prev => prev.map(m =>\r\n        m.id === loadingMessageId\r\n        ? { ...m, text: `❌ שגיאה בביצוע התוכנית: ${error.message}`, isLoading: false }\r\n        : m\r\n      ));\r\n    } finally {\r\n      setIsStreamingResponse(false);\r\n    }\r\n  };\r\n\r\n  useEffect(() => {\r\n    // Load saved access token ONLY - no chat messages from localStorage\r\n    const savedToken = localStorage.getItem('accessToken');\r\n    if (savedToken) {\r\n      setAccessToken(savedToken);\r\n    }\r\n\r\n    // Only load PDF/Excel data from localStorage (temporary files, not chat history)\r\n    const savedPdfJson = localStorage.getItem('extractedPdf');\r\n    if (savedPdfJson) {\r\n      try {\r\n        const savedPdf = JSON.parse(savedPdfJson);\r\n        if (savedPdf && savedPdf.name && savedPdf.data) {\r\n          // Check if PDF still exists on server if it has a fileId\r\n          if (savedPdf.fileId) {\r\n            fetch(`${API_URL}/api/download-pdf/${savedPdf.fileId}`, {\r\n              method: 'HEAD',\r\n              credentials: 'include'\r\n            }).then(response => {\r\n              if (response.ok) {\r\n                setExtractedPdf(savedPdf);\r\n                setMessages(prev => [...prev, { text: `📄 נתונים קודמים שחולצו מ-PDF \"${savedPdf.name}\" נטענו.`, sender: 'system', timestamp: new Date(), id: Date.now() }]);\r\n              } else {\r\n                // PDF no longer exists on server\r\n                console.log('📄 PDF from localStorage no longer exists on server, removing...');\r\n                localStorage.removeItem('extractedPdf');\r\n              }\r\n            }).catch(() => {\r\n              // Error checking PDF, remove from localStorage\r\n              localStorage.removeItem('extractedPdf');\r\n            });\r\n          } else {\r\n            // Old PDF without fileId, just load it\r\n            setExtractedPdf(savedPdf);\r\n            setMessages(prev => [...prev, { text: `📄 נתונים קודמים שחולצו מ-PDF \"${savedPdf.name}\" נטענו.`, sender: 'system', timestamp: new Date(), id: Date.now() }]);\r\n          }\r\n        }\r\n      } catch (e) {\r\n        console.error('Failed to parse extracted PDF data from localStorage', e);\r\n        localStorage.removeItem('extractedPdf');\r\n      }\r\n    }\r\n\r\n    const savedExcelJson = localStorage.getItem('extractedExcel');\r\n    if (savedExcelJson) {\r\n        try {\r\n            const savedExcel = JSON.parse(savedExcelJson);\r\n            if (savedExcel && savedExcel.name && savedExcel.data) {\r\n                setExtractedExcel(savedExcel);\r\n                setMessages(prev => [...prev, { text: `📊 נתונים קודמים שחולצו מ-Excel \"${savedExcel.name}\" נטענו.`, sender: 'system', timestamp: new Date(), id: Date.now() }]);\r\n            }\r\n        } catch (e) {\r\n            console.error('Failed to parse extracted Excel data from localStorage', e);\r\n            localStorage.removeItem('extractedExcel');\r\n        }\r\n    }\r\n  }, []);\r\n\r\n  // Fetch user info when access token is available\r\n  useEffect(() => {\r\n    if (accessToken) {\r\n      fetchUserInfo();\r\n    }\r\n  }, [accessToken]);\r\n\r\n  useEffect(() => {\r\n    const params = new URLSearchParams(window.location.search);\r\n    const token = params.get('token');\r\n    if (token) {\r\n      setAccessToken(token);\r\n      localStorage.setItem('accessToken', token);\r\n      setSnackbarMessage('התחברת בהצלחה!');\r\n      setShowSnackbar(true);\r\n      window.history.replaceState({}, document.title, \"/\");\r\n    } else {\r\n      // Check if user is already authenticated\r\n      checkAuthStatus();\r\n    }\r\n  }, []);\r\n\r\n  const checkAuthStatus = async () => {\r\n    try {\r\n      const response = await fetch(`${API_URL}/api/user`, {\r\n        credentials: 'include'\r\n      });\r\n      \r\n      if (response.ok) {\r\n        const data = await response.json();\r\n        setUser(data.user);\r\n        if (data.accessToken) {\r\n          setAccessToken(data.accessToken);\r\n          localStorage.setItem('accessToken', data.accessToken);\r\n        }\r\n        setSnackbarMessage('ברוך הבא בחזרה!');\r\n        setShowSnackbar(true);\r\n      }\r\n    } catch (error) {\r\n      console.log('Not authenticated:', error);\r\n      // User is not authenticated, show login button\r\n    }\r\n  };\r\n\r\n  useEffect(() => {\r\n    chatEndRef.current?.scrollIntoView({ behavior: \"smooth\" });\r\n  }, [messages]);\r\n\r\n  useEffect(() => {\r\n    const script = document.createElement('script');\r\n    script.src = 'https://apis.google.com/js/api.js';\r\n    script.onload = () => window.gapi.load('picker', { 'callback': () => setIsPickerReady(true) });\r\n    document.head.appendChild(script);\r\n  }, []);\r\n\r\n  // ניהול גלילה עבור iframe - הגנה מיוחדת על Mac gestures\r\n  useEffect(() => {\r\n    const handleWheel = (e) => {\r\n      if (isIframeHovered) {\r\n        // הגנה ספציפית על horizontal scrolling במאק\r\n        if (Math.abs(e.deltaX) > Math.abs(e.deltaY)) {\r\n          // זה גלילה אופקית - בלוק את הnavigation gesture\r\n          e.preventDefault();\r\n          e.stopPropagation();\r\n        }\r\n      }\r\n    };\r\n\r\n    const handleTouchStart = (e) => {\r\n      if (isIframeHovered) {\r\n        e.stopPropagation();\r\n      }\r\n    };\r\n\r\n    const handleTouchMove = (e) => {\r\n      if (isIframeHovered) {\r\n        e.stopPropagation();\r\n      }\r\n    };\r\n\r\n    // הוסף event listeners עם focus על gestures\r\n    document.addEventListener('wheel', handleWheel, { passive: false });\r\n    document.addEventListener('touchstart', handleTouchStart, { passive: false });\r\n    document.addEventListener('touchmove', handleTouchMove, { passive: false });\r\n\r\n    return () => {\r\n      document.removeEventListener('wheel', handleWheel);\r\n      document.removeEventListener('touchstart', handleTouchStart);\r\n      document.removeEventListener('touchmove', handleTouchMove);\r\n    };\r\n  }, [isIframeHovered]);\r\n\r\n  // בדיקת סטטוס אוטומטית כשגליון נבחר\r\n  useEffect(() => {\r\n    if (isSheetSelected && selectedSheetName && currentSessionId) {\r\n      // Auto-check status when sheet is selected\r\n      // בדיקה אוטומטית אחרי טעינת הגליון\r\n      const timer = setTimeout(() => {\r\n        checkUndoRedoStatus();\r\n        checkForGreenCells();\r\n      }, 2000);\r\n      \r\n      return () => clearTimeout(timer);\r\n    }\r\n  }, [selectedSheetName, isSheetSelected, currentSessionId]);\r\n\r\n  const fetchUserInfo = async () => {\r\n    try {\r\n      const response = await fetch(`${API_URL}/api/user`, {\r\n        credentials: 'include'\r\n      });\r\n      \r\n      if (response.ok) {\r\n        const data = await response.json();\r\n        setUser(data.user);\r\n      }\r\n    } catch (error) {\r\n      console.error('Error fetching user info:', error);\r\n    }\r\n  };\r\n\r\n  const handleSessionSelect = async (sessionId) => {\r\n    if (!sessionId) {\r\n      setCurrentSessionId(null);\r\n      setMessages([{ text: 'שלום! אני העוזר החכם TLV500. התחבר לחשבון Google ובחר גיליון כדי להתחיל.', sender: 'assistant', timestamp: new Date(), id: Date.now() }]);\r\n      return;\r\n    }\r\n\r\n    setCurrentSessionId(sessionId);\r\n    \r\n    try {\r\n      const response = await fetch(`${API_URL}/api/chat/session/${sessionId}`, {\r\n        credentials: 'include'\r\n      });\r\n      \r\n      if (response.ok) {\r\n        const chatHistory = await response.json();\r\n        const loadedMessages = chatHistory.messages.map(msg => ({\r\n          text: msg.content,\r\n          sender: msg.role === 'user' ? 'user' : 'assistant',\r\n          timestamp: new Date(msg.timestamp),\r\n          id: msg._id || Date.now() + Math.random()\r\n        }));\r\n        \r\n        setMessages(loadedMessages);\r\n        // Chat history loaded\r\n      }\r\n    } catch (error) {\r\n      console.error('Error loading chat session:', error);\r\n      setSnackbarMessage('שגיאה בטעינת השיחה');\r\n      setShowSnackbar(true);\r\n    }\r\n  };\r\n\r\n  const generateSessionId = () => {\r\n    return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);\r\n  };\r\n\r\n\r\n\r\n\r\n  \r\n  const makeGoogleSheetsAPICall = async (spreadsheetId, range, values = null, method = 'GET', valueRenderOption = 'FORMATTED_VALUE') => {\r\n    if (!accessToken) throw new Error('No access token available. Please log in.');\r\n    const baseUrl = `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}`;\r\n    try {\r\n      let url, options;\r\n      if (method === 'GET') {\r\n        // 🔥 הוסף את valueRenderOption לקריאות GET\r\n        const params = new URLSearchParams({ valueRenderOption });\r\n        url = `${baseUrl}/values/${range}?${params}`;\r\n        console.log('🔥 Google Sheets API call:', url);\r\n        options = { method, headers: { 'Authorization': `Bearer ${accessToken}`, 'Content-Type': 'application/json' }};\r\n      } else {\r\n        url = `${baseUrl}/values/${range}?valueInputOption=RAW`;\r\n        options = { method, headers: { 'Authorization': `Bearer ${accessToken}`, 'Content-Type': 'application/json' }, body: JSON.stringify({ values }) };\r\n      }\r\n      const response = await fetch(url, options);\r\n      const data = await response.json();\r\n      if (!response.ok) throw new Error(data.error?.message || 'API call failed');\r\n      return data;\r\n    } catch (error) {\r\n      console.error('Google Sheets API error:', error);\r\n      throw error;\r\n    }\r\n  };\r\n\r\n  // 🔥 פונקציה חדשה לשילוב ערכים ונוסחאות\r\n  const combineValuesAndFormulas = (values, formulas) => {\r\n    const combined = [];\r\n    \r\n    console.log('🔥 Starting combineValuesAndFormulas...');\r\n    console.log('📊 Values:', values?.length || 0, 'rows');\r\n    console.log('📋 Formulas:', formulas?.length || 0, 'rows');\r\n    \r\n    for (let row = 0; row < Math.max(values.length, formulas.length); row++) {\r\n      const valueRow = values[row] || [];\r\n      const formulaRow = formulas[row] || [];\r\n      const combinedRow = [];\r\n      \r\n      for (let col = 0; col < Math.max(valueRow.length, formulaRow.length); col++) {\r\n        const value = valueRow[col] || '';\r\n        const formula = formulaRow[col] || '';\r\n        \r\n        // 🔥 לוג לבדיקה (רק לשורה ראשונה)\r\n        if (row === 0 && col < 3) {\r\n          console.log(`Cell [${row},${col}]: value=\"${value}\" (${typeof value}), formula=\"${formula}\" (${typeof formula})`);\r\n        }\r\n        \r\n        // 🔥 תיקון: בדוק שזה string ומתחיל ב-= לפני שמגדירים כנוסחה\r\n        if (typeof formula === 'string' && formula.length > 0 && formula.startsWith('=')) {\r\n          // זו נוסחה אמיתית\r\n          combinedRow.push({\r\n            value: value,\r\n            formula: formula,\r\n            type: 'formula'\r\n          });\r\n        } else {\r\n          // זה ערך רגיל (לא נוסחה) - קח את הערך או את מה שיש בformula אם הערך ריק\r\n          const finalValue = value !== '' ? value : (formula !== '' ? formula : '');\r\n          combinedRow.push({\r\n            value: finalValue,\r\n            type: 'literal'\r\n          });\r\n        }\r\n      }\r\n      combined.push(combinedRow);\r\n    }\r\n    \r\n    console.log('🔥 Combined values and formulas:', combined.slice(0, 2)); // רק 2 שורות ראשונות\r\n    return combined;\r\n  };\r\n\r\n  // 🔥 פונקציה חדשה לניתוח הגליון עם Gemini\r\n  const analyzeSheetWithGemini = async (sheetData, sheetName, currentExtractedPdf = null) => {\r\n    try {\r\n      setMessages(prev => [...prev, { \r\n        text: `🔍 מנתח את מבנה הגליון \"${sheetName}\" עם AI...`, \r\n        sender: 'system', \r\n        timestamp: new Date(), \r\n        id: Date.now() \r\n      }]);\r\n\r\n      const payload = {\r\n        sheetData: sheetData,\r\n        sheetName: sheetName,\r\n        sessionId: sessionId,\r\n        analysisType: 'initial_analysis'\r\n      };\r\n\r\n      const response = await fetch(`${API_URL}/api/analyze-sheet`, {\r\n        method: 'POST',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        credentials: 'include',\r\n        body: JSON.stringify(payload),\r\n      });\r\n\r\n      if (!response.ok) {\r\n        throw new Error(`HTTP error! status: ${response.status}`);\r\n      }\r\n\r\n      const result = await response.json();\r\n      \r\n      // שמור את התוצאות\r\n      setSheetAnalysis(result.summary);\r\n      setSheetInstructions(result.instructions); // שמור את ההוראות שחזרו מהבקאנד\r\n\r\n      // הצג את הסיכום למשתמש\r\n      setMessages(prev => [...prev, { \r\n        text: `📊 ניתוח הגליון:\\n${result.summary}`, \r\n        sender: 'assistant', \r\n        timestamp: new Date(), \r\n        id: Date.now() \r\n      }]);\r\n\r\n      console.log('🔥 Sheet analysis completed:', result);\r\n      console.log('📝 Sheet summary saved:', result.summary?.length, 'characters');\r\n      console.log('📋 Sheet instructions saved:', result.instructions?.length, 'characters');\r\n\r\n      // הודעה קצרה שההוראות נשמרו\r\n      setTimeout(() => {\r\n        setMessages(prev => [...prev, { \r\n          text: `✅ הוראות עבודה מפורטות נשמרו למערכת עבור שיחות עתידיות`, \r\n          sender: 'system', \r\n          timestamp: new Date(), \r\n          id: Date.now() \r\n        }]);\r\n      }, 1000);\r\n\r\n      // Return the analysis results for use in handleSheetChange\r\n      return {\r\n        instructions: result.instructions,\r\n        summary: result.summary\r\n      };\r\n\r\n    } catch (error) {\r\n      console.error('Error analyzing sheet:', error);\r\n      setMessages(prev => [...prev, { \r\n        text: `❌ שגיאה בניתוח הגליון: ${error.message}`, \r\n        sender: 'system', \r\n        timestamp: new Date(), \r\n        id: Date.now() \r\n      }]);\r\n    }\r\n  };\r\n\r\n  const extractSpreadsheetId = (url) => {\r\n    const match = url.match(/\\/spreadsheets\\/d\\/([a-zA-Z0-9-_]+)/);\r\n    return match ? match[1] : null;\r\n  };\r\n  \r\n  // פונקציה ליצור URL עם הגליון הנכון\r\n  const getSheetUrlWithGid = (baseUrl, sheetName) => {\r\n    if (!sheetName || !sheetsMetadata) return baseUrl;\r\n    \r\n    const selectedSheet = sheetsMetadata.find(sheet => sheet.name === sheetName);\r\n    if (!selectedSheet) return baseUrl;\r\n    \r\n    // הסר כל gid קיים מה-URL\r\n    const cleanUrl = baseUrl.split('#')[0];\r\n    \r\n    // הוסף את ה-gid החדש\r\n    return `${cleanUrl}#gid=${selectedSheet.id}`;\r\n  };\r\n\r\n  const getSpreadsheetMetadata = async (spreadsheetId) => {\r\n    if (!accessToken) return [];\r\n    try {\r\n      const url = `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}`;\r\n      const response = await fetch(url, { headers: { 'Authorization': `Bearer ${accessToken}` } });\r\n      if (!response.ok) throw new Error('Failed to fetch spreadsheet metadata');\r\n      const metadata = await response.json();\r\n      return metadata.sheets.map(sheet => ({ name: sheet.properties.title, id: sheet.properties.sheetId }));\r\n    } catch (error) {\r\n      console.error('Error fetching spreadsheet metadata:', error);\r\n      return [];\r\n    }\r\n  };\r\n\r\n  const handleFileUpload = async (event, fileType) => {\r\n    const file = event.target.files[0];\r\n    if (!file) return;\r\n\r\n    if (file.type === 'application/pdf') {\r\n        // Clean all previous PDF-related state\r\n        setExtractedPdf(null);\r\n        localStorage.removeItem('extractedPdf');\r\n        setIsExtractingData(true);\r\n        \r\n        // Remove any previous PDF-related messages\r\n        setMessages(prev => prev.filter(msg => \r\n            !msg.text.includes('נתונים חולצו') && \r\n            !msg.text.includes('שגיאה בחילוץ') &&\r\n            !msg.text.includes('נתוני ה-PDF נוקו')\r\n        ));\r\n        \r\n        setMessages(prev => [...prev, { text: `⏳ מחלץ נתונים מקובץ \"${file.name}\"...`, sender: 'system', timestamp: new Date(), id: Date.now() }]);\r\n        \r\n        const formData = new FormData();\r\n        formData.append('pdf', file);\r\n        \r\n        // 🔥 אם יש גליון טעון, שלוף את הנתונים ושלח אותם\r\n        if (isSheetLoaded && isSheetSelected) {\r\n          const currentSheetData = await getSheetData(\r\n            extractSpreadsheetId(googleSheetsUrl), \r\n            selectedSheetName\r\n          );\r\n          \r\n          if (currentSheetData) {\r\n            formData.append('sheetData', JSON.stringify(currentSheetData));\r\n          }\r\n          if (sheetInstructions) {\r\n            formData.append('sheetInstructions', sheetInstructions);\r\n          }\r\n          if (sheetAnalysis) {\r\n            formData.append('sheetAnalysis', sheetAnalysis);\r\n          }\r\n          if (selectedSheetName) {\r\n            formData.append('sheetName', selectedSheetName);\r\n          }\r\n          \r\n          console.log('🔥 Sending PDF with full sheet context:', {\r\n            hasSheetData: !!currentSheetData,\r\n            sheetDataLength: currentSheetData ? currentSheetData.length : 0,\r\n            hasInstructions: !!sheetInstructions,\r\n            instructionsLength: sheetInstructions ? sheetInstructions.length : 0,\r\n            hasAnalysis: !!sheetAnalysis,\r\n            analysisLength: sheetAnalysis ? sheetAnalysis.length : 0,\r\n            sheetName: selectedSheetName\r\n          });\r\n        } else {\r\n          console.log('🔥 Sending PDF without sheet context (simple OCR mode)');\r\n        }\r\n\r\n        fetch(`${API_URL}/api/extract-pdf-data`, {\r\n            method: 'POST', \r\n            body: formData,\r\n            credentials: 'include'\r\n        })\r\n        .then(response => {\r\n            if (!response.ok) {\r\n                return response.json().then(err => { throw new Error(err.error || 'Failed to extract data') });\r\n            }\r\n            return response.json();\r\n        })\r\n        .then(result => {\r\n            const pdfInfo = { \r\n                name: file.name, \r\n                data: result,\r\n                fileId: result.fileId, // שמירת fileId לפתיחה עתידית\r\n                processingMode: result.processingMode || 'structured', // track processing mode\r\n                isFullText: result.isFullText || false // track if this is full text\r\n            };\r\n            setExtractedPdf(pdfInfo);\r\n            localStorage.setItem('extractedPdf', JSON.stringify(pdfInfo));\r\n            setMessages(prev => prev.filter(msg => !msg.text.includes('⏳ מחלץ נתונים')));\r\n            \r\n            // Different success messages based on processing mode\r\n            let successMessage;\r\n            if (result.processingMode === 'simple_ocr') {\r\n                successMessage = `✅ טקסט חולץ מ-\"${file.name}\". ניתן לשאול שאלות על התוכן. טען גיליון לניתוח מפורט.`;\r\n            } else {\r\n                successMessage = result.fileId \r\n                    ? `✅ נתונים חולצו בהצלחה מ-\"${file.name}\". כעת ניתן לשאול שאלות על הקובץ או לחזור לקובץ המקורי.`\r\n                    : `✅ נתונים חולצו בהצלחה מ-\"${file.name}\". כעת ניתן לשאול שאלות על הקובץ.`;\r\n            }\r\n            \r\n            setMessages(prev => [...prev, { text: successMessage, sender: 'system', timestamp: new Date(), id: Date.now() }]);\r\n        })\r\n        .catch(error => {\r\n            console.error('PDF data extraction failed:', error);\r\n            setMessages(prev => prev.filter(msg => !msg.text.includes('⏳ מחלץ נתונים')));\r\n            setMessages(prev => [...prev, { text: `❌ שגיאה בחילוץ נתונים מ-\"${file.name}\": ${error.message}`, sender: 'system', timestamp: new Date(), id: Date.now() }]);\r\n        })\r\n        .finally(() => {\r\n            setIsExtractingData(false);\r\n        });\r\n    } else if (fileType === 'Excel') {\r\n        // Ask user if they want to convert to Google Sheets\r\n        const shouldConvert = window.confirm(\r\n            `האם ברצונך להמיר את קובץ ה-Excel \"${file.name}\" ל-Google Sheets?\\n\\n` +\r\n            `כן - העלאה ל-Google Drive והמרה ל-Google Sheets\\n` +\r\n            `לא - חילוץ נתונים מקומי בלבד`\r\n        );\r\n\r\n        if (shouldConvert) {\r\n            // Convert to Google Sheets\r\n            setIsExtractingExcel(true);\r\n            \r\n            setMessages(prev => prev.filter(msg =>\r\n                !msg.text.includes('ממיר') &&\r\n                !msg.text.includes('Google Sheets') &&\r\n                !msg.text.includes('שגיאה בהמרה')\r\n            ));\r\n            \r\n            setMessages(prev => [...prev, {\r\n                text: `🔄 ממיר את \"${file.name}\" ל-Google Sheets...`,\r\n                sender: 'system',\r\n                timestamp: new Date(),\r\n                id: Date.now()\r\n            }]);\r\n            \r\n            const formData = new FormData();\r\n            formData.append('excel', file);\r\n\r\n            fetch(`${API_URL}/api/excel-to-sheets`, {\r\n                method: 'POST',\r\n                body: formData,\r\n                credentials: 'include'\r\n            })\r\n            .then(response => {\r\n                if (!response.ok) {\r\n                    return response.json().then(err => {\r\n                        throw new Error(err.error || 'Failed to convert Excel to Google Sheets')\r\n                    });\r\n                }\r\n                return response.json();\r\n            })\r\n            .then(result => {\r\n                setMessages(prev => prev.filter(msg => !msg.text.includes('🔄 ממיר')));\r\n                setMessages(prev => [...prev, {\r\n                    text: `✅ הקובץ \"${file.name}\" הומר בהצלחה ל-Google Sheets ונשמר בתיקיית \"TLV500-AI\"!`,\r\n                    sender: 'system',\r\n                    timestamp: new Date(),\r\n                    id: Date.now()\r\n                }]);\r\n                \r\n                // Open the created Google Sheet in a new tab\r\n                const sheetUrl = result.spreadsheetUrl || result.url;\r\n                if (sheetUrl) {\r\n                    window.open(sheetUrl, '_blank');\r\n                    setMessages(prev => [...prev, {\r\n                        text: `📊 Google Sheets נפתח בכרטיסייה חדשה`,\r\n                        sender: 'system',\r\n                        timestamp: new Date(),\r\n                        id: Date.now()\r\n                    }]);\r\n                    \r\n                    // Optionally, also load it in the current interface\r\n                    handleGoogleSheetsUrl(sheetUrl);\r\n                }\r\n            })\r\n            .catch(error => {\r\n                console.error('Excel to Google Sheets conversion failed:', error);\r\n                setMessages(prev => prev.filter(msg => !msg.text.includes('🔄 ממיר')));\r\n                setMessages(prev => [...prev, {\r\n                    text: `❌ שגיאה בהמרה ל-Google Sheets: ${error.message}`,\r\n                    sender: 'system',\r\n                    timestamp: new Date(),\r\n                    id: Date.now()\r\n                }]);\r\n            })\r\n            .finally(() => {\r\n                setIsExtractingExcel(false);\r\n            });\r\n        } else {\r\n            // Original local extraction logic\r\n            setExtractedExcel(null);\r\n            localStorage.removeItem('extractedExcel');\r\n            setIsExtractingExcel(true);\r\n            \r\n            setMessages(prev => prev.filter(msg =>\r\n                !msg.text.includes('חולצו מ-Excel') &&\r\n                !msg.text.includes('שגיאה בחילוץ Excel') &&\r\n                !msg.text.includes('נתוני ה-Excel נוקו')\r\n            ));\r\n            \r\n            setMessages(prev => [...prev, {\r\n                text: `⏳ מחלץ נתונים מקובץ Excel \"${file.name}\"...`,\r\n                sender: 'system',\r\n                timestamp: new Date(),\r\n                id: Date.now()\r\n            }]);\r\n            \r\n            const formData = new FormData();\r\n            formData.append('excel', file);\r\n\r\n            fetch(`${API_URL}/api/extract-excel-data`, {\r\n                method: 'POST',\r\n                body: formData\r\n            })\r\n            .then(response => {\r\n                if (!response.ok) {\r\n                    return response.json().then(err => {\r\n                        throw new Error(err.error || 'Failed to extract Excel data')\r\n                    });\r\n                }\r\n                return response.json();\r\n            })\r\n            .then(result => {\r\n                const excelInfo = { name: file.name, data: result.data };\r\n                setExtractedExcel(excelInfo);\r\n                localStorage.setItem('extractedExcel', JSON.stringify(excelInfo));\r\n                setMessages(prev => prev.filter(msg => !msg.text.includes('⏳ מחלץ נתונים מקובץ Excel')));\r\n                setMessages(prev => [...prev, {\r\n                    text: `✅ נתונים חולצו בהצלחה מ-Excel \"${file.name}\".`,\r\n                    sender: 'system',\r\n                    timestamp: new Date(),\r\n                    id: Date.now()\r\n                }]);\r\n            })\r\n            .catch(error => {\r\n                console.error('Excel data extraction failed:', error);\r\n                setMessages(prev => prev.filter(msg => !msg.text.includes('⏳ מחלץ נתונים מקובץ Excel')));\r\n                setMessages(prev => [...prev, {\r\n                    text: `❌ שגיאה בחילוץ נתוני Excel: ${error.message}`,\r\n                    sender: 'system',\r\n                    timestamp: new Date(),\r\n                    id: Date.now()\r\n                }]);\r\n            })\r\n            .finally(() => {\r\n                setIsExtractingExcel(false);\r\n            });\r\n        }\r\n    }\r\n  };\r\n\r\n  const loadAvailableSheets = async (spreadsheetId) => {\r\n    setIsLoadingSheets(true);\r\n    setIsSheetSelected(false); // Reset selection\r\n    setSelectedSheetName(''); // Clear any previous selection\r\n    try {\r\n      const sheets = await getSpreadsheetMetadata(spreadsheetId);\r\n      setAvailableSheets(sheets);\r\n      setSheetsMetadata(sheets);\r\n      // רק הודעה שהגליונות נטענו - בלי לבחור גליון אוטומטית\r\n      if (sheets.length > 0) {\r\n        setMessages(prev => [...prev, { \r\n          text: `📋 נמצאו ${sheets.length} גליונות - בחר גליון כדי להתחיל`, \r\n          sender: 'system', \r\n          timestamp: new Date(), \r\n          id: Date.now() \r\n        }]);\r\n      }\r\n    } finally {\r\n      setIsLoadingSheets(false);\r\n    }\r\n  };\r\n\r\n  const handleGoogleSheetsUrl = async (url) => {\r\n    setGoogleSheetsUrl(url);\r\n    setIsSheetLoaded(true);\r\n    setIsSheetSelected(false); // Reset sheet selection for new spreadsheet\r\n    setIsAgentMode(false); // Reset agent mode for new spreadsheet\r\n    const spreadsheetId = extractSpreadsheetId(url);\r\n    if (spreadsheetId && accessToken) await loadAvailableSheets(spreadsheetId);\r\n  };\r\n  \r\n  const handleSheetChange = async (newSheetName) => {\r\n    if (newSheetName === selectedSheetName) return;\r\n    \r\n    setSelectedSheetName(newSheetName);\r\n    setIsSheetSelected(true); // מסמן שנבחר גליון\r\n    \r\n    const spreadsheetId = extractSpreadsheetId(googleSheetsUrl);\r\n    if (spreadsheetId) {\r\n      // 🔥 שלוף נתוני גליון עם ערכים ונוסחאות\r\n      const sheetData = await getSheetData(spreadsheetId, newSheetName);\r\n      \r\n      setMessages(prev => [...prev, { \r\n        text: `✅ מחובר לגליון: ${newSheetName}`, \r\n        sender: 'system', \r\n        timestamp: new Date(), \r\n        id: Date.now() \r\n      }]);\r\n\r\n      // 🔥 נתח את הגליון עם Gemini\r\n      if (sheetData) {\r\n        const analysisResult = await analyzeSheetWithGemini(sheetData, newSheetName, extractedPdf);\r\n        \r\n        // 🔥 Reanalyze PDF if it exists and is in simple OCR mode\r\n        if (extractedPdf && extractedPdf.processingMode === 'simple_ocr' && analysisResult) {\r\n          console.log('🔄 PDF found in simple_ocr mode, triggering reanalysis with sheet context...');\r\n          await reanalyzePdfWithSheetContext(sheetData, analysisResult.instructions, analysisResult.summary, newSheetName);\r\n        }\r\n      }\r\n    }\r\n  };\r\n\r\n  // 🔥 Function to reanalyze PDF when sheet context becomes available\r\n  const reanalyzePdfWithSheetContext = async (sheetData, sheetInstructions, sheetAnalysis, selectedSheetName) => {\r\n    if (!extractedPdf || !extractedPdf.fileId || extractedPdf.processingMode === 'structured') {\r\n      return; // No PDF to reanalyze or already analyzed\r\n    }\r\n\r\n    console.log('🔄 Reanalyzing PDF with new sheet context...');\r\n    \r\n    setMessages(prev => [...prev, { \r\n      text: `🔄 מנתח מחדש את \"${extractedPdf.name}\" עם הקשר הגליון החדש...`, \r\n      sender: 'system', \r\n      timestamp: new Date(), \r\n      id: Date.now() \r\n    }]);\r\n\r\n    try {\r\n      // Create FormData for re-analysis\r\n      const formData = new FormData();\r\n      \r\n      // We need to fetch the PDF file again - check if it exists first\r\n      const pdfResponse = await fetch(`${API_URL}/api/download-pdf/${extractedPdf.fileId}`, {\r\n        credentials: 'include'\r\n      });\r\n      \r\n      if (!pdfResponse.ok) {\r\n        // PDF no longer exists on server - clean up state\r\n        console.log('❌ PDF file no longer exists on server, cleaning up...');\r\n        setExtractedPdf(null);\r\n        localStorage.removeItem('extractedPdf');\r\n        setMessages(prev => prev.filter(msg => !msg.text.includes(extractedPdf.name)));\r\n        return;\r\n      }\r\n      \r\n      const pdfBlob = await pdfResponse.blob();\r\n      formData.append('pdf', pdfBlob, extractedPdf.name);\r\n      \r\n      // Add sheet context data directly to FormData\r\n      console.log('🔄 Reanalyzing PDF with sheet context:', {\r\n        hasSheetData: !!sheetData,\r\n        sheetDataLength: sheetData ? sheetData.length : 0,\r\n        hasInstructions: !!sheetInstructions,\r\n        instructionsLength: sheetInstructions ? sheetInstructions.length : 0,\r\n        hasAnalysis: !!sheetAnalysis,\r\n        analysisLength: sheetAnalysis ? sheetAnalysis.length : 0,\r\n        sheetName: selectedSheetName\r\n      });\r\n      \r\n      if (sheetData) {\r\n        formData.append('sheetData', JSON.stringify(sheetData));\r\n      }\r\n      if (sheetInstructions) {\r\n        formData.append('sheetInstructions', sheetInstructions);\r\n      }\r\n      if (sheetAnalysis) {\r\n        formData.append('sheetAnalysis', sheetAnalysis);\r\n      }\r\n      if (selectedSheetName) {\r\n        formData.append('sheetName', selectedSheetName);\r\n      }\r\n      \r\n      const response = await fetch(`${API_URL}/api/extract-pdf-data`, {\r\n        method: 'POST', \r\n        body: formData,\r\n        credentials: 'include'\r\n      });\r\n      \r\n      if (!response.ok) {\r\n        throw new Error('Failed to reanalyze PDF');\r\n      }\r\n      \r\n      const result = await response.json();\r\n      \r\n      // Update PDF info with new analysis\r\n      const updatedPdfInfo = { \r\n        ...extractedPdf,\r\n        data: result,\r\n        processingMode: result.processingMode || 'structured',\r\n        isFullText: result.isFullText || false\r\n      };\r\n      \r\n      setExtractedPdf(updatedPdfInfo);\r\n      localStorage.setItem('extractedPdf', JSON.stringify(updatedPdfInfo));\r\n      \r\n      setMessages(prev => [...prev, { \r\n        text: `✅ \"${extractedPdf.name}\" נותח מחדש בהצלחה עם הקשר הגליון`, \r\n        sender: 'system', \r\n        timestamp: new Date(), \r\n        id: Date.now() \r\n      }]);\r\n      \r\n    } catch (error) {\r\n      console.error('Error reanalyzing PDF:', error);\r\n      setMessages(prev => [...prev, { \r\n        text: `❌ שגיאה בניתוח מחדש של \"${extractedPdf.name}\": ${error.message}`, \r\n        sender: 'system', \r\n        timestamp: new Date(), \r\n        id: Date.now() \r\n      }]);\r\n    }\r\n  };\r\n\r\n  const pickerCallback = (data) => {\r\n    if (data.action === window.google.picker.Action.PICKED) {\r\n      const doc = data.docs[0];\r\n      setFileName(doc.name);\r\n      handleGoogleSheetsUrl(doc.url);\r\n      setSnackbarMessage(`טען גיליון: ${doc.name}`);\r\n      setShowSnackbar(true);\r\n    }\r\n  };\r\n\r\n  const createPicker = () => {\r\n    const developerKey = process.env.REACT_APP_GEMINI_API_KEY;\r\n    const clientId = process.env.REACT_APP_GOOGLE_CLIENT_ID;\r\n    if (!clientId || !developerKey) {\r\n      setAuthError('מפתחות API אינם מוגדרים כראוי.');\r\n      setShowSnackbar(true);\r\n      return;\r\n    }\r\n    const view = new window.google.picker.View(window.google.picker.ViewId.SPREADSHEETS);\r\n    view.setMimeTypes(\"application/vnd.google-apps.spreadsheet\");\r\n    const picker = new window.google.picker.PickerBuilder()\r\n      .setAppId(clientId.split('-')[0])\r\n      .setOAuthToken(accessToken)\r\n      .setDeveloperKey(developerKey)\r\n      .addView(view)\r\n      .setCallback(pickerCallback)\r\n      .build();\r\n    picker.setVisible(true);\r\n  };\r\n\r\n  const getSheetData = async (spreadsheetId, sheetName = null) => {\r\n    if (!accessToken) return null;\r\n    try {\r\n      const range = sheetName ? `'${sheetName}'!A1:Z1000` : 'A1:Z1000';\r\n      \r\n      console.log('🔥 Fetching sheet data with values and formulas...');\r\n      \r\n      // 🔥 קריאה 1: שלוף ערכים מעוצבים\r\n      const valuesResponse = await makeGoogleSheetsAPICall(\r\n        spreadsheetId, \r\n        range, \r\n        null, \r\n        'GET',\r\n        'FORMATTED_VALUE'\r\n      );\r\n      \r\n      // 🔥 קריאה 2: שלוף נוסחאות  \r\n      const formulasResponse = await makeGoogleSheetsAPICall(\r\n        spreadsheetId, \r\n        range, \r\n        null, \r\n        'GET',\r\n        'FORMULA'\r\n      );\r\n      \r\n      console.log('📊 Values response:', valuesResponse.values?.length || 0, 'rows');\r\n      console.log('📋 Formulas response:', formulasResponse.values?.length || 0, 'rows');\r\n      \r\n      // 🔥 לוגים נוספים לבדיקה\r\n      if (valuesResponse.values?.length > 0) {\r\n        console.log('📊 Sample values row 0:', valuesResponse.values[0]);\r\n      }\r\n      if (formulasResponse.values?.length > 0) {\r\n        console.log('📋 Sample formulas row 0:', formulasResponse.values[0]);\r\n      }\r\n      \r\n      // 🔥 שלב את שניהם לאובייקט עשיר\r\n      const combinedData = combineValuesAndFormulas(\r\n        valuesResponse.values || [], \r\n        formulasResponse.values || []\r\n      );\r\n      \r\n      // 🔥 הצג הודעה למשתמש על השיפור\r\n      const formulaCount = combinedData.flat().filter(cell => cell.type === 'formula').length;\r\n      if (formulaCount > 0) {\r\n        console.log('🔥 Sample formula cells:', combinedData.flat().filter(cell => cell.type === 'formula').slice(0, 3));\r\n        setMessages(prev => [...prev, { \r\n          text: `✨ גיליון נטען עם ${formulaCount} נוסחאות - כעת ה-AI יכול לראות גם את הנוסחאות וגם את הערכים!`, \r\n          sender: 'system', \r\n          timestamp: new Date(), \r\n          id: Date.now() \r\n        }]);\r\n      } else {\r\n        setMessages(prev => [...prev, { \r\n          text: `📊 גיליון נטען בהצלחה - מכיל נתונים אבל לא נמצאו נוסחאות`, \r\n          sender: 'system', \r\n          timestamp: new Date(), \r\n          id: Date.now() \r\n        }]);\r\n      }\r\n      \r\n      return combinedData;\r\n      \r\n    } catch (error) {\r\n      console.error('Failed to fetch sheet data:', error);\r\n      console.error('Error details:', {\r\n        message: error.message,\r\n        stack: error.stack\r\n      });\r\n      setMessages(prev => [...prev, { text: `❌ שגיאה בטעינת גיליון: ${error.message}`, sender: 'system', timestamp: new Date(), id: Date.now() }]);\r\n      return null;\r\n    }\r\n  };\r\n\r\n  const startNewChat = () => {\r\n    setCurrentSessionId(null);\r\n    setMessages([{ text: 'שלום! אני העוזר החכם TLV500. התחבר לחשבון Google ובחר גיליון כדי להתחיל.', sender: 'assistant', timestamp: new Date(), id: Date.now() }]);\r\n    // אפס מצב Agent Mode אם אין גליון נבחר\r\n    if (!isSheetSelected) {\r\n      setIsAgentMode(false);\r\n    }\r\n    // אפס מצב Undo/Redo\r\n    setCanUndo(false);\r\n    setCanRedo(false);\r\n    setHasGreenCells(false);\r\n    setChangesCount(0);\r\n    setSheetAnalysis(null);\r\n    setSheetInstructions(null);\r\n  };\r\n\r\n\r\n  const handleLogout = async () => {\r\n    try {\r\n      // Call logout endpoint\r\n      await fetch(`${API_URL}/auth/logout`, {\r\n        credentials: 'include'\r\n      });\r\n      \r\n      // Clear local state\r\n      setAccessToken('');\r\n      setUser(null);\r\n      setCurrentSessionId(null);\r\n      setIsSheetSelected(false);\r\n      setIsAgentMode(false);\r\n      setCanUndo(false);\r\n      setCanRedo(false);\r\n      setHasGreenCells(false);\r\n      setChangesCount(0);\r\n      setSheetAnalysis(null);\r\n      setSheetInstructions(null);\r\n      localStorage.removeItem('accessToken');\r\n      \r\n      // Reset session ID for new session\r\n      setSessionId(Date.now().toString() + '_' + Math.random().toString(36).substring(2, 15));\r\n      \r\n      // Reset messages\r\n      setMessages([{ text: 'שלום! אני העוזר החכם TLV500. התחבר לחשבון Google ובחר גיליון כדי להתחיל.', sender: 'assistant', timestamp: new Date(), id: Date.now() }]);\r\n      \r\n      setSnackbarMessage('התנתקת בהצלחה!');\r\n      setShowSnackbar(true);\r\n    } catch (error) {\r\n      console.error('Error during logout:', error);\r\n    }\r\n  };\r\n\r\n  // 🔄 Undo/Redo Functions\r\n  const checkUndoRedoStatus = async () => {\r\n    if (!currentSessionId) return;\r\n    \r\n    try {\r\n      const response = await fetch(`${API_URL}/api/action/status/${currentSessionId}`, {\r\n        method: 'GET',\r\n        credentials: 'include'\r\n      });\r\n      \r\n      if (response.ok) {\r\n        const data = await response.json();\r\n        setCanUndo(data.canUndo);\r\n        setCanRedo(data.canRedo);\r\n      }\r\n    } catch (error) {\r\n      console.error('Error checking undo/redo status:', error);\r\n    }\r\n  };\r\n\r\n  // 🟢 Check for green cells\r\n  const checkForGreenCells = async () => {\r\n    if (!googleSheetsUrl || !selectedSheetName || !currentSessionId || isCheckingGreenCells) return;\r\n    \r\n    setIsCheckingGreenCells(true);\r\n    try {\r\n      // Simple check - if there are undo-able actions of type AI_ACTION that were recently executed\r\n      // we assume there might be green cells\r\n      const response = await fetch(`${API_URL}/api/action/status/${currentSessionId}`, {\r\n        credentials: 'include'\r\n      });\r\n      if (response.ok) {\r\n        const status = await response.json();\r\n        // For now, assume green cells exist if there are recent AI actions to undo\r\n        const hasChanges = status.canUndo;\r\n        // Debug: checkForGreenCells result\r\n        console.log('🟢 Full status from backend:', status);\r\n        console.log('🟢 hasGreenCells:', hasChanges, 'changesCount:', status.changesCount);\r\n        setHasGreenCells(hasChanges);\r\n        \r\n        // עדכון ספירת השינויים מהבקענד\r\n        setChangesCount(status.changesCount || 0);\r\n      }\r\n    } catch (error) {\r\n      console.error('Error checking for green cells:', error);\r\n      setHasGreenCells(false);\r\n      setChangesCount(0);\r\n    } finally {\r\n      setIsCheckingGreenCells(false);\r\n    }\r\n  };\r\n\r\n  // ✅ Approve All Changes\r\n  const approveAllChanges = async () => {\r\n    if (!googleSheetsUrl || !selectedSheetName || !currentSessionId) return;\r\n\r\n    try {\r\n      const spreadsheetId = googleSheetsUrl.match(/\\/spreadsheets\\/d\\/([a-zA-Z0-9-_]+)/)?.[1];\r\n      const sheetId = availableSheets.find(s => s.name === selectedSheetName)?.id || 0;\r\n\r\n      const response = await fetch(`${API_URL}/api/action/approve-all`, {\r\n        method: 'POST',\r\n        headers: {\r\n          'Content-Type': 'application/json',\r\n        },\r\n        credentials: 'include',\r\n        body: JSON.stringify({\r\n          spreadsheetId: spreadsheetId,\r\n          selectedSheetName: selectedSheetName,\r\n          sheetId: sheetId,\r\n          sessionId: currentSessionId\r\n        }),\r\n      });\r\n\r\n      if (response.ok) {\r\n        const result = await response.json();\r\n        setSnackbarMessage(result.message || '✅ כל השינויים אושרו');\r\n        setShowSnackbar(true);\r\n        \r\n        // Refresh status\r\n        await checkUndoRedoStatus();\r\n        await checkForGreenCells();\r\n        \r\n        // רענון חלק של הגליון\r\n        setTimeout(() => {\r\n          const iframe = document.querySelector('iframe[title=\"Google Sheets\"]');\r\n          if (iframe) {\r\n            iframe.src = iframe.src;\r\n          }\r\n        }, 500);\r\n      } else {\r\n        throw new Error('Failed to approve changes');\r\n      }\r\n    } catch (error) {\r\n      console.error('Error approving all changes:', error);\r\n      setSnackbarMessage('❌ שגיאה באישור השינויים');\r\n      setShowSnackbar(true);\r\n    }\r\n  };\r\n\r\n  // ❌ Reject All Changes\r\n  const rejectAllChanges = async () => {\r\n    if (!googleSheetsUrl || !selectedSheetName || !currentSessionId) return;\r\n\r\n    try {\r\n      const spreadsheetId = googleSheetsUrl.match(/\\/spreadsheets\\/d\\/([a-zA-Z0-9-_]+)/)?.[1];\r\n      const sheetId = availableSheets.find(s => s.name === selectedSheetName)?.id || 0;\r\n\r\n      const response = await fetch(`${API_URL}/api/action/reject-all`, {\r\n        method: 'POST',\r\n        headers: {\r\n          'Content-Type': 'application/json',\r\n        },\r\n        credentials: 'include',\r\n        body: JSON.stringify({\r\n          spreadsheetId: spreadsheetId,\r\n          selectedSheetName: selectedSheetName, \r\n          sheetId: sheetId,\r\n          sessionId: currentSessionId\r\n        }),\r\n      });\r\n\r\n      if (response.ok) {\r\n        const result = await response.json();\r\n        setSnackbarMessage(result.message || '❌ כל השינויים נדחו');\r\n        setShowSnackbar(true);\r\n        \r\n        // Refresh status\r\n        await checkUndoRedoStatus();\r\n        await checkForGreenCells();\r\n        \r\n        // רענון חלק של הגליון\r\n        setTimeout(() => {\r\n          const iframe = document.querySelector('iframe[title=\"Google Sheets\"]');\r\n          if (iframe) {\r\n            iframe.src = iframe.src;\r\n          }\r\n        }, 500);\r\n      } else {\r\n        throw new Error('Failed to reject changes');\r\n      }\r\n    } catch (error) {\r\n      console.error('Error rejecting all changes:', error);\r\n      setSnackbarMessage('❌ שגיאה בדחיית השינויים');\r\n      setShowSnackbar(true);\r\n    }\r\n  };\r\n\r\n  const undoAction = async () => {\r\n    if (!currentSessionId) return;\r\n    \r\n    try {\r\n      const response = await fetch(`${API_URL}/api/action/undo`, {\r\n        method: 'POST',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        credentials: 'include',\r\n        body: JSON.stringify({ sessionId: currentSessionId })\r\n      });\r\n      \r\n      if (response.ok) {\r\n        const data = await response.json();\r\n        setCanUndo(data.canUndo);\r\n        setCanRedo(data.canRedo);\r\n        setSnackbarMessage('↩️ ' + data.message);\r\n        setShowSnackbar(true);\r\n        \r\n        // עדכון כפתורי קבל/דחה\r\n        await checkForGreenCells();\r\n        \r\n        // רענון חלק של הגליון\r\n        if (googleSheetsUrl && selectedSheetName) {\r\n          setTimeout(() => {\r\n            const iframe = document.querySelector('iframe[title=\"Google Sheets\"]');\r\n            if (iframe) {\r\n              iframe.src = iframe.src;\r\n            }\r\n          }, 500); // השהיה קצרה לפני רענון\r\n        }\r\n      } else {\r\n        const error = await response.json();\r\n        setSnackbarMessage('❌ שגיאה בביטול: ' + error.error);\r\n        setShowSnackbar(true);\r\n      }\r\n    } catch (error) {\r\n      console.error('Error in undo action:', error);\r\n      setSnackbarMessage('❌ שגיאה בביטול הפעולה');\r\n      setShowSnackbar(true);\r\n    }\r\n  };\r\n\r\n  const redoAction = async () => {\r\n    if (!currentSessionId) return;\r\n    \r\n    try {\r\n      const response = await fetch(`${API_URL}/api/action/redo`, {\r\n        method: 'POST',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        credentials: 'include',\r\n        body: JSON.stringify({ sessionId: currentSessionId })\r\n      });\r\n      \r\n      if (response.ok) {\r\n        const data = await response.json();\r\n        setCanUndo(data.canUndo);\r\n        setCanRedo(data.canRedo);\r\n        setSnackbarMessage('⤴️ ' + data.message);\r\n        setShowSnackbar(true);\r\n        \r\n        // עדכון כפתורי קבל/דחה\r\n        await checkForGreenCells();\r\n        \r\n        // רענון חלק של הגליון\r\n        if (googleSheetsUrl && selectedSheetName) {\r\n          setTimeout(() => {\r\n            const iframe = document.querySelector('iframe[title=\"Google Sheets\"]');\r\n            if (iframe) {\r\n              iframe.src = iframe.src;\r\n            }\r\n          }, 500); // השהיה קצרה לפני רענון\r\n        }\r\n      } else {\r\n        const error = await response.json();\r\n        setSnackbarMessage('❌ שגיאה בשחזור: ' + error.error);\r\n        setShowSnackbar(true);\r\n      }\r\n    } catch (error) {\r\n      console.error('Error in redo action:', error);\r\n      setSnackbarMessage('❌ שגיאה בשחזור הפעולה');\r\n      setShowSnackbar(true);\r\n    }\r\n  };\r\n\r\n  const sendMessage = async () => {\r\n    if (!question.trim() || isStreamingResponse) return;\r\n\r\n    // 🛡️ בדיקה חדשה - אם יש גליון אבל לא נבחר גליון ספציפי\r\n    if (isSheetLoaded && !isSheetSelected) {\r\n      setMessages(prev => [...prev, { \r\n        text: '❌ יש לבחור גליון תחילה מהרשימה למעלה', \r\n        sender: 'system', \r\n        timestamp: new Date(), \r\n        id: Date.now() \r\n      }]);\r\n      return;\r\n    }\r\n\r\n    const currentQuestion = question;\r\n    const userMessage = { text: currentQuestion, sender: 'user', timestamp: new Date(), id: Date.now() };\r\n    setMessages(prev => [...prev, userMessage]);\r\n    setQuestion('');\r\n    setIsStreamingResponse(true);\r\n    \r\n    // Generate session ID if this is a new conversation\r\n    let sessionId = currentSessionId;\r\n    if (!sessionId) {\r\n      sessionId = generateSessionId();\r\n      setCurrentSessionId(sessionId);\r\n    }\r\n    \r\n    const loadingMessageId = Date.now() + 1;\r\n    setMessages(prev => [...prev, { text: '', sender: 'assistant', isLoading: true, timestamp: new Date(), id: loadingMessageId }]);\r\n\r\n    // User message will be saved automatically by backend in /api/chat-stream\r\n\r\n    try {\r\n        const sheetData = (isSheetLoaded && isSheetSelected) ? \r\n          await getSheetData(extractSpreadsheetId(googleSheetsUrl), selectedSheetName) : null;\r\n        \r\n        // We need to get the spreadsheetId here to send it\r\n        const spreadsheetId = isSheetLoaded ? extractSpreadsheetId(googleSheetsUrl) : null;\r\n\r\n        const payload = {\r\n          question: currentQuestion,\r\n          sheetData: sheetData,\r\n          extractedPdfData: extractedPdf ? extractedPdf.data : null,\r\n          extractedExcelData: extractedExcel ? extractedExcel.data : null,\r\n          isAgentMode: isAgentMode,\r\n          isSignificantChange: isSignificantChange,  // 🎚️ הוסף מצב שינוי משמעותי\r\n          conversationHistory: messages.filter(m => !m.isLoading).map(m => ({\r\n              role: m.sender === 'user' ? 'user' : 'model',\r\n              parts: [{ text: m.text }]\r\n          })),\r\n          spreadsheetId: spreadsheetId,\r\n          accessToken: accessToken,\r\n          sessionId: sessionId,  // Include session ID\r\n          sheetsMetadata: sheetsMetadata,       // ודא שהמשתנה הזה קיים ומכיל את המידע\r\n          selectedSheetName: selectedSheetName,  // ודא שהמשתנה הזה קיים ומכיל את שם הגיליון\r\n          sheetInstructions: sheetInstructions,   // 🔥 הוסף הוראות ניתוח\r\n          sheetAnalysis: sheetAnalysis           // 🔥 הוסף ניתוח הגליון\r\n        };\r\n\r\n        console.log('🔥 Sending payload with sheet instructions:', !!sheetInstructions);\r\n        if (sheetInstructions) {\r\n          console.log('📋 Sheet instructions preview:', sheetInstructions.substring(0, 200) + '...');\r\n        }\r\n        \r\n        const response = await fetch(`${API_URL}/api/chat-stream`, {\r\n            method: 'POST',\r\n            headers: { 'Content-Type': 'application/json' },\r\n            credentials: 'include', // This is crucial for session cookies!\r\n            body: JSON.stringify(payload),\r\n        });\r\n\r\n        if (!response.ok || !response.body) {\r\n            const errorText = await response.text();\r\n            throw new Error(`Server error: ${response.status} ${errorText}`);\r\n        }\r\n\r\n        const reader = response.body.getReader();\r\n        const decoder = new TextDecoder();\r\n        let accumulatedResponse = '';\r\n\r\n        while (true) {\r\n            const { value, done } = await reader.read();\r\n            if (done) break;\r\n            \r\n            accumulatedResponse += decoder.decode(value, { stream: true });\r\n\r\n            const currentResponse = accumulatedResponse;\r\n            setMessages(prev => prev.map(m => {\r\n                if (m.id === loadingMessageId) {\r\n                    // Show the accumulated response directly as text\r\n                    return { ...m, text: currentResponse, isLoading: true };\r\n                }\r\n                return m;\r\n            }));\r\n        }\r\n\r\n        // Final response processing - check if this is a change plan with clarification questions\r\n        const isChangePlanResponse = accumulatedResponse.includes('🤔 שאלות הבהרה') && accumulatedResponse.includes('מזהה תוכנית:');\r\n        \r\n        if (isChangePlanResponse) {\r\n          // Extract plan ID from response\r\n          const planIdMatch = accumulatedResponse.match(/מזהה תוכנית:\\s*`([^`]+)`/);\r\n          if (planIdMatch) {\r\n            const planId = planIdMatch[1];\r\n            setPendingChangePlan({\r\n              id: planId,\r\n              response: accumulatedResponse,\r\n              questions: extractQuestionsFromResponse(accumulatedResponse)\r\n            });\r\n            setIsAnsweringQuestions(true);\r\n            setClarificationAnswers(['', '', '', '', '']); // Reset answers\r\n          }\r\n        }\r\n        \r\n        setMessages(prev => prev.map(m =>\r\n            m.id === loadingMessageId\r\n            ? { ...m, text: accumulatedResponse, isLoading: false }\r\n            : m\r\n        ));\r\n\r\n        // Assistant response is automatically saved by backend in /api/chat-stream\r\n        \r\n                 // אם היה זה פקודת undo/redo, רענן את הגליון\r\n         const questionLower = currentQuestion.toLowerCase().trim();\r\n         const undoRedoKeywords = ['בטל', 'undo', 'שחזר', 'redo', 'בטל פעולה', 'שחזר פעולה'];\r\n         if (undoRedoKeywords.some(keyword => questionLower.includes(keyword))) {\r\n             // רענון חלק של הגליון\r\n             if (googleSheetsUrl && selectedSheetName) {\r\n                 setTimeout(() => {\r\n                     const iframe = document.querySelector('iframe[title=\"Google Sheets\"]');\r\n                     if (iframe) {\r\n                         iframe.src = iframe.src;\r\n                     }\r\n                 }, 800); // השהיה מעט יותר ארוכה עבור פקודות צ'אט\r\n             }\r\n         }\r\n\r\n    } catch (error) {\r\n        console.error('Error in sendMessage:', error);\r\n        setMessages(prev => prev.map(m => \r\n            m.id === loadingMessageId \r\n            ? { ...m, text: `אירעה שגיאה: ${error.message}`, isLoading: false, isError: true } \r\n            : m\r\n        ));\r\n    } finally {\r\n        setIsStreamingResponse(false);\r\n        // בדוק סטטוס Undo/Redo ותאים ירוקים אחרי כל הודעה\r\n        console.log('📋 Message completed, checking status...', { isAgentMode, currentSessionId });\r\n        setTimeout(() => {\r\n          console.log('⏰ Running status checks...');\r\n          checkUndoRedoStatus();\r\n          checkForGreenCells();\r\n        }, 1000); // השהיה קצרה כדי לוודא שהבק-אנד סיים\r\n    }\r\n  };\r\n\r\n  const saveAllChanges = () => {\r\n          setMessages(prev => [...prev, { text: `💾 כל השינויים נשמרו לגיליון ${fileName}`, sender: 'system', timestamp: new Date(), id: Date.now() }]);\r\n    };\r\n\r\n  return (\r\n    <ThemeProvider theme={theme}>\r\n      <CssBaseline />\r\n      \r\n\r\n      \r\n      <Box sx={{ display: 'flex', height: '100vh', bgcolor: 'background.default', overflow: 'hidden' }}>\r\n        <Box sx={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, background: `radial-gradient(circle at 20% 30%, rgba(139, 92, 246, 0.08) 0%, transparent 60%), radial-gradient(circle at 80% 70%, rgba(99, 102, 241, 0.06) 0%, transparent 60%)`, pointerEvents: 'none', zIndex: 0 }} />\r\n        {!isMobile && (\r\n          <Drawer variant=\"permanent\" sx={{ width: drawerWidth, flexShrink: 0, zIndex: 1, '& .MuiDrawer-paper': { width: drawerWidth, boxSizing: 'border-box', bgcolor: 'rgba(10, 10, 10, 0.98)', borderRight: '1px solid rgba(139, 92, 246, 0.4)', backdropFilter: 'blur(20px)' }}}>\r\n            <Box sx={{ p: 3 }}>\r\n              <Typography variant=\"h6\" sx={{ background: 'linear-gradient(135deg, #8B5CF6 0%, #6366F1 100%)', backgroundClip: 'text', WebkitBackgroundClip: 'text', WebkitTextFillColor: 'transparent', fontWeight: 700 }}>TLV500</Typography>\r\n              <Typography variant=\"body2\" color=\"text.secondary\">AI Assistant</Typography>\r\n            </Box>\r\n            <Divider sx={{ borderColor: 'rgba(139, 92, 246, 0.4)' }} />\r\n            <Box sx={{ p: 3 }}>\r\n              <Box sx={{ display: 'flex', alignItems: 'center', gap: 2, mb: 2 }}>\r\n                <Avatar\r\n                  src={user?.profilePicture}\r\n                  sx={{ width: 45, height: 45, background: 'linear-gradient(135deg, #8B5CF6 0%, #6366F1 100%)' }}\r\n                >\r\n                  {user?.name ? user.name.charAt(0) : <Person />}\r\n                </Avatar>\r\n                <Box sx={{ flex: 1 }}>\r\n                  <Typography variant=\"body2\" fontWeight={600}>\r\n                    {user?.name || 'משתמש אורח'}\r\n                  </Typography>\r\n                  <Typography variant=\"caption\" color=\"text.secondary\">\r\n                    {user?.email || 'לא מחובר'}\r\n                  </Typography>\r\n                </Box>\r\n              </Box>\r\n              {accessToken && (\r\n                <Button\r\n                  variant=\"outlined\"\r\n                  onClick={handleLogout}\r\n                  size=\"small\"\r\n                  fullWidth\r\n                  sx={{\r\n                    borderColor: 'rgba(239, 68, 68, 0.5)',\r\n                    color: 'error.main',\r\n                    '&:hover': {\r\n                      borderColor: 'error.main',\r\n                      bgcolor: 'rgba(239, 68, 68, 0.1)'\r\n                    }\r\n                  }}\r\n                >\r\n                  התנתק\r\n                </Button>\r\n              )}\r\n            </Box>\r\n            <Divider sx={{ borderColor: 'rgba(139, 92, 246, 0.4)' }} />\r\n            \r\n            {/* Chat History */}\r\n            <Box sx={{ flexGrow: 1, overflow: 'hidden' }}>\r\n              <ChatHistory\r\n                accessToken={accessToken}\r\n                onSessionSelect={handleSessionSelect}\r\n                currentSessionId={currentSessionId}\r\n              />\r\n            </Box>\r\n          </Drawer>\r\n        )}\r\n        <Box sx={{ flexGrow: 1, display: 'flex', flexDirection: isMobile ? 'column' : 'row', zIndex: 1, height: '100vh', overflow: 'hidden' }}>\r\n          <Box sx={{ flex: isMobile ? '1 1 60%' : '0 0 65%', p: 2, display: 'flex', flexDirection: 'column', height: '100%', overflow: 'hidden' }}>\r\n            <Box sx={{ mb: 2, display: 'flex', justifyContent: 'space-between', alignItems: 'center', flexWrap: 'wrap', gap: 2 }}>\r\n              <Box sx={{ display: 'flex', alignItems: 'center', gap: 2 }}>\r\n                <Typography variant=\"h6\" fontWeight={600} color=\"text.primary\">{fileName || 'לא נבחר גיליון'}</Typography>\r\n                {availableSheets.length > 0 && (\r\n                  <FormControl \r\n                    size=\"small\" \r\n                    sx={{ \r\n                      minWidth: 200,\r\n                      '& .MuiOutlinedInput-notchedOutline': { \r\n                        borderColor: !isSheetSelected ? 'rgba(239, 68, 68, 0.7)' : 'rgba(139, 92, 246, 0.5)' \r\n                      },\r\n                      '& .MuiInputLabel-root': {\r\n                        color: !isSheetSelected ? 'error.main' : 'text.secondary'\r\n                      }\r\n                    }}\r\n                    error={!isSheetSelected}\r\n                  >\r\n                    <InputLabel>\r\n                      {!isSheetSelected ? '🔴 בחר גליון (חובה)' : 'גליון נוכחי'}\r\n                    </InputLabel>\r\n                    <Select \r\n                      value={selectedSheetName || ''} \r\n                      onChange={(e) => handleSheetChange(e.target.value)} \r\n                      disabled={isLoadingSheets}\r\n                    >\r\n                      {availableSheets.map(sheet => (\r\n                        <MenuItem key={sheet.id} value={sheet.name}>\r\n                          {sheet.name}\r\n                        </MenuItem>\r\n                      ))}\r\n                    </Select>\r\n                  </FormControl>\r\n                )}\r\n                {isLoadingSheets && <CircularProgress size={20} sx={{ color: 'primary.main' }} />}\r\n              </Box>\r\n              <Box sx={{ display: 'flex', gap: 1 }}>\r\n                {!accessToken ? (\r\n                  <Button variant=\"contained\" href={API_URL}>התחבר עם Google</Button>\r\n                ) : (\r\n                  <Button variant=\"outlined\" onClick={createPicker} disabled={!isPickerReady}>\r\n                    {!isPickerReady ? 'טוען API...' : 'בחר גיליון מ-Drive'}\r\n                  </Button>\r\n                )}\r\n                {accessToken && (\r\n                  <Button variant=\"outlined\" onClick={startNewChat} sx={{ minWidth: 'auto' }}>\r\n                    + שיחה חדשה\r\n                  </Button>\r\n                )}\r\n              </Box>\r\n              {changesCount > 0 && <Chip label={`${changesCount} שינויים לא שמורים`} size=\"small\" color=\"warning\" />}\r\n              <Button variant=\"contained\" startIcon={<Save />} onClick={saveAllChanges} color=\"primary\" size=\"small\">שמור הכל</Button>\r\n            </Box>\r\n            <Paper sx={{ flexGrow: 1, display: 'flex', flexDirection: 'column', overflow: 'hidden', background: 'rgba(15, 15, 15, 0.98)', border: '1px solid rgba(139, 92, 246, 0.25)', position: 'relative' }}>\r\n              \r\n\r\n\r\n              {/* שדה קישור - רק כשאין גליון */}\r\n              {!isSheetLoaded && (\r\n                <Box sx={{ p: 1, textAlign: 'center', mt: 2 }}>\r\n                  <TextField \r\n                    placeholder=\"הכנס קישור לגוגל שיטס...\" \r\n                    size=\"small\" \r\n                    sx={{ minWidth: 400 }} \r\n                    onKeyPress={async (e) => { \r\n                      if (e.key === 'Enter' && e.target.value) { \r\n                        await handleGoogleSheetsUrl(e.target.value); \r\n                        e.target.value = ''; \r\n                      } \r\n                    }} \r\n                  />\r\n                </Box>\r\n              )}\r\n              \r\n              {/* כפתורי קבל/דחה מרובעים צמודים למסגרת מבחוץ */}\r\n\r\n              \r\n\r\n              <Box \r\n                ref={iframeContainerRef} \r\n                sx={{ \r\n                  flexGrow: 1, \r\n                  border: '1px solid rgba(139, 92, 246, 0.4)', \r\n                  borderRadius: 1, \r\n                  bgcolor: 'rgba(5, 5, 5, 0.8)', \r\n                  position: 'relative', \r\n                  overflow: 'hidden',\r\n                  m: 0.5, // רווח מינימלי מהקצוות\r\n                  // הגנה על Mac gestures\r\n                  overscrollBehavior: 'contain',\r\n                  touchAction: 'auto',\r\n                  WebkitOverflowScrolling: 'touch'\r\n                }} \r\n                onMouseEnter={() => setIsIframeHovered(true)} \r\n                onMouseLeave={() => setIsIframeHovered(false)}\r\n              >\r\n                {/* כפתורי קבל/דחה צמודים לצד ימין של הקונטיינר */}\r\n                {isSheetLoaded && isSheetSelected && (hasGreenCells || changesCount > 0) && (\r\n                  <div style={{ \r\n                    position: 'absolute',\r\n                    top: '8px',\r\n                    right: '8px',\r\n                    display: 'flex', \r\n                    gap: '0px',\r\n                    zIndex: 1000,\r\n                    backgroundColor: 'rgba(0, 0, 0, 0.8)',\r\n                    border: '1px solid rgba(255, 255, 255, 0.3)',\r\n                    borderRadius: '4px',\r\n                    padding: '2px'\r\n                  }}>\r\n                    {/* כפתור קבל */}\r\n                    <div\r\n                      onClick={() => {\r\n                        approveAllChanges();\r\n                      }}\r\n                      style={{\r\n                        backgroundColor: '#4caf50',\r\n                        color: 'white',\r\n                        border: '1px solid #2e7d32',\r\n                        width: '45px',\r\n                        height: '20px',\r\n                        fontSize: '0.65rem',\r\n                        fontWeight: 'bold',\r\n                        borderRadius: '0px',\r\n                        cursor: 'pointer',\r\n                        display: 'flex',\r\n                        alignItems: 'center',\r\n                        justifyContent: 'center',\r\n                        userSelect: 'none',\r\n                        transition: 'all 0.2s ease',\r\n                        boxShadow: '0 2px 4px rgba(0,0,0,0.2)'\r\n                      }}\r\n                      title=\"אשר כל השינויים\"\r\n                      onMouseEnter={(e) => {\r\n                        e.target.style.backgroundColor = '#45a049';\r\n                        e.target.style.transform = 'scale(1.05)';\r\n                        e.target.style.boxShadow = '0 4px 8px rgba(76, 175, 80, 0.4)';\r\n                        e.target.style.borderColor = '#4caf50';\r\n                        e.target.textContent = 'קבל הכל';\r\n                        e.target.style.fontSize = '0.6rem';\r\n                      }}\r\n                      onMouseLeave={(e) => {\r\n                        e.target.style.backgroundColor = '#4caf50';\r\n                        e.target.style.transform = 'scale(1)';\r\n                        e.target.style.boxShadow = '0 2px 4px rgba(0,0,0,0.2)';\r\n                        e.target.style.borderColor = '#2e7d32';\r\n                        e.target.textContent = `✓ (${changesCount || 0})`;\r\n                        e.target.style.fontSize = '0.65rem';\r\n                      }}\r\n                    >\r\n                      ✓ ({changesCount || 0})\r\n                    </div>\r\n\r\n                    {/* כפתור דחה */}\r\n                    <div\r\n                      onClick={() => {\r\n                        rejectAllChanges();\r\n                      }}\r\n                      style={{\r\n                        backgroundColor: '#f44336',\r\n                        color: 'white',\r\n                        border: '1px solid #c62828',\r\n                        width: '45px',\r\n                        height: '20px',\r\n                        fontSize: '0.65rem',\r\n                        fontWeight: 'bold',\r\n                        borderRadius: '0px',\r\n                        cursor: 'pointer',\r\n                        display: 'flex',\r\n                        alignItems: 'center',\r\n                        justifyContent: 'center',\r\n                        userSelect: 'none',\r\n                        transition: 'all 0.2s ease',\r\n                        boxShadow: '0 2px 4px rgba(0,0,0,0.2)'\r\n                      }}\r\n                      title=\"דחה כל השינויים\"\r\n                      onMouseEnter={(e) => {\r\n                        e.target.style.backgroundColor = '#d32f2f';\r\n                        e.target.style.transform = 'scale(1.05)';\r\n                        e.target.style.boxShadow = '0 4px 8px rgba(244, 67, 54, 0.4)';\r\n                        e.target.style.borderColor = '#f44336';\r\n                        e.target.textContent = 'דחה הכל';\r\n                        e.target.style.fontSize = '0.6rem';\r\n                      }}\r\n                      onMouseLeave={(e) => {\r\n                        e.target.style.backgroundColor = '#f44336';\r\n                        e.target.style.transform = 'scale(1)';\r\n                        e.target.style.boxShadow = '0 2px 4px rgba(0,0,0,0.2)';\r\n                        e.target.style.borderColor = '#c62828';\r\n                        e.target.textContent = `✕ (${changesCount || 0})`;\r\n                        e.target.style.fontSize = '0.65rem';\r\n                      }}\r\n                    >\r\n                      ✕ ({changesCount || 0})\r\n                    </div>\r\n                  </div>\r\n                )}\r\n\r\n                {/* כפתורי Undo/Redo בצד ימין תחתון */}\r\n                {isSheetLoaded && isSheetSelected && (canUndo || canRedo) && (\r\n                  <div style={{ \r\n                    position: 'absolute',\r\n                    bottom: '8px',\r\n                    right: '8px',\r\n                    display: 'flex', \r\n                    gap: '0px',\r\n                    zIndex: 1000,\r\n                    backgroundColor: 'rgba(0, 0, 0, 0.8)',\r\n                    border: '1px solid rgba(255, 255, 255, 0.3)',\r\n                    borderRadius: '4px',\r\n                    padding: '2px'\r\n                  }}>\r\n                    {/* כפתור Undo */}\r\n                    <div\r\n                      onClick={() => {\r\n                        if (canUndo) undoAction();\r\n                      }}\r\n                      style={{\r\n                        backgroundColor: canUndo ? '#2196f3' : '#666',\r\n                        color: 'white',\r\n                        border: `1px solid ${canUndo ? '#1976d2' : '#555'}`,\r\n                        width: '45px',\r\n                        height: '20px',\r\n                        fontSize: '0.65rem',\r\n                        fontWeight: 'bold',\r\n                        borderRadius: '0px',\r\n                        cursor: canUndo ? 'pointer' : 'not-allowed',\r\n                        display: 'flex',\r\n                        alignItems: 'center',\r\n                        justifyContent: 'center',\r\n                        userSelect: 'none',\r\n                        transition: 'all 0.2s ease',\r\n                        boxShadow: '0 2px 4px rgba(0,0,0,0.2)',\r\n                        opacity: canUndo ? 1 : 0.5\r\n                      }}\r\n                      title=\"בטל פעולה\"\r\n                      onMouseEnter={(e) => {\r\n                        if (canUndo) {\r\n                          e.target.style.backgroundColor = '#1976d2';\r\n                          e.target.style.transform = 'scale(1.05)';\r\n                          e.target.style.boxShadow = '0 4px 8px rgba(33, 150, 243, 0.4)';\r\n                          e.target.style.borderColor = '#2196f3';\r\n                          e.target.textContent = 'בטל';\r\n                          e.target.style.fontSize = '0.6rem';\r\n                        }\r\n                      }}\r\n                      onMouseLeave={(e) => {\r\n                        if (canUndo) {\r\n                          e.target.style.backgroundColor = '#2196f3';\r\n                          e.target.style.transform = 'scale(1)';\r\n                          e.target.style.boxShadow = '0 2px 4px rgba(0,0,0,0.2)';\r\n                          e.target.style.borderColor = '#1976d2';\r\n                          e.target.textContent = '↩️';\r\n                          e.target.style.fontSize = '0.65rem';\r\n                        }\r\n                      }}\r\n                    >\r\n                      ↩️\r\n                    </div>\r\n\r\n                    {/* כפתור Redo */}\r\n                    <div\r\n                      onClick={() => {\r\n                        if (canRedo) redoAction();\r\n                      }}\r\n                      style={{\r\n                        backgroundColor: canRedo ? '#ff9800' : '#666',\r\n                        color: 'white',\r\n                        border: `1px solid ${canRedo ? '#f57c00' : '#555'}`,\r\n                        width: '45px',\r\n                        height: '20px',\r\n                        fontSize: '0.65rem',\r\n                        fontWeight: 'bold',\r\n                        borderRadius: '0px',\r\n                        cursor: canRedo ? 'pointer' : 'not-allowed',\r\n                        display: 'flex',\r\n                        alignItems: 'center',\r\n                        justifyContent: 'center',\r\n                        userSelect: 'none',\r\n                        transition: 'all 0.2s ease',\r\n                        boxShadow: '0 2px 4px rgba(0,0,0,0.2)',\r\n                        opacity: canRedo ? 1 : 0.5\r\n                      }}\r\n                      title=\"שחזר פעולה\"\r\n                      onMouseEnter={(e) => {\r\n                        if (canRedo) {\r\n                          e.target.style.backgroundColor = '#f57c00';\r\n                          e.target.style.transform = 'scale(1.05)';\r\n                          e.target.style.boxShadow = '0 4px 8px rgba(255, 152, 0, 0.4)';\r\n                          e.target.style.borderColor = '#ff9800';\r\n                          e.target.textContent = 'שחזר';\r\n                          e.target.style.fontSize = '0.6rem';\r\n                        }\r\n                      }}\r\n                      onMouseLeave={(e) => {\r\n                        if (canRedo) {\r\n                          e.target.style.backgroundColor = '#ff9800';\r\n                          e.target.style.transform = 'scale(1)';\r\n                          e.target.style.boxShadow = '0 2px 4px rgba(0,0,0,0.2)';\r\n                          e.target.style.borderColor = '#f57c00';\r\n                          e.target.textContent = '⤴️';\r\n                          e.target.style.fontSize = '0.65rem';\r\n                        }\r\n                      }}\r\n                    >\r\n                      ⤴️\r\n                    </div>\r\n                  </div>\r\n                )}\r\n\r\n                {isSheetLoaded && isSheetSelected ? (\r\n                  <iframe src={getSheetUrlWithGid(googleSheetsUrl, selectedSheetName)} width=\"100%\" height=\"100%\" style={{ border: 'none', borderRadius: '4px' }} title=\"Google Sheets\" />\r\n                ) : availableSheets.length > 0 && !isSheetSelected ? (\r\n                  <Box sx={{ display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center', height: '100%', color: 'text.secondary' }}>\r\n                    <TableChart sx={{ fontSize: 60, mb: 2, opacity: 0.5, color: 'error.main' }} />\r\n                    <Typography variant=\"h6\" gutterBottom color=\"error.main\">\r\n                      יש לבחור גליון תחילה\r\n                    </Typography>\r\n                    <Typography variant=\"body2\" textAlign=\"center\" sx={{ maxWidth: 400 }}>\r\n                      בחר גליון מהרשימה למעלה כדי להתחיל לעבוד\r\n                    </Typography>\r\n                  </Box>\r\n                ) : (\r\n                  <Box sx={{ display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center', height: '100%', color: 'text.secondary' }}>\r\n                    <TableChart sx={{ fontSize: 60, mb: 2, opacity: 0.5 }} />\r\n                    <Typography variant=\"h6\" gutterBottom>טען גיליון גוגל שיטס</Typography>\r\n                    <Typography variant=\"body2\" textAlign=\"center\" sx={{ maxWidth: 400 }}>הכנס קישור לגוגל שיטס בשדה למעלה</Typography>\r\n                  </Box>\r\n                )}\r\n              </Box>\r\n            </Paper>\r\n          </Box>\r\n          <Box sx={{ width: isMobile ? '100%' : '35%', flex: isMobile ? '1 1 40%' : '0 0 35%', p: 2, height: '100%', display: 'flex', flexDirection: 'column' }}>\r\n            <Paper sx={{ flexGrow: 1, display: 'flex', flexDirection: 'column', overflow: 'hidden', background: 'rgba(25, 25, 25, 0.98)', border: '1px solid rgba(139, 92, 246, 0.25)' }}>\r\n              <Box sx={{ p: 2, borderBottom: '1px solid rgba(139, 92, 246, 0.4)' }}>\r\n                <Typography variant=\"h6\" fontWeight={600}>עוזר AI</Typography>\r\n                <Typography variant=\"body2\" color=\"text.secondary\">מוכן לעזור עם הניתוח שלך</Typography>\r\n              </Box>\r\n              <Box sx={{ p: 2, borderBottom: '1px solid rgba(139, 92, 246, 0.4)' }}>\r\n                <Box sx={{ display: 'flex', flexDirection: 'column', gap: 2 }}>\r\n                  <Box sx={{ display: 'flex', gap: 1 }}>\r\n                    <Button variant=\"outlined\" component=\"label\" startIcon={<Description />} size=\"small\" disabled={isExtractingData} sx={{ flex: 1, borderColor: 'rgba(139, 92, 246, 0.5)', '&.Mui-disabled': { color: 'text.secondary' } }}>\r\n                      {isExtractingData ? 'מעבד...' : 'PDF'}\r\n                      <input type=\"file\" hidden accept=\".pdf\" onChange={(e) => handleFileUpload(e, 'PDF')} disabled={isExtractingData} />\r\n                    </Button>\r\n                    <Button variant=\"outlined\" component=\"label\" startIcon={<TableChart />} size=\"small\" disabled={isExtractingExcel} sx={{ flex: 1, borderColor: 'rgba(139, 92, 246, 0.5)' }}>\r\n                      {isExtractingExcel ? 'מעבד...' : 'Excel'}\r\n                      <input type=\"file\" hidden accept=\".xlsx,.xls,.csv\" onChange={(e) => handleFileUpload(e, 'Excel')} disabled={isExtractingExcel}/>\r\n                    </Button>\r\n                  </Box>\r\n                  {extractedPdf && (\r\n                    <Box sx={{ \r\n                      display: 'flex', \r\n                      alignItems: 'center', \r\n                      gap: 1, \r\n                      mt: 1, \r\n                      p: 1, \r\n                      bgcolor: extractedPdf.processingMode === 'simple_ocr' ? 'rgba(255, 193, 7, 0.1)' : 'rgba(139, 92, 246, 0.1)', \r\n                      borderRadius: 2, \r\n                      border: extractedPdf.processingMode === 'simple_ocr' ? '1px solid rgba(255, 193, 7, 0.3)' : '1px solid rgba(139, 92, 246, 0.3)'\r\n                    }}>\r\n                      <Description sx={{ \r\n                        color: extractedPdf.processingMode === 'simple_ocr' ? 'warning.main' : 'primary.main', \r\n                        fontSize: 20 \r\n                      }} />\r\n                      <Typography variant=\"body2\" sx={{ \r\n                        flex: 1, \r\n                        whiteSpace: 'nowrap', \r\n                        overflow: 'hidden', \r\n                        textOverflow: 'ellipsis' \r\n                      }}>\r\n                        {extractedPdf.name}\r\n                        {extractedPdf.processingMode === 'simple_ocr' && ' 📑'}\r\n                        {extractedPdf.processingMode === 'structured' && ' 🔍'}\r\n                      </Typography>\r\n                      <Button \r\n                        size=\"small\" \r\n                        onClick={() => { \r\n                          setExtractedPdf(null); \r\n                          localStorage.removeItem('extractedPdf'); \r\n                          setMessages(prev => [...prev, { \r\n                            text: '📄 נתוני ה-PDF נוקו מההקשר.', \r\n                            sender: 'system', \r\n                            timestamp: new Date(), \r\n                            id: Date.now() \r\n                          }]); \r\n                        }} \r\n                        sx={{ color: 'error.main', minWidth: 'auto', p: 0.5 }}\r\n                      >\r\n                        ✕\r\n                      </Button>\r\n                    </Box>\r\n                  )}\r\n                  {extractedExcel && (\r\n                    <Box sx={{ display: 'flex', alignItems: 'center', gap: 1, mt: 1, p: 1, bgcolor: 'rgba(16, 185, 129, 0.1)', borderRadius: 2, border: '1px solid rgba(16, 185, 129, 0.3)' }}>\r\n                        <TableChart sx={{ color: 'success.main', fontSize: 20 }} />\r\n                        <Typography variant=\"body2\" sx={{ flex: 1, whiteSpace: 'nowrap', overflow: 'hidden', textOverflow: 'ellipsis' }}>{extractedExcel.name}</Typography>\r\n                        <Button size=\"small\" onClick={() => { setExtractedExcel(null); localStorage.removeItem('extractedExcel'); setMessages(prev => [...prev, { text: '📊 נתוני ה-Excel נוקו מההקשר.', sender: 'system', timestamp: new Date(), id: Date.now() }]); }} sx={{ color: 'error.main', minWidth: 'auto', p: 0.5 }}>✕</Button>\r\n                    </Box>\r\n                  )}\r\n                </Box>\r\n              </Box>\r\n              <Box sx={{ flexGrow: 1, overflow: 'auto', p: 2 }}>\r\n                {messages.map((msg, index) => (\r\n                  <Box key={msg.id || index} sx={{ mb: 2 }} className=\"chat-message\">\r\n                    <Box sx={{ display: 'flex', justifyContent: msg.sender === 'user' ? 'flex-end' : 'flex-start', mb: 1 }}>\r\n                      <Paper sx={{ \r\n                        p: 1.5, \r\n                        maxWidth: '85%', \r\n                        background: msg.sender === 'user' ? 'linear-gradient(135deg, #8B5CF6 0%, #6366F1 100%)' : 'rgba(35, 35, 35, 0.9)', \r\n                        color: 'white', \r\n                        borderRadius: 3\r\n                      }}>\r\n                        {msg.isLoading ? <CircularProgress size={16} color=\"inherit\" /> :\r\n                          <Typography\r\n                            variant=\"body2\"\r\n                            className=\"chat-message-text\"\r\n                            sx={{ whiteSpace: 'pre-wrap' }}\r\n                            dangerouslySetInnerHTML={{\r\n                              __html: formatMixedText(msg.text)\r\n                            }}\r\n                          />\r\n                        }\r\n                      </Paper>\r\n                    </Box>\r\n                    <Typography variant=\"caption\" color=\"text.secondary\" sx={{ display: 'block', textAlign: msg.sender === 'user' ? 'right' : 'left', px: 1 }}>\r\n                      {msg.timestamp.toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit' })}\r\n                    </Typography>\r\n                  </Box>\r\n                ))}\r\n                <div ref={chatEndRef} />\r\n              </Box>\r\n              \r\n              {/* Clarification Questions UI */}\r\n              {isAnsweringQuestions && pendingChangePlan && (\r\n                <Box sx={{ p: 2, borderTop: '1px solid rgba(139, 92, 246, 0.4)', backgroundColor: 'rgba(139, 92, 246, 0.1)' }}>\r\n                  <Typography variant=\"h6\" sx={{ mb: 2, color: '#8b5cf6' }}>\r\n                    🤔 שאלות הבהרה לביצוע התוכנית\r\n                  </Typography>\r\n                  <Typography variant=\"body2\" sx={{ mb: 2, color: 'text.secondary' }}>\r\n                    אנא ענה על כל 5 השאלות לביצוע מדויק של השינויים:\r\n                  </Typography>\r\n                  \r\n                  {pendingChangePlan.questions.map((question, index) => (\r\n                    <Box key={index} sx={{ mb: 2 }}>\r\n                      <Typography variant=\"body2\" sx={{ mb: 1, fontWeight: 'bold' }}>\r\n                        {index + 1}. {question}\r\n                      </Typography>\r\n                      <TextField\r\n                        fullWidth\r\n                        multiline\r\n                        rows={2}\r\n                        value={clarificationAnswers[index]}\r\n                        onChange={(e) => {\r\n                          const newAnswers = [...clarificationAnswers];\r\n                          newAnswers[index] = e.target.value;\r\n                          setClarificationAnswers(newAnswers);\r\n                        }}\r\n                        placeholder=\"הכנס תשובה...\"\r\n                        variant=\"outlined\"\r\n                        size=\"small\"\r\n                        sx={{\r\n                          '& .MuiOutlinedInput-root': {\r\n                            backgroundColor: 'rgba(255, 255, 255, 0.05)',\r\n                            '& fieldset': {\r\n                              borderColor: 'rgba(139, 92, 246, 0.3)',\r\n                            },\r\n                            '& textarea': {\r\n                              textAlign: 'right',\r\n                              direction: 'rtl',\r\n                            },\r\n                          },\r\n                        }}\r\n                      />\r\n                    </Box>\r\n                  ))}\r\n                  \r\n                  <Box sx={{ display: 'flex', gap: 1, mt: 2 }}>\r\n                    <Button\r\n                      variant=\"contained\"\r\n                      onClick={executeChangePlan}\r\n                      disabled={isStreamingResponse || clarificationAnswers.some(answer => !answer.trim())}\r\n                      sx={{ \r\n                        bgcolor: '#8b5cf6',\r\n                        '&:hover': { bgcolor: '#7c3aed' },\r\n                        flex: 1\r\n                      }}\r\n                    >\r\n                      {isStreamingResponse ? 'מבצע...' : 'בצע תוכנית'}\r\n                    </Button>\r\n                    <Button\r\n                      variant=\"outlined\"\r\n                      onClick={() => {\r\n                        setIsAnsweringQuestions(false);\r\n                        setPendingChangePlan(null);\r\n                        setClarificationAnswers(['', '', '', '', '']);\r\n                      }}\r\n                      disabled={isStreamingResponse}\r\n                      sx={{ borderColor: 'rgba(139, 92, 246, 0.5)' }}\r\n                    >\r\n                      ביטול\r\n                    </Button>\r\n                  </Box>\r\n                </Box>\r\n              )}\r\n\r\n              <Box sx={{ p: 2, borderTop: '1px solid rgba(139, 92, 246, 0.4)' }}>\r\n                {/* 🎚️ כפתור בחירת מצב שינוי משמעותי */}\r\n                {isAgentMode && isSheetLoaded && isSheetSelected && (\r\n                  <Box sx={{ mb: 1, display: 'flex', alignItems: 'center', gap: 1 }}>\r\n                    <Switch \r\n                      checked={isSignificantChange}\r\n                      onChange={(e) => setIsSignificantChange(e.target.checked)}\r\n                      sx={{\r\n                        '& .MuiSwitch-switchBase.Mui-checked': {\r\n                          color: '#8B5CF6',\r\n                        },\r\n                        '& .MuiSwitch-switchBase.Mui-checked + .MuiSwitch-track': {\r\n                          backgroundColor: '#8B5CF6',\r\n                        },\r\n                      }}\r\n                    />\r\n                    <Typography variant=\"body2\" sx={{ color: isSignificantChange ? '#8B5CF6' : '#666' }}>\r\n                      {isSignificantChange ? '🤔 שינוי משמעותי (עם הבהרות)' : '⚡ שינוי רגיל (מיידי)'}\r\n                    </Typography>\r\n                  </Box>\r\n                )}\r\n                \r\n                <Box sx={{ display: 'flex', gap: 1 }}>\r\n                  <TextField\r\n                    fullWidth\r\n                    variant=\"outlined\"\r\n                    placeholder={isAnsweringQuestions ? \"ענה על השאלות למעלה תחילה...\" : \"שאל אותי כל דבר... (Shift+Enter לשורה חדשה)\"}\r\n                    value={question}\r\n                    onChange={(e) => setQuestion(e.target.value)}\r\n                    onKeyPress={(e) => {\r\n                      if (e.key === 'Enter' && !e.shiftKey) {\r\n                        e.preventDefault(); // Prevents adding a new line\r\n                        sendMessage();\r\n                      }\r\n                    }}\r\n                    multiline\r\n                    minRows={2}\r\n                    maxRows={5}\r\n                    disabled={isStreamingResponse || isAnsweringQuestions}\r\n                    className=\"hebrew-input\"\r\n                    sx={{\r\n                      '& .MuiOutlinedInput-root': {\r\n                        borderRadius: 3,\r\n                      }\r\n                    }}\r\n                  />\r\n                  <Fab \r\n                    color=\"primary\" \r\n                    onClick={sendMessage} \r\n                    size=\"small\"\r\n                    disabled={isStreamingResponse || isAnsweringQuestions}\r\n                  >\r\n                    <Send />\r\n                  </Fab>\r\n                </Box>\r\n                <FormControlLabel\r\n                  control={\r\n                    <Switch\r\n                      checked={isAgentMode}\r\n                      onChange={(e) => setIsAgentMode(e.target.checked)}\r\n                      disabled={!googleSheetsUrl || !isSheetSelected}\r\n                    />\r\n                  }\r\n                  label={`Agent Mode: Allow Sheet Editing ${!isSheetSelected ? '(בחר גליון תחילה)' : ''}`}\r\n                  sx={{ \r\n                    color: (!googleSheetsUrl || !isSheetSelected) ? 'text.disabled' : 'text.secondary', \r\n                    mt: 1, \r\n                    mr: 0 \r\n                  }}\r\n                />\r\n              </Box>\r\n            </Paper>\r\n          </Box>\r\n        </Box>\r\n        <Snackbar open={showSnackbar} autoHideDuration={6000} onClose={() => setShowSnackbar(false)} anchorOrigin={{ vertical: 'bottom', horizontal: 'center' }} sx={{ bottom: { xs: 90, sm: 24 } }}>\r\n          <Alert onClose={() => setShowSnackbar(false)} severity={authError ? \"error\" : \"success\"} sx={{ width: '100%', bgcolor: '#2E2E2E', color: 'white' }}>\r\n            {snackbarMessage || authError}\r\n          </Alert>\r\n        </Snackbar>\r\n      </Box>\r\n    </ThemeProvider>\r\n  );\r\n}\r\n\r\nexport default App;\r\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}